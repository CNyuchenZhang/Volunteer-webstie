name: üöÄ Volunteer Platform CI/CD

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main" ]

jobs:
  # ‰ª£Á†Å‰∏é‰æùËµñÂÆâÂÖ®Êâ´ÊèèÔºàPRÔºâ
  sast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ Git ÂéÜÂè≤ÔºåGitleaks ÈúÄË¶ÅÊâ´Êèè PR ÂèòÊõ¥

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Gitleaks (secrets)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: detect --source . --verbose --report-format sarif --report-path gitleaks.sarif

      - name: Install SAST tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit semgrep pip-audit

      - name: Bandit (Python SAST)
        run: bandit -r services -f sarif -o bandit.sarif || true

      - name: Semgrep (generic SAST)
        run: semgrep ci --sarif --output semgrep.sarif || true

      - name: Dependency scan (pip-audit)
        run: |
          pip-audit -r services/user/requirements.txt -f sarif -o pip-audit-user.sarif || true
          pip-audit -r services/activity/requirements.txt -f sarif -o pip-audit-activity.sarif || true
          pip-audit -r services/notification/requirements.txt -f sarif -o pip-audit-notification.sarif || true

      - name: Upload SAST artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast_reports
          path: |
            *.sarif

  # ÂçïÂÖÉÊµãËØï‰∏éË¶ÜÁõñÁéáÔºàPRÔºâ
  unit:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [sast]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage
          pip install -r services/user/requirements.txt
          pip install -r services/activity/requirements.txt
          pip install -r services/notification/requirements.txt

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci || npm install

      - name: Run user service tests (with coverage)
        run: |
          cd services/user
          python manage.py migrate --settings=user_service.settings.base
          coverage run --source=. manage.py test users.tests --noinput --settings=user_service.settings.base
          coverage xml -o ../../coverage-user.xml
          coverage html -d ../../coverage-user-html
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Run activity service tests (with coverage)
        run: |
          cd services/activity
          python manage.py migrate --settings=activity_service.settings.base
          coverage run --source=. manage.py test activities.tests --noinput --settings=activity_service.settings.base
          coverage xml -o ../../coverage-activity.xml
          coverage html -d ../../coverage-activity-html
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Run notification service tests (with coverage)
        run: |
          cd services/notification
          python manage.py migrate --settings=notification_service.settings
          coverage run --source=. manage.py test notification_service.tests --noinput --settings=notification_service.settings
          coverage xml -o ../../coverage-notification.xml
          coverage html -d ../../coverage-notification-html
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Check coverage threshold
        continue-on-error: true
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET
          import sys
          files = [
            'coverage-user.xml',
            'coverage-activity.xml',
            'coverage-notification.xml'
          ]
          total_covered = 0
          total_lines = 0
          for f in files:
              try:
                  tree = ET.parse(f)
                  cov = tree.getroot().attrib
                  total_covered += int(cov.get('lines-covered', 0))
                  total_lines += int(cov.get('lines-valid', 0))
              except Exception as e:
                  print(f"Warning: Could not parse {f}: {e}")
          pct = (total_covered / total_lines * 100) if total_lines else 0
          print(f"Aggregate coverage: {pct:.2f}%")
          if pct < 85:
              print(f"‚ö†Ô∏è  Coverage is below target (85%), current: {pct:.2f}%")
              print("This is a warning and will not block the CI pipeline.")
          else:
              print(f"‚úÖ Coverage meets target: {pct:.2f}%")
          PY

      - name: Generate combined coverage HTML report
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import xml.etree.ElementTree as ET
          import os
          import json
          
          # Ëß£ÊûêÊâÄÊúâË¶ÜÁõñÁéá XML Êñá‰ª∂
          coverage_data = {}
          total_covered = 0
          total_lines = 0
          
          for xml_file in ['coverage-user.xml', 'coverage-activity.xml', 'coverage-notification.xml']:
              if os.path.exists(xml_file):
                  try:
                      tree = ET.parse(xml_file)
                      root = tree.getroot()
                      service_name = xml_file.replace('coverage-', '').replace('.xml', '')
                      
                      covered = int(root.attrib.get('lines-covered', 0))
                      lines = int(root.attrib.get('lines-valid', 0))
                      
                      coverage_data[service_name] = {
                          'covered': covered,
                          'total': lines,
                          'percentage': (covered / lines * 100) if lines > 0 else 0
                      }
                      
                      total_covered += covered
                      total_lines += lines
                  except Exception as e:
                      print(f"Warning: Could not parse {xml_file}: {e}")
          
          aggregate_percentage = (total_covered / total_lines * 100) if total_lines > 0 else 0
          
          # ÁîüÊàêÊ±áÊÄª HTML Êä•Âëä
          html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Code Coverage Report</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; }}
                  .container {{ max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 30px; }}
                  .card {{ background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid #667eea; }}
                  .card.aggregate {{ border-left-color: #28a745; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); }}
                  .card h3 {{ color: #333; margin-bottom: 15px; font-size: 18px; }}
                  .percentage {{ font-size: 48px; font-weight: bold; color: #28a745; margin: 10px 0; }}
                  .percentage.warning {{ color: #ff9800; }}
                  .percentage.low {{ color: #f44336; }}
                  .stats {{ display: flex; justify-content: space-between; margin-top: 10px; color: #666; }}
                  .progress-bar {{ width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin-top: 10px; }}
                  .progress-fill {{ height: 100%; background: linear-gradient(90deg, #28a745, #4caf50); transition: width 0.3s; }}
                  .progress-fill.warning {{ background: linear-gradient(90deg, #ff9800, #ffb74d); }}
                  .progress-fill.low {{ background: linear-gradient(90deg, #f44336, #e57373); }}
                  .links {{ padding: 20px; background: #f8f9fa; border-top: 1px solid #e0e0e0; }}
                  .links a {{ display: inline-block; margin: 5px 10px 5px 0; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; }}
                  .links a:hover {{ background: #5568d3; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üìä Code Coverage Report</h1>
                      <p>Aggregate Coverage: {aggregate_percentage:.2f}%</p>
                  </header>
                  
                  <div class="summary">
                      <div class="card aggregate">
                          <h3>Overall Coverage</h3>
                          <div class="percentage {'warning' if aggregate_percentage < 85 else ''} {'low' if aggregate_percentage < 60 else ''}">
                              {aggregate_percentage:.2f}%
                          </div>
                          <div class="progress-bar">
                              <div class="progress-fill {'warning' if aggregate_percentage < 85 else ''} {'low' if aggregate_percentage < 60 else ''}" style="width: {aggregate_percentage}%"></div>
                          </div>
                          <div class="stats">
                              <span>Covered: {total_covered:,}</span>
                              <span>Total: {total_lines:,}</span>
                          </div>
                      </div>
          """
          
          for service, data in coverage_data.items():
              pct = data['percentage']
              pct_class = 'warning' if pct < 85 else ''
              pct_class = 'low' if pct < 60 else pct_class
              
              html += f"""
                      <div class="card">
                          <h3>{service.replace('-', ' ').title()} Service</h3>
                          <div class="percentage {pct_class}">
                              {pct:.2f}%
                          </div>
                          <div class="progress-bar">
                              <div class="progress-fill {pct_class}" style="width: {pct}%"></div>
                          </div>
                          <div class="stats">
                              <span>Covered: {data['covered']:,}</span>
                              <span>Total: {data['total']:,}</span>
                          </div>
                      </div>
              """
          
          html += """
                  </div>
                  
                  <div class="links">
                      <h3>üìÅ Detailed Reports:</h3>
                      <a href="coverage-user-html/index.html" target="_blank">User Service Details</a>
                      <a href="coverage-activity-html/index.html" target="_blank">Activity Service Details</a>
                      <a href="coverage-notification-html/index.html" target="_blank">Notification Service Details</a>
                  </div>
              </div>
          </body>
          </html>
          """
          
          with open('coverage-summary.html', 'w', encoding='utf-8') as f:
              f.write(html)
          print("‚úÖ Generated coverage-summary.html")
          PYTHON_SCRIPT

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage_reports
          path: |
            coverage-*.xml
            coverage-*-html/
            coverage-summary.html
          if-no-files-found: ignore
          retention-days: 7

      - name: Run frontend build test
        run: |
          cd frontend
          npm run build
          echo "‚úÖ Frontend build successful"

  # ÈõÜÊàê‰∏éÁ´ØÂà∞Á´ØÊµãËØïÔºàPRÔºâ
  integration:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [unit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start stack for integration tests
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: Wait for services health
        run: |
          for i in {1..60}; do
            curl -fsS http://localhost:8001/api/v1/health/ && \
            curl -fsS http://localhost:8002/api/v1/health/ && \
            curl -fsS http://localhost:8003/api/v1/health/ && exit 0 || sleep 2
          done
          exit 1

      - name: Install Newman and Playwright
        run: |
          sudo npm -g i newman
          npm ci --prefix frontend || npm install --prefix frontend
          npx playwright install --with-deps

      - name: Run Postman collection (API integration)
        run: |
          newman run tests/postman_collection.json \
            --environment tests/postman_env.json \
            --reporters cli,html \
            --reporter-html-export newman-report.html

      - name: Run Playwright E2E
        run: npm test --prefix frontend -- --reporter=html --output=playwright-report || true

      - name: Upload integration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: integration_artifacts
          path: |
            newman-report.html
            frontend/playwright-report

  # ÂÆπÂô®ÈïúÂÉè‰∏éK8sÊ∏ÖÂçïÊâ´ÊèèÔºàPRÔºâ
  container_iac_scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [unit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build images
        run: |
          docker build -t user-service:ci ./services/user || true
          docker build -t activity-service:ci ./services/activity || true
          docker build -t notification-service:ci ./services/notification || true

      - name: Trivy image scan (user)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: user-service:ci
          format: 'json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-user-image.json'

      - name: Trivy image scan (activity)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: activity-service:ci
          format: 'json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-activity-image.json'

      - name: Trivy image scan (notification)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: notification-service:ci
          format: 'json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-notification-image.json'

      - name: Trivy Dockerfile scan (user-service)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: './services/user'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-user-dockerfile.json'

      - name: Trivy Dockerfile scan (activity-service)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: './services/activity'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-activity-dockerfile.json'

      - name: Trivy Dockerfile scan (notification-service)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: './services/notification'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-notification-dockerfile.json'

      - name: Trivy Dockerfile scan (frontend)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: './frontend'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-frontend-dockerfile.json'

      - name: Generate Trivy HTML reports
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import glob
          import os
          
          for json_file in glob.glob('trivy-*.json'):
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
                  
                  html_file = json_file.replace('.json', '.html')
                  
                  # ÁªüËÆ°ÊºèÊ¥û
                  total_vulns = 0
                  critical_count = 0
                  high_count = 0
                  medium_count = 0
                  low_count = 0
                  
                  vulns_list = []
                  
                  if 'Results' in data:
                      for result in data.get('Results', []):
                          if 'Vulnerabilities' in result:
                              for vuln in result['Vulnerabilities']:
                                  total_vulns += 1
                                  severity = vuln.get('Severity', 'UNKNOWN')
                                  if severity == 'CRITICAL':
                                      critical_count += 1
                                  elif severity == 'HIGH':
                                      high_count += 1
                                  elif severity == 'MEDIUM':
                                      medium_count += 1
                                  elif severity == 'LOW':
                                      low_count += 1
                                  
                                  vulns_list.append({
                                      'id': vuln.get('VulnerabilityID', 'N/A'),
                                      'severity': severity,
                                      'package': vuln.get('PkgName', 'N/A'),
                                      'version': vuln.get('InstalledVersion', 'N/A'),
                                      'title': vuln.get('Title', vuln.get('Description', 'N/A'))[:150],
                                      'description': vuln.get('Description', 'N/A')
                                  })
                  
                  # ÁîüÊàê HTML
                  html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Trivy Scan Report - {os.path.basename(json_file)}</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; line-height: 1.6; }}
                  .container {{ max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .subtitle {{ opacity: 0.9; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #f8f9fa; }}
                  .stat-card {{ background: white; padding: 20px; border-radius: 6px; border-left: 4px solid #667eea; }}
                  .stat-card.critical {{ border-left-color: #dc3545; }}
                  .stat-card.high {{ border-left-color: #fd7e14; }}
                  .stat-card.medium {{ border-left-color: #ffc107; }}
                  .stat-card.low {{ border-left-color: #28a745; }}
                  .stat-number {{ font-size: 32px; font-weight: bold; margin-bottom: 5px; }}
                  .stat-label {{ color: #6c757d; font-size: 14px; }}
                  .vuln-table {{ width: 100%; border-collapse: collapse; }}
                  .vuln-table th {{ background: #495057; color: white; padding: 12px; text-align: left; font-weight: 600; }}
                  .vuln-table td {{ padding: 12px; border-bottom: 1px solid #e9ecef; }}
                  .vuln-table tr:hover {{ background: #f8f9fa; }}
                  .severity-badge {{ display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }}
                  .severity-critical {{ background: #dc3545; color: white; }}
                  .severity-high {{ background: #fd7e14; color: white; }}
                  .severity-medium {{ background: #ffc107; color: #212529; }}
                  .severity-low {{ background: #28a745; color: white; }}
                  .vuln-id {{ font-family: 'Courier New', monospace; font-size: 13px; }}
                  .content {{ padding: 20px; }}
                  .no-vulns {{ text-align: center; padding: 40px; color: #28a745; font-size: 18px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üîç Trivy Security Scan Report</h1>
                      <div class="subtitle">{os.path.basename(json_file)}</div>
                  </header>
                  
                  <div class="summary">
                      <div class="stat-card">
                          <div class="stat-number">{total_vulns}</div>
                          <div class="stat-label">Total Vulnerabilities</div>
                      </div>
                      <div class="stat-card critical">
                          <div class="stat-number">{critical_count}</div>
                          <div class="stat-label">Critical</div>
                      </div>
                      <div class="stat-card high">
                          <div class="stat-number">{high_count}</div>
                          <div class="stat-label">High</div>
                      </div>
                      <div class="stat-card medium">
                          <div class="stat-number">{medium_count}</div>
                          <div class="stat-label">Medium</div>
                      </div>
                      <div class="stat-card low">
                          <div class="stat-number">{low_count}</div>
                          <div class="stat-label">Low</div>
                      </div>
                  </div>
                  
                  <div class="content">
          """
                  
                  if vulns_list:
                      # Êåâ‰∏•ÈáçÊÄßÊéíÂ∫è
                      severity_order = {'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3, 'UNKNOWN': 4}
                      vulns_list.sort(key=lambda x: (severity_order.get(x['severity'], 99), x['id']))
                      
                      html += """
                      <table class="vuln-table">
                          <thead>
                              <tr>
                                  <th>Vulnerability ID</th>
                                  <th>Severity</th>
                                  <th>Package</th>
                                  <th>Version</th>
                                  <th>Description</th>
                              </tr>
                          </thead>
                          <tbody>
                      """
                      
                      for vuln in vulns_list:
                          severity_class = f'severity-{vuln["severity"].lower()}'
                          html += f"""
                              <tr>
                                  <td class="vuln-id">{vuln['id']}</td>
                                  <td><span class="severity-badge {severity_class}">{vuln['severity']}</span></td>
                                  <td><strong>{vuln['package']}</strong></td>
                                  <td>{vuln['version']}</td>
                                  <td>{vuln['title']}</td>
                              </tr>
                          """
                      
                      html += """
                          </tbody>
                      </table>
                      """
                  else:
                      html += '<div class="no-vulns">‚úÖ No vulnerabilities found!</div>'
                  
                  html += """
                  </div>
              </div>
          </body>
          </html>
          """
                  
                  with open(html_file, 'w', encoding='utf-8') as f:
                      f.write(html)
                  print(f"‚úÖ Generated {html_file}")
              except Exception as e:
                  print(f"‚ö†Ô∏è  Error processing {json_file}: {e}")
          PYTHON_SCRIPT

      - name: Checkov scan (Dockerfiles)
        continue-on-error: true
        run: |
          pip install checkov
          checkov -d . --framework dockerfile --output cli --output-file-path checkov-dockerfile.txt || true

      - name: Checkov scan (K8s manifests)
        continue-on-error: true
        run: |
          checkov -d k8s --framework kubernetes --output cli --output-file-path checkov-k8s.txt || true

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: container_iac_scan_results
          path: |
            trivy-*.json
            trivy-*.html
            checkov-*.txt
          if-no-files-found: ignore
          retention-days: 7

  # DASTÔºàPRÔºâÔºöÂØπÊú¨Âú∞ÈõÜÊàêÁéØÂ¢ÉËøõË°åÂü∫Á∫øÂä®ÊÄÅÊâ´Êèè
  dast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [integration]
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure integration stack up
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: Wait for services to be ready
        run: |
          echo "Á≠âÂæÖÊúçÂä°ÂêØÂä®..."
          for i in {1..30}; do
            if curl -fsS http://localhost:8001/api/v1/health/ > /dev/null 2>&1; then
              echo "‚úÖ user-service Â∑≤Â∞±Áª™"
              break
            fi
            echo "Á≠âÂæÖ‰∏≠... ($i/30)"
            sleep 2
          done
          
          # È™åËØÅÊúçÂä°ÊòØÂê¶ÁúüÁöÑÂèØÁî®
          curl -fsS http://localhost:8001/api/v1/health/ || (echo "‚ùå user-service Êú™Â∞±Áª™" && exit 1)

      - name: OWASP ZAP baseline scan (user-service)
        continue-on-error: true
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8001'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -m 5'
          fail_action: false
          allow_issue_writing: false
          upload_artifact: false

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          if-no-files-found: ignore
          retention-days: 7

  # ÊÄßËÉΩÊµãËØïÔºàPRÔºâÔºå‰ΩøÁî®Êé•ËøëÁîü‰∫ßÁöÑËøõÁ®ãÊ®°Âûã
  perf:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Launch perf env (gunicorn)
        run: docker compose -f docker-compose.perf.yml up -d --build

      - name: Wait for services to be ready
        run: |
          echo "Á≠âÂæÖÊÄßËÉΩÊµãËØïÁéØÂ¢ÉÊúçÂä°ÂêØÂä®..."
          for i in {1..60}; do
            if curl -fsS http://localhost:8001/api/v1/health/ > /dev/null 2>&1 && \
               curl -fsS http://localhost:8002/api/v1/health/ > /dev/null 2>&1 && \
               curl -fsS http://localhost:8003/api/v1/health/ > /dev/null 2>&1; then
              echo "‚úÖ ÊâÄÊúâÊúçÂä°Â∑≤Â∞±Áª™"
              break
            fi
            echo "Á≠âÂæÖ‰∏≠... ($i/60)"
            sleep 2
          done
          
          # È™åËØÅÊúçÂä°ÊòØÂê¶ÁúüÁöÑÂèØÁî®
          curl -fsS http://localhost:8001/api/v1/health/ || (echo "‚ùå user-service Êú™Â∞±Áª™" && exit 1)
          curl -fsS http://localhost:8002/api/v1/health/ || (echo "‚ùå activity-service Êú™Â∞±Áª™" && exit 1)
          curl -fsS http://localhost:8003/api/v1/health/ || (echo "‚ùå notification-service Êú™Â∞±Áª™" && exit 1)

      - name: k6 load test
        continue-on-error: true
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/perf/k6-load.js

      - name: Install JMeter
        run: sudo apt-get update && sudo apt-get install -y jmeter

      - name: Run JMeter plan
        continue-on-error: true
        run: |
          jmeter -n -t tests/perf/jmeter_test.jmx -l jmeter.jtl -e -o jmeter-report || true

      - name: Upload perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf_results
          path: |
            jmeter.jtl
            jmeter-report
          if-no-files-found: ignore
          retention-days: 7

  # ÈÉ®ÁΩ≤Èò∂ÊÆµ - Êé®ÈÄÅÂà∞mainÂàÜÊîØÊó∂ËøêË°å
  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Production
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            echo "üöÄ ÂºÄÂßãÈÉ®ÁΩ≤ Volunteer Platform..."
            
            # ËøõÂÖ•È°πÁõÆÁõÆÂΩï
            cd /home/project/Volunteer-platform
            
            # Êõ¥Êñ∞‰ª£Á†Å
            echo "üì• Êõ¥Êñ∞‰ª£Á†Å..."
            git pull
          
            # ÊûÑÂª∫ÈïúÂÉè
            echo "üî® ÊûÑÂª∫ÈïúÂÉè..."
            docker compose build
            
            # Ê£ÄÊü•Áé∞ÊúâÈïúÂÉè
            echo "1. Ê£ÄÊü•Áé∞ÊúâÈïúÂÉè..."
            docker images | grep jsrgzyc
            
            # ÂØºÂÖ•ÈïúÂÉèÂà∞containerd
            echo "2. ÂØºÂÖ•ÈïúÂÉèÂà∞containerd..."
          
            echo "ÂØºÂÖ•user-service..."
            if docker images | grep -q "jsrgzyc/user-service"; then
                docker save jsrgzyc/user-service:latest | ctr -n k8s.io images import -
                echo "‚úÖ user-serviceÂØºÂÖ•ÊàêÂäü"
            else
                echo "‚ùå user-serviceÈïúÂÉè‰∏çÂ≠òÂú®"
            fi
          
            echo "ÂØºÂÖ•activity-service..."
            if docker images | grep -q "jsrgzyc/activity-service"; then
                docker save jsrgzyc/activity-service:latest | ctr -n k8s.io images import -
                echo "‚úÖ activity-serviceÂØºÂÖ•ÊàêÂäü"
            else
                echo "‚ùå activity-serviceÈïúÂÉè‰∏çÂ≠òÂú®"
            fi
          
            echo "ÂØºÂÖ•notification-service..."
            if docker images | grep -q "jsrgzyc/notification-service"; then
                docker save jsrgzyc/notification-service:latest | ctr -n k8s.io images import -
                echo "‚úÖ notification-serviceÂØºÂÖ•ÊàêÂäü"
            else
                echo "‚ùå notification-serviceÈïúÂÉè‰∏çÂ≠òÂú®"
            fi
          
            echo "ÂØºÂÖ•frontend..."
            if docker images | grep -q "jsrgzyc/frontend"; then
                docker save jsrgzyc/frontend:latest | ctr -n k8s.io images import -
                echo "‚úÖ frontendÂØºÂÖ•ÊàêÂäü"
            else
                echo "‚ùå frontendÈïúÂÉè‰∏çÂ≠òÂú®"
            fi
          
            # È™åËØÅÈïúÂÉèÂØºÂÖ•ÂÆåÊàê
            echo "üîç È™åËØÅÈïúÂÉèÂØºÂÖ•Áä∂ÊÄÅ..."
            required_images=(
                "jsrgzyc/user-service:latest"
                "jsrgzyc/activity-service:latest"
                "jsrgzyc/notification-service:latest"
                "jsrgzyc/frontend:latest"
            )
            
            # Á≠âÂæÖÂπ∂È™åËØÅÈïúÂÉèÂØºÂÖ•ÂÆåÊàê
            max_attempts=10
            attempt=1
            
            while [ $attempt -le $max_attempts ]; do
                echo "Ê£ÄÊü•ÈïúÂÉèÂØºÂÖ•Áä∂ÊÄÅ (Â∞ùËØï $attempt/$max_attempts)..."
                all_imported=true
                
                for image in "${required_images[@]}"; do
                    if ctr -n k8s.io images list | grep -q "$image"; then
                        echo "‚úÖ $image Â∑≤ÂØºÂÖ•"
                    else
                        echo "‚è≥ $image Â∞öÊú™ÂØºÂÖ•ÔºåÁ≠âÂæÖ‰∏≠..."
                        all_imported=false
                    fi
                done
                
                if [ "$all_imported" = true ]; then
                    echo "‚úÖ ÊâÄÊúâÈïúÂÉèÂØºÂÖ•ÂÆåÊàêÔºÅ"
                    break
                fi
                
                if [ $attempt -eq $max_attempts ]; then
                    echo "‚ùå ÈïúÂÉèÂØºÂÖ•Ë∂ÖÊó∂Ôºå‰ª•‰∏ãÈïúÂÉèÊú™ËÉΩÊàêÂäüÂØºÂÖ•Ôºö"
                    for image in "${required_images[@]}"; do
                        if ! ctr -n k8s.io images list | grep -q "$image"; then
                            echo "  - $image"
                        fi
                    done
                    exit 1
                fi
                
                echo "Á≠âÂæÖ2ÁßíÂêéÈáçËØï..."
                sleep 2
                attempt=$((attempt + 1))
            done
            
            echo "‚úÖ ÊâÄÊúâÈïúÂÉèÂØºÂÖ•ÂÆåÊàêÔºåÂºÄÂßãKubernetesÈÉ®ÁΩ≤..."
            
            # Ê£ÄÊü• kubectl ÊòØÂê¶ÂèØÁî®
            echo "üîç Ê£ÄÊü• kubectl ÊòØÂê¶ÂèØÁî®..."
            if ! command -v kubectl &> /dev/null; then
                echo "‚ùå kubectl Êú™ÂÆâË£ÖÊàñ‰∏çÂú® PATH ‰∏≠"
                exit 1
            else
                echo "‚úÖ kubectl ÂèØÁî®"
            fi
            
            # Ê£ÄÊü•ÈõÜÁæ§ËøûÊé•
            echo "üîó Ê£ÄÊü• Kubernetes ÈõÜÁæ§ËøûÊé•..."
            if kubectl cluster-info >/dev/null 2>&1; then
                echo "‚úÖ Kubernetes ÈõÜÁæ§ËøûÊé•Ê≠£Â∏∏"
            else
                echo "‚ùå Êó†Ê≥ïËøûÊé•Âà∞ Kubernetes ÈõÜÁæ§ÔºåËØ∑Ê£ÄÊü• kubeconfig„ÄÅÁΩëÁªú‰∏éÈõÜÁæ§Áä∂ÊÄÅ"
                exit 1
            fi
          
            # ÂàõÂª∫ÂëΩÂêçÁ©∫Èó¥
            echo "üì¶ ÂàõÂª∫ÂëΩÂêçÁ©∫Èó¥..."
            kubectl apply -f k8s/namespace.yaml
            
            # ÂàõÂª∫ÈÖçÁΩÆ
            echo "‚öôÔ∏è ÂàõÂª∫ÈÖçÁΩÆ..."
            kubectl apply -f k8s/configmap.yaml
            
            # ÈÉ®ÁΩ≤Êï∞ÊçÆÂ∫ìÊúçÂä°
            echo "üóÑÔ∏è ÈÉ®ÁΩ≤Êï∞ÊçÆÂ∫ìÊúçÂä°..."
            kubectl apply -f k8s/postgres-deployment.yaml
            
            # ÈÉ®ÁΩ≤ÂæÆÊúçÂä°
            echo "üîß ÈÉ®ÁΩ≤ÂæÆÊúçÂä°..."
            kubectl apply -f k8s/microservices-deployments.yaml
            kubectl apply -f k8s/microservices-services.yaml
            
            # ÈÉ®ÁΩ≤ÂâçÁ´Ø
            echo "üîß ÈÉ®ÁΩ≤ÂâçÁ´Ø..."
            kubectl apply -f k8s/frontend-deployment.yaml
            
            # Á≠âÂæÖÂü∫Á°ÄÊúçÂä°ÈÉ®ÁΩ≤ÂÆåÊàê
            echo "‚è≥ Á≠âÂæÖÂü∫Á°ÄÊúçÂä°ÈÉ®ÁΩ≤ÂÆåÊàê..."
            base_deployments=(
                "postgres"
                "user-service"
                "activity-service"
                "notification-service"
                "frontend-service"
            )
            
            for deployment in "${base_deployments[@]}"; do
                echo "Á≠âÂæÖ $deployment Â∞±Áª™..."
                kubectl wait --for=condition=available --timeout=300s deployment/$deployment -n mywork
            done
            
            # ÈÉ®ÁΩ≤ nginx ÁΩëÂÖ≥
            echo "üåê ÈÉ®ÁΩ≤ nginx ÁΩëÂÖ≥..."
            kubectl apply -f k8s/nginx-deployment.yaml
            
            # Á≠âÂæÖnginxÁΩëÂÖ≥ÈÉ®ÁΩ≤ÂÆåÊàê
            echo "‚è≥ Á≠âÂæÖ nginx ÁΩëÂÖ≥ÈÉ®ÁΩ≤ÂÆåÊàê..."
            kubectl wait --for=condition=available --timeout=300s deployment/nginx-gateway -n mywork
            
            # ÈÉ®ÁΩ≤ Ingress
            echo "üö™ ÈÉ®ÁΩ≤ Ingress..."
            kubectl apply -f k8s/ingress-nginx-controller.yaml
            kubectl apply -f k8s/ingress.yaml
            
            # Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ
            echo "üìä Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ..."
            
            echo "=== Pods ==="
            kubectl get pods -n mywork
            
            echo "=== Services ==="
            kubectl get services -n mywork
            
            echo "=== Ingress ==="
            kubectl get ingress -n mywork
            
            echo "=== ConfigMaps ==="
            kubectl get configmaps -n mywork
            
            echo "=== Deployments ==="
            kubectl get deployments -n mywork
            
            # Ëé∑ÂèñËÆøÈóÆ‰ø°ÊÅØ
            echo "üîó Ëé∑ÂèñËÆøÈóÆ‰ø°ÊÅØ..."
            
            # Ëé∑Âèñ Ingress ‰ø°ÊÅØ
            echo "=== Ingress ËÆøÈóÆÂú∞ÂùÄ ==="
            kubectl get ingress -n mywork -o wide
            
            # Ëé∑Âèñ NodePort ‰ø°ÊÅØ
            echo "=== NodePort ËÆøÈóÆÂú∞ÂùÄ ==="
            kubectl get service nginx-gateway-nodeport -n mywork -o wide
            
            # Ëé∑ÂèñÈõÜÁæ§ IP
            CLUSTER_IP=$(kubectl get service nginx-gateway-service -n mywork -o jsonpath='{.spec.clusterIP}')
            echo "=== ÈõÜÁæ§ÂÜÖËÆøÈóÆÂú∞ÂùÄ ==="
            echo "http://$CLUSTER_IP"
            
            echo "‚úÖ ÈÉ®ÁΩ≤ÂÆåÊàêÔºÅ"
          
      - name: Deployment Summary
        run: |
          echo "## üéâ ÈÉ®ÁΩ≤ÂÆåÊàêÔºÅ" >> $GITHUB_STEP_SUMMARY
          echo "| ÊúçÂä° | Áä∂ÊÄÅ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Áî®Êà∑ÊúçÂä° | ‚úÖ Â∑≤ÈÉ®ÁΩ≤ |" >> $GITHUB_STEP_SUMMARY
          echo "| Ê¥ªÂä®ÊúçÂä° | ‚úÖ Â∑≤ÈÉ®ÁΩ≤ |" >> $GITHUB_STEP_SUMMARY
          echo "| ÈÄöÁü•ÊúçÂä° | ‚úÖ Â∑≤ÈÉ®ÁΩ≤ |" >> $GITHUB_STEP_SUMMARY
          echo "| ÂâçÁ´ØÊúçÂä° | ‚úÖ Â∑≤ÈÉ®ÁΩ≤ |" >> $GITHUB_STEP_SUMMARY
          echo "| NginxÁΩëÂÖ≥ | ‚úÖ Â∑≤ÈÉ®ÁΩ≤ |" >> $GITHUB_STEP_SUMMARY
          echo "| Ingress | ‚úÖ Â∑≤ÈÉ®ÁΩ≤ |" >> $GITHUB_STEP_SUMMARY