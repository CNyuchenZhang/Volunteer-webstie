name: ğŸš€ Volunteer Platform CI/CD

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main" ]

jobs:
  # ä»£ç ä¸ä¾èµ–å®‰å…¨æ‰«æï¼ˆPRï¼‰
  sast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´ Git å†å²ï¼ŒGitleaks éœ€è¦æ‰«æ PR å˜æ›´

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Gitleaks (secrets)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          path: .
          report-format: sarif
          report-path: gitleaks.sarif

      - name: Install SAST tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit semgrep pip-audit

      - name: Bandit (Python SAST)
        run: bandit -r services -f json -o bandit.json || true

      - name: Semgrep (generic SAST)
        run: semgrep ci --sarif --output semgrep.sarif || true

      - name: Dependency scan (pip-audit)
        run: |
          pip-audit -r services/user/requirements.txt -f sarif -o pip-audit-user.sarif || true
          pip-audit -r services/activity/requirements.txt -f sarif -o pip-audit-activity.sarif || true
          pip-audit -r services/notification/requirements.txt -f sarif -o pip-audit-notification.sarif || true

      - name: Generate SAST HTML reports
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import glob
          import os
          
          # å·¥å…·æ˜ å°„
          tool_names = {
              'gitleaks.sarif': 'Gitleaks - å¯†é’¥æ³„éœ²æ£€æµ‹',
              'bandit.json': 'Bandit - Python å®‰å…¨æ‰«æ',
              'semgrep.sarif': 'Semgrep - é€šç”¨ä»£ç å®‰å…¨æ‰«æ',
              'pip-audit-user.sarif': 'pip-audit - User Service ä¾èµ–æ¼æ´',
              'pip-audit-activity.sarif': 'pip-audit - Activity Service ä¾èµ–æ¼æ´',
              'pip-audit-notification.sarif': 'pip-audit - Notification Service ä¾èµ–æ¼æ´'
          }
          
          all_results = {}
          
          # å¤„ç† SARIF æ–‡ä»¶
          for sarif_file in glob.glob('*.sarif'):
              try:
                  with open(sarif_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
                  
                  tool_name = tool_names.get(sarif_file, sarif_file.replace('.sarif', '').replace('-', ' ').title())
                  
                  # è§£æ SARIF ç»“æœ
                  runs = data.get('runs', [])
                  findings = []
                  total_findings = 0
                  
                  for run in runs:
                      results = run.get('results', [])
                      total_findings += len(results)
                      
                      for result in results:
                          rule_id = result.get('ruleId', 'N/A')
                          message = result.get('message', {}).get('text', 'N/A')
                          level = result.get('level', 'warning')
                          severity = result.get('properties', {}).get('severity', level)
                          
                          # è·å–ä½ç½®ä¿¡æ¯
                          locations = result.get('locations', [])
                          location_info = 'N/A'
                          if locations:
                              loc = locations[0].get('physicalLocation', {})
                              file_path = loc.get('artifactLocation', {}).get('uri', 'N/A')
                              region = loc.get('region', {})
                              start_line = region.get('startLine', 'N/A')
                              location_info = f"{file_path}:{start_line}"
                          
                          findings.append({
                              'rule_id': rule_id,
                              'message': message,
                              'severity': severity,
                              'location': location_info
                          })
                  
                  all_results[sarif_file] = {
                      'tool': tool_name,
                      'total': total_findings,
                      'findings': findings
                  }
                  
                  # ç”Ÿæˆå•ä¸ªå·¥å…·çš„ HTML æŠ¥å‘Š
                  html_file = sarif_file.replace('.sarif', '.html')
                  severity_colors = {
                      'error': '#dc3545',
                      'warning': '#fd7e14',
                      'note': '#ffc107',
                      'none': '#6c757d'
                  }
                  
                  html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{tool_name} - SAST Report</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; line-height: 1.6; }}
                  .container {{ max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .summary {{ padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }}
                  .stat {{ display: inline-block; margin-right: 30px; }}
                  .stat-number {{ font-size: 32px; font-weight: bold; color: #667eea; }}
                  .stat-label {{ color: #6c757d; font-size: 14px; margin-top: 5px; }}
                  .findings-table {{ width: 100%; border-collapse: collapse; }}
                  .findings-table th {{ background: #495057; color: white; padding: 12px; text-align: left; font-weight: 600; }}
                  .findings-table td {{ padding: 12px; border-bottom: 1px solid #e9ecef; }}
                  .findings-table tr:hover {{ background: #f8f9fa; }}
                  .severity-badge {{ display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }}
                  .severity-error {{ background: #dc3545; color: white; }}
                  .severity-warning {{ background: #fd7e14; color: white; }}
                  .severity-note {{ background: #ffc107; color: #212529; }}
                  .severity-none {{ background: #6c757d; color: white; }}
                  .location {{ font-family: 'Courier New', monospace; font-size: 13px; color: #667eea; }}
                  .no-findings {{ text-align: center; padding: 40px; color: #28a745; font-size: 18px; }}
                  .content {{ padding: 20px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>ğŸ”’ {tool_name}</h1>
                      <div style="opacity: 0.9;">Security Scan Report</div>
                  </header>
                  
                  <div class="summary">
                      <div class="stat">
                          <div class="stat-number">{total_findings}</div>
                          <div class="stat-label">Total Findings</div>
                      </div>
                  </div>
                  
                  <div class="content">
          """
                  
                  if findings:
                      html += """
                      <table class="findings-table">
                          <thead>
                              <tr>
                                  <th>Rule ID</th>
                                  <th>Severity</th>
                                  <th>Location</th>
                                  <th>Message</th>
                              </tr>
                          </thead>
                          <tbody>
                      """
                      
                      for finding in findings:
                          severity_class = f'severity-{finding["severity"].lower()}'
                          html += f"""
                              <tr>
                                  <td class="location">{finding['rule_id']}</td>
                                  <td><span class="severity-badge {severity_class}">{finding['severity'].upper()}</span></td>
                                  <td class="location">{finding['location']}</td>
                                  <td>{finding['message'][:200]}{'...' if len(finding['message']) > 200 else ''}</td>
                              </tr>
                          """
                      
                      html += """
                          </tbody>
                      </table>
                      """
                  else:
                      html += '<div class="no-findings">âœ… No security issues found!</div>'
                  
                  html += """
                  </div>
              </div>
          </body>
          </html>
          """
                  
                  with open(html_file, 'w', encoding='utf-8') as f:
                      f.write(html)
                  print(f"âœ… Generated {html_file}")
              except Exception as e:
                  print(f"âš ï¸  Error processing {sarif_file}: {e}")
          
          # å¤„ç† Bandit JSON æ–‡ä»¶ï¼ˆæ ¼å¼ä¸ SARIF ä¸åŒï¼‰
          bandit_file = 'bandit.json'
          if os.path.exists(bandit_file):
              try:
                  with open(bandit_file, 'r', encoding='utf-8') as f:
                      bandit_data = json.load(f)
                  
                  tool_name = tool_names.get(bandit_file, 'Bandit - Python å®‰å…¨æ‰«æ')
                  findings = []
                  total_findings = 0
                  
                  # Bandit JSON æ ¼å¼ï¼š{"results": [{"issue_id": "...", "test_name": "...", "severity": "...", ...}]}
                  results = bandit_data.get('results', [])
                  total_findings = len(results)
                  
                  for result in results:
                      issue_id = result.get('test_id', 'N/A')
                      test_name = result.get('test_name', 'N/A')
                      severity = result.get('issue_severity', result.get('severity', 'medium')).lower()
                      confidence = result.get('issue_confidence', result.get('confidence', 'medium')).lower()
                      message = result.get('issue_text', result.get('issue', 'N/A'))
                      filename = result.get('filename', 'N/A')
                      line_number = result.get('line_number', 'N/A')
                      location_info = f"{filename}:{line_number}"
                      
                      # ç»„åˆ severity å’Œ confidence
                      if severity == 'high' or confidence == 'high':
                          severity_level = 'error'
                      elif severity == 'medium' or confidence == 'medium':
                          severity_level = 'warning'
                      else:
                          severity_level = 'note'
                      
                      findings.append({
                          'rule_id': f"{test_name} ({issue_id})",
                          'message': message,
                          'severity': severity_level,
                          'location': location_info
                      })
                  
                  all_results[bandit_file] = {
                      'tool': tool_name,
                      'total': total_findings,
                      'findings': findings
                  }
                  
                  # ç”Ÿæˆ Bandit HTML æŠ¥å‘Š
                  html_file = bandit_file.replace('.json', '.html')
                  severity_colors = {
                      'error': '#dc3545',
                      'warning': '#fd7e14',
                      'note': '#ffc107',
                      'none': '#6c757d'
                  }
                  
                  html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{tool_name} - SAST Report</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; line-height: 1.6; }}
                  .container {{ max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .summary {{ padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }}
                  .stat {{ display: inline-block; margin-right: 30px; }}
                  .stat-number {{ font-size: 32px; font-weight: bold; color: #667eea; }}
                  .stat-label {{ color: #6c757d; font-size: 14px; margin-top: 5px; }}
                  .findings-table {{ width: 100%; border-collapse: collapse; }}
                  .findings-table th {{ background: #495057; color: white; padding: 12px; text-align: left; font-weight: 600; }}
                  .findings-table td {{ padding: 12px; border-bottom: 1px solid #e9ecef; }}
                  .findings-table tr:hover {{ background: #f8f9fa; }}
                  .severity-badge {{ display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }}
                  .severity-error {{ background: #dc3545; color: white; }}
                  .severity-warning {{ background: #fd7e14; color: white; }}
                  .severity-note {{ background: #ffc107; color: #212529; }}
                  .severity-none {{ background: #6c757d; color: white; }}
                  .location {{ font-family: 'Courier New', monospace; font-size: 13px; color: #667eea; }}
                  .no-findings {{ text-align: center; padding: 40px; color: #28a745; font-size: 18px; }}
                  .content {{ padding: 20px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>ğŸ”’ {tool_name}</h1>
                      <div style="opacity: 0.9;">Security Scan Report</div>
                  </header>
                  
                  <div class="summary">
                      <div class="stat">
                          <div class="stat-number">{total_findings}</div>
                          <div class="stat-label">Total Findings</div>
                      </div>
                  </div>
                  
                  <div class="content">
          """
                  
                  if findings:
                      html += """
                      <table class="findings-table">
                          <thead>
                              <tr>
                                  <th>Rule ID</th>
                                  <th>Severity</th>
                                  <th>Location</th>
                                  <th>Message</th>
                              </tr>
                          </thead>
                          <tbody>
                      """
                      
                      for finding in findings:
                          severity_class = f'severity-{finding["severity"].lower()}'
                          html += f"""
                              <tr>
                                  <td class="location">{finding['rule_id']}</td>
                                  <td><span class="severity-badge {severity_class}">{finding['severity'].upper()}</span></td>
                                  <td class="location">{finding['location']}</td>
                                  <td>{finding['message'][:200]}{'...' if len(finding['message']) > 200 else ''}</td>
                              </tr>
                          """
                      
                      html += """
                          </tbody>
                      </table>
                      """
                  else:
                      html += '<div class="no-findings">âœ… No security issues found!</div>'
                  
                  html += """
                  </div>
              </div>
          </body>
          </html>
          """
                  
                  with open(html_file, 'w', encoding='utf-8') as f:
                      f.write(html)
                  print(f"âœ… Generated {html_file}")
              except Exception as e:
                  print(f"âš ï¸  Error processing {bandit_file}: {e}")
          
          # ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
          total_all = sum(r['total'] for r in all_results.values())
          html_summary = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>SAST Security Scan Summary</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; }}
                  .container {{ max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 30px; }}
                  .card {{ background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid #667eea; }}
                  .card h3 {{ color: #333; margin-bottom: 15px; font-size: 18px; }}
                  .stat-number {{ font-size: 48px; font-weight: bold; color: #667eea; margin: 10px 0; }}
                  .stat-label {{ color: #6c757d; font-size: 14px; }}
                  .links {{ padding: 20px; background: #f8f9fa; border-top: 1px solid #e0e0e0; }}
                  .links a {{ display: inline-block; margin: 5px 10px 5px 0; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; }}
                  .links a:hover {{ background: #5568d3; }}
                  .tool-card {{ border-left-color: #dc3545; }} 
                  .tool-card.no-issues {{ border-left-color: #28a745; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>ğŸ”’ SAST Security Scan Summary</h1>
                      <p>Total Findings: {total_all}</p>
                  </header>
                  
                  <div class="summary">
          """
          
          for sarif_file, result in all_results.items():
              card_class = 'tool-card' if result['total'] > 0 else 'tool-card no-issues'
              html_summary += f"""
                      <div class="card {card_class}">
                          <h3>{result['tool']}</h3>
                          <div class="stat-number">{result['total']}</div>
                          <div class="stat-label">Findings</div>
                      </div>
              """
          
          html_summary += """
                  </div>
                  
                  <div class="links">
                      <h3>ğŸ“ Detailed Reports:</h3>
          """
          
          for report_file in sorted(all_results.keys()):
              # å¤„ç†ä¸åŒçš„æ–‡ä»¶æ‰©å±•å
              if report_file.endswith('.sarif'):
                  html_file = report_file.replace('.sarif', '.html')
              elif report_file.endswith('.json'):
                  html_file = report_file.replace('.json', '.html')
              else:
                  html_file = report_file + '.html'
              tool_name = all_results[report_file]['tool']
              html_summary += f'                      <a href="{html_file}" target="_blank">{tool_name}</a>\n'
          
          html_summary += """
                  </div>
              </div>
          </body>
          </html>
          """
          
          with open('sast-summary.html', 'w', encoding='utf-8') as f:
              f.write(html_summary)
          print("âœ… Generated sast-summary.html")
          PYTHON_SCRIPT

      - name: Upload SAST artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast_reports
          path: |
            *.sarif
            *.json
            *.html
          if-no-files-found: ignore
          retention-days: 7

  # å•å…ƒæµ‹è¯•ä¸è¦†ç›–ç‡ï¼ˆPRï¼‰
  unit:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [sast]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # å‡çº§åˆ° Node.js 20ï¼Œå†…å­˜ç®¡ç†æ›´å¥½
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage
          pip install -r services/user/requirements.txt
          pip install -r services/activity/requirements.txt
          pip install -r services/notification/requirements.txt

      - name: Install frontend dependencies
        run: |
          cd frontend
          # å°è¯•ä½¿ç”¨ npm ci è¿›è¡Œå¿«é€Ÿã€å¯é çš„å®‰è£…
          if npm ci; then
            echo "âœ… npm ci æˆåŠŸ"
          else
            echo "âš ï¸ npm ci å¤±è´¥ï¼Œå›é€€åˆ° npm install"
            npm install
          fi
          # éªŒè¯ Rollup å¯é€‰ä¾èµ–æ˜¯å¦å·²å®‰è£…ï¼ˆè¿™äº›ä¾èµ–å·²åœ¨ package.json çš„ optionalDependencies ä¸­å£°æ˜ï¼‰
          echo "éªŒè¯ Rollup å¯é€‰ä¾èµ–å®‰è£…çŠ¶æ€..."
          if [ -d "node_modules/@rollup/rollup-linux-x64-gnu" ] || [ -d "node_modules/rollup/node_modules/@rollup/rollup-linux-x64-gnu" ]; then
            echo "âœ… @rollup/rollup-linux-x64-gnu å·²å®‰è£…"
          else
            echo "âš ï¸ @rollup/rollup-linux-x64-gnu æœªæ‰¾åˆ°ï¼ˆnpm å¯é€‰ä¾èµ– bugï¼‰ï¼Œå°è¯•æ‰‹åŠ¨å®‰è£…..."
            # å¦‚æœ npm ci æ²¡æœ‰å®‰è£…å¯é€‰ä¾èµ–ï¼ˆå·²çŸ¥ bugï¼‰ï¼Œæ‰‹åŠ¨å®‰è£…å®ƒä»¬
            npm install @rollup/rollup-linux-x64-gnu@^4.52.5 --save-optional --legacy-peer-deps || echo "âš ï¸  æ‰‹åŠ¨å®‰è£…å¤±è´¥"
            npm install @rollup/rollup-linux-x64-musl@^4.52.5 --save-optional --legacy-peer-deps || echo "âš ï¸  æ‰‹åŠ¨å®‰è£…å¤±è´¥"
          fi

      - name: Run frontend unit tests (with coverage)
        run: |
          cd frontend
          # å°è¯•è¿è¡Œå¸¦è¦†ç›–ç‡çš„æµ‹è¯•ï¼Œå¦‚æœå¤±è´¥åˆ™è¿è¡Œä¸å¸¦è¦†ç›–ç‡çš„æµ‹è¯•
          # ä½¿ç”¨æ›´ä¿å®ˆçš„å†…å­˜è®¾ç½®å’Œæ›´çŸ­çš„è¶…æ—¶æ—¶é—´
          npm run test:unit:coverage || npm run test:unit || true
          
          # éªŒè¯è¦†ç›–ç‡æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ ! -f "coverage/coverage-summary.json" ]; then
            echo "âš ï¸  è¦†ç›–ç‡æ–‡ä»¶æœªç”Ÿæˆï¼Œåˆ›å»ºä¸€ä¸ªæœ€å°çš„è¦†ç›–ç‡æ–‡ä»¶"
            mkdir -p coverage
            cat > coverage/coverage-summary.json << 'EOF'
          {
            "total": {
              "lines": {"total": 0, "covered": 0, "skipped": 0, "pct": 0},
              "statements": {"total": 0, "covered": 0, "skipped": 0, "pct": 0},
              "functions": {"total": 0, "covered": 0, "skipped": 0, "pct": 0},
              "branches": {"total": 0, "covered": 0, "skipped": 0, "pct": 0}
            }
          }
          EOF
            echo "âœ… å·²åˆ›å»ºå ä½ç¬¦è¦†ç›–ç‡æ–‡ä»¶ï¼ˆæµ‹è¯•å¯èƒ½å¤±è´¥ï¼Œè¦†ç›–ç‡ä¸º0%ï¼‰"
          else
            echo "âœ… è¦†ç›–ç‡æ–‡ä»¶å·²ç”Ÿæˆ"
            # æ˜¾ç¤ºè¦†ç›–ç‡æ–‡ä»¶å†…å®¹çš„å‰å‡ è¡Œ
            head -n 20 coverage/coverage-summary.json || true
          fi
        continue-on-error: true
        env:
          NODE_OPTIONS: "--max-old-space-size=8192 --expose-gc"
          NODE_ENV: "test"
          UV_THREADPOOL_SIZE: "2"  # é™åˆ¶çº¿ç¨‹æ± å¤§å°ï¼Œå‡å°‘å†…å­˜å ç”¨

      - name: Run user service tests (with coverage)
        run: |
          cd services/user
          python manage.py migrate --settings=user_service.settings.base
          coverage run --source=. manage.py test users.tests --noinput --settings=user_service.settings.base
          coverage xml -o ../../coverage-user.xml
          coverage html -d ../../coverage-user-html
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Run activity service tests (with coverage)
        run: |
          cd services/activity
          python manage.py migrate --settings=activity_service.settings.base
          coverage run --source=. manage.py test activities.tests --noinput --settings=activity_service.settings.base
          coverage xml -o ../../coverage-activity.xml
          coverage html -d ../../coverage-activity-html
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Run notification service tests (with coverage)
        run: |
          cd services/notification
          python manage.py migrate --settings=notification_service.settings
          coverage run --source=. manage.py test notification_service.tests --noinput --settings=notification_service.settings
          coverage xml -o ../../coverage-notification.xml
          coverage html -d ../../coverage-notification-html
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        
      - name: Check coverage threshold
        continue-on-error: true
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET
          import json
          import os
          import sys
          
          # åç«¯æœåŠ¡è¦†ç›–ç‡
          files = [
            'coverage-user.xml',
            'coverage-activity.xml',
            'coverage-notification.xml'
          ]
          total_covered = 0
          total_lines = 0
          
          for f in files:
              try:
                  tree = ET.parse(f)
                  cov = tree.getroot().attrib
                  total_covered += int(cov.get('lines-covered', 0))
                  total_lines += int(cov.get('lines-valid', 0))
              except Exception as e:
                  print(f"Warning: Could not parse {f}: {e}")
          
          # å‰ç«¯è¦†ç›–ç‡
          frontend_coverage_file = 'frontend/coverage/coverage-summary.json'
          if os.path.exists(frontend_coverage_file):
              try:
                  with open(frontend_coverage_file, 'r', encoding='utf-8') as f:
                      frontend_data = json.load(f)
                  
                  frontend_total = frontend_data.get('total', {})
                  frontend_lines = frontend_total.get('lines', {})
                  frontend_covered = frontend_lines.get('covered', 0)
                  frontend_total_lines = frontend_lines.get('total', 0)
                  
                  if frontend_total_lines > 0:
                      total_covered += frontend_covered
                      total_lines += frontend_total_lines
                      frontend_pct = (frontend_covered / frontend_total_lines * 100)
                      print(f"å‰ç«¯è¦†ç›–ç‡: {frontend_pct:.2f}% ({frontend_covered}/{frontend_total_lines})")
              except Exception as e:
                  print(f"Warning: Could not parse frontend coverage: {e}")
          
          pct = (total_covered / total_lines * 100) if total_lines else 0
          print(f"Aggregate coverage (åç«¯ + å‰ç«¯): {pct:.2f}%")
          if pct < 85:
              print(f"âš ï¸  Coverage is below target (85%), current: {pct:.2f}%")
              print("This is a warning and will not block the CI pipeline.")
          else:
              print(f"âœ… Coverage meets target: {pct:.2f}%")
          PY

      - name: Generate combined coverage HTML report
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import xml.etree.ElementTree as ET
          import json
          import os
          import glob
          
          # è§£ææ‰€æœ‰è¦†ç›–ç‡ XML æ–‡ä»¶
          coverage_data = {}
          total_covered = 0
          total_lines = 0
          
          # åç«¯æœåŠ¡è¦†ç›–ç‡
          for xml_file in ['coverage-user.xml', 'coverage-activity.xml', 'coverage-notification.xml']:
              if os.path.exists(xml_file):
                  try:
                      tree = ET.parse(xml_file)
                      root = tree.getroot()
                      service_name = xml_file.replace('coverage-', '').replace('.xml', '')
                      
                      covered = int(root.attrib.get('lines-covered', 0))
                      lines = int(root.attrib.get('lines-valid', 0))
                      
                      coverage_data[service_name] = {
                          'covered': covered,
                          'total': lines,
                          'percentage': (covered / lines * 100) if lines > 0 else 0
                      }
                      
                      total_covered += covered
                      total_lines += lines
                  except Exception as e:
                      print(f"Warning: Could not parse {xml_file}: {e}")
          
          # å‰ç«¯è¦†ç›–ç‡ï¼ˆä» Vitest coverage æŠ¥å‘Šï¼‰
          frontend_coverage_file = 'frontend/coverage/coverage-summary.json'
          if os.path.exists(frontend_coverage_file):
              try:
                  with open(frontend_coverage_file, 'r', encoding='utf-8') as f:
                      frontend_data = json.load(f)
                  
                  # è®¡ç®—å‰ç«¯æ€»è¦†ç›–ç‡
                  frontend_total = frontend_data.get('total', {})
                  frontend_lines = frontend_total.get('lines', {})
                  frontend_covered = frontend_lines.get('covered', 0)
                  frontend_total_lines = frontend_lines.get('total', 0)
                  
                  if frontend_total_lines > 0:
                      frontend_percentage = (frontend_covered / frontend_total_lines * 100)
                      coverage_data['frontend'] = {
                          'covered': frontend_covered,
                          'total': frontend_total_lines,
                          'percentage': frontend_percentage
                      }
                      total_covered += frontend_covered
                      total_lines += frontend_total_lines
                      print(f"âœ… å‰ç«¯è¦†ç›–ç‡: {frontend_percentage:.2f}% ({frontend_covered}/{frontend_total_lines})")
                  else:
                      print("âš ï¸  å‰ç«¯æµ‹è¯•å¯èƒ½å¤±è´¥ï¼Œè¦†ç›–ç‡ä¸º 0%ï¼ˆå·²åˆ›å»ºå ä½ç¬¦æ–‡ä»¶ï¼‰")
                      coverage_data['frontend'] = {
                          'covered': 0,
                          'total': 0,
                          'percentage': 0
                      }
              except Exception as e:
                  print(f"âš ï¸  æ— æ³•è§£æå‰ç«¯è¦†ç›–ç‡: {e}")
          else:
              print("âš ï¸  å‰ç«¯è¦†ç›–ç‡æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆè¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œå› ä¸ºåº”è¯¥åˆ›å»ºäº†å ä½ç¬¦ï¼‰")
              # å³ä½¿æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿæ·»åŠ ä¸€ä¸ªå ä½ç¬¦æ¡ç›®
              coverage_data['frontend'] = {
                  'covered': 0,
                  'total': 0,
                  'percentage': 0
              }
          
          aggregate_percentage = (total_covered / total_lines * 100) if total_lines > 0 else 0
          
          # ç”Ÿæˆæ±‡æ€» HTML æŠ¥å‘Š
          html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Code Coverage Report</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; }}
                  .container {{ max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 30px; }}
                  .card {{ background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid #667eea; }}
                  .card.aggregate {{ border-left-color: #28a745; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); }}
                  .card h3 {{ color: #333; margin-bottom: 15px; font-size: 18px; }}
                  .percentage {{ font-size: 48px; font-weight: bold; color: #28a745; margin: 10px 0; }}
                  .percentage.warning {{ color: #ff9800; }}
                  .percentage.low {{ color: #f44336; }}
                  .stats {{ display: flex; justify-content: space-between; margin-top: 10px; color: #666; }}
                  .progress-bar {{ width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin-top: 10px; }}
                  .progress-fill {{ height: 100%; background: linear-gradient(90deg, #28a745, #4caf50); transition: width 0.3s; }}
                  .progress-fill.warning {{ background: linear-gradient(90deg, #ff9800, #ffb74d); }}
                  .progress-fill.low {{ background: linear-gradient(90deg, #f44336, #e57373); }}
                  .links {{ padding: 20px; background: #f8f9fa; border-top: 1px solid #e0e0e0; }}
                  .links a {{ display: inline-block; margin: 5px 10px 5px 0; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; }}
                  .links a:hover {{ background: #5568d3; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>ğŸ“Š Code Coverage Report</h1>
                      <p>Aggregate Coverage: {aggregate_percentage:.2f}%</p>
                  </header>
                  
                  <div class="summary">
                      <div class="card aggregate">
                          <h3>Overall Coverage</h3>
                          <div class="percentage {'warning' if aggregate_percentage < 85 else ''} {'low' if aggregate_percentage < 60 else ''}">
                              {aggregate_percentage:.2f}%
                          </div>
                          <div class="progress-bar">
                              <div class="progress-fill {'warning' if aggregate_percentage < 85 else ''} {'low' if aggregate_percentage < 60 else ''}" style="width: {aggregate_percentage}%"></div>
                          </div>
                          <div class="stats">
                              <span>Covered: {total_covered:,}</span>
                              <span>Total: {total_lines:,}</span>
                          </div>
                      </div>
          """
          
          for service, data in coverage_data.items():
              pct = data['percentage']
              pct_class = 'warning' if pct < 85 else ''
              pct_class = 'low' if pct < 60 else pct_class
              
              html += f"""
                      <div class="card">
                          <h3>{service.replace('-', ' ').title()} Service</h3>
                          <div class="percentage {pct_class}">
                              {pct:.2f}%
                          </div>
                          <div class="progress-bar">
                              <div class="progress-fill {pct_class}" style="width: {pct}%"></div>
                          </div>
                          <div class="stats">
                              <span>Covered: {data['covered']:,}</span>
                              <span>Total: {data['total']:,}</span>
                          </div>
                      </div>
              """
          
          html += """
                  </div>
                  
                  <div class="links">
                      <h3>ğŸ“ Detailed Reports:</h3>
                      <a href="coverage-user-html/index.html" target="_blank">User Service Details</a>
                      <a href="coverage-activity-html/index.html" target="_blank">Activity Service Details</a>
                      <a href="coverage-notification-html/index.html" target="_blank">Notification Service Details</a>
          """
          
          # æ·»åŠ å‰ç«¯è¦†ç›–ç‡é“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ä¸”æœ‰æ•°æ®ï¼‰
          if 'frontend' in coverage_data:
              if coverage_data['frontend']['total'] > 0:
                  html += """
                      <a href="frontend/coverage/index.html" target="_blank">Frontend Details</a>
          """
              else:
                  html += """
                      <span style="color: #dc3545; padding: 8px 16px;">âš ï¸ Frontend tests failed - No coverage data</span>
          """
          
          html += """
                  </div>
              </div>
          </body>
          </html>
          """
          
          with open('coverage-summary.html', 'w', encoding='utf-8') as f:
              f.write(html)
          print("âœ… Generated coverage-summary.html")
          PYTHON_SCRIPT

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage_reports
          path: |
            coverage-*.xml
            coverage-*-html/
            coverage-summary.html
            frontend/coverage/
          if-no-files-found: ignore
          retention-days: 7

      - name: Run frontend build test
        run: |
          cd frontend
          # éªŒè¯ Rollup å¯é€‰ä¾èµ–ï¼ˆå·²åœ¨ package.json ä¸­å£°æ˜ï¼Œnpm ci åº”è¯¥å·²å®‰è£…ï¼‰
          if [ ! -d "node_modules/@rollup/rollup-linux-x64-gnu" ] && [ ! -d "node_modules/rollup/node_modules/@rollup/rollup-linux-x64-gnu" ]; then
            echo "âš ï¸ Rollup å¯é€‰ä¾èµ–æœªæ‰¾åˆ°ï¼Œå°è¯•æ‰‹åŠ¨å®‰è£…ï¼ˆnpm å¯é€‰ä¾èµ– bugï¼‰..."
            npm install @rollup/rollup-linux-x64-gnu@^4.52.5 --save-optional --legacy-peer-deps || echo "âš ï¸  æ‰‹åŠ¨å®‰è£…å¤±è´¥"
            npm install @rollup/rollup-linux-x64-musl@^4.52.5 --save-optional --legacy-peer-deps || echo "âš ï¸  æ‰‹åŠ¨å®‰è£…å¤±è´¥"
          else
            echo "âœ… Rollup å¯é€‰ä¾èµ–å·²å­˜åœ¨"
          fi
          # è¿è¡Œæ„å»º
          npm run build
          echo "âœ… Frontend build successful"

  # é›†æˆä¸ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆPRï¼‰
  integration:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [unit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start stack for integration tests
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: Wait for services health
        run: |
          for i in {1..60}; do
            curl -fsS http://localhost:8001/api/v1/health/ && \
            curl -fsS http://localhost:8002/api/v1/health/ && \
            curl -fsS http://localhost:8003/api/v1/health/ && exit 0 || sleep 2
          done
          exit 1

      - name: Install Newman and Playwright
        run: |
          sudo npm -g i newman
          cd frontend
          # å°è¯•ä½¿ç”¨ npm ci è¿›è¡Œå¿«é€Ÿã€å¯é çš„å®‰è£…
          if npm ci; then
            echo "âœ… npm ci æˆåŠŸ"
          else
            echo "âš ï¸ npm ci å¤±è´¥ï¼Œå›é€€åˆ° npm install"
            npm install
          fi
          # éªŒè¯ Rollup å¯é€‰ä¾èµ–ï¼ˆå·²åœ¨ package.json ä¸­å£°æ˜ï¼‰
          if [ ! -d "node_modules/@rollup/rollup-linux-x64-gnu" ] && [ ! -d "node_modules/rollup/node_modules/@rollup/rollup-linux-x64-gnu" ]; then
            echo "âš ï¸ Rollup å¯é€‰ä¾èµ–æœªæ‰¾åˆ°ï¼Œå°è¯•æ‰‹åŠ¨å®‰è£…ï¼ˆnpm å¯é€‰ä¾èµ– bugï¼‰..."
            npm install @rollup/rollup-linux-x64-gnu@^4.52.5 --save-optional --legacy-peer-deps || echo "âš ï¸  æ‰‹åŠ¨å®‰è£…å¤±è´¥"
            npm install @rollup/rollup-linux-x64-musl@^4.52.5 --save-optional --legacy-peer-deps || echo "âš ï¸  æ‰‹åŠ¨å®‰è£…å¤±è´¥"
          else
            echo "âœ… Rollup å¯é€‰ä¾èµ–å·²å®‰è£…"
          fi
          cd ..
          npx playwright install --with-deps

      - name: Run Postman collection (API integration)
        run: |
          newman run tests/postman_collection.json \
            --environment tests/postman_env.json \
            --reporters cli,html \
            --reporter-html-export newman-report.html

      - name: Run Playwright E2E
        run: npm test --prefix frontend -- --reporter=html --output=playwright-report || true

      - name: Upload integration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: integration_artifacts
          path: |
            newman-report.html
            frontend/playwright-report

  # å®¹å™¨é•œåƒä¸K8sæ¸…å•æ‰«æï¼ˆPRï¼‰
  container_iac_scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [unit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build images
        run: |
          docker build -t user-service:ci ./services/user || true
          docker build -t activity-service:ci ./services/activity || true
          docker build -t notification-service:ci ./services/notification || true

      - name: Trivy image scan (user)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: user-service:ci
          format: 'json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-user-image.json'

      - name: Trivy image scan (activity)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: activity-service:ci
          format: 'json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-activity-image.json'

      - name: Trivy image scan (notification)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: notification-service:ci
          format: 'json'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-notification-image.json'

      - name: Trivy Dockerfile scan (user-service)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: './services/user'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-user-dockerfile.json'

      - name: Trivy Dockerfile scan (activity-service)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: './services/activity'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-activity-dockerfile.json'

      - name: Trivy Dockerfile scan (notification-service)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: './services/notification'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-notification-dockerfile.json'

      - name: Trivy Dockerfile scan (frontend)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: './frontend'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-frontend-dockerfile.json'

      - name: Generate Trivy HTML reports
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import glob
          import os
          
          for json_file in glob.glob('trivy-*.json'):
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
                  
                  html_file = json_file.replace('.json', '.html')
                  
                  # ç»Ÿè®¡æ¼æ´
                  total_vulns = 0
                  critical_count = 0
                  high_count = 0
                  medium_count = 0
                  low_count = 0
                  
                  vulns_list = []
                  
                  if 'Results' in data:
                      for result in data.get('Results', []):
                          if 'Vulnerabilities' in result:
                              for vuln in result['Vulnerabilities']:
                                  total_vulns += 1
                                  severity = vuln.get('Severity', 'UNKNOWN')
                                  if severity == 'CRITICAL':
                                      critical_count += 1
                                  elif severity == 'HIGH':
                                      high_count += 1
                                  elif severity == 'MEDIUM':
                                      medium_count += 1
                                  elif severity == 'LOW':
                                      low_count += 1
                                  
                                  vulns_list.append({
                                      'id': vuln.get('VulnerabilityID', 'N/A'),
                                      'severity': severity,
                                      'package': vuln.get('PkgName', 'N/A'),
                                      'version': vuln.get('InstalledVersion', 'N/A'),
                                      'title': vuln.get('Title', vuln.get('Description', 'N/A'))[:150],
                                      'description': vuln.get('Description', 'N/A')
                                  })
                  
                  # ç”Ÿæˆ HTML
                  html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Trivy Scan Report - {os.path.basename(json_file)}</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; line-height: 1.6; }}
                  .container {{ max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .subtitle {{ opacity: 0.9; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #f8f9fa; }}
                  .stat-card {{ background: white; padding: 20px; border-radius: 6px; border-left: 4px solid #667eea; }}
                  .stat-card.critical {{ border-left-color: #dc3545; }}
                  .stat-card.high {{ border-left-color: #fd7e14; }}
                  .stat-card.medium {{ border-left-color: #ffc107; }}
                  .stat-card.low {{ border-left-color: #28a745; }}
                  .stat-number {{ font-size: 32px; font-weight: bold; margin-bottom: 5px; }}
                  .stat-label {{ color: #6c757d; font-size: 14px; }}
                  .vuln-table {{ width: 100%; border-collapse: collapse; }}
                  .vuln-table th {{ background: #495057; color: white; padding: 12px; text-align: left; font-weight: 600; }}
                  .vuln-table td {{ padding: 12px; border-bottom: 1px solid #e9ecef; }}
                  .vuln-table tr:hover {{ background: #f8f9fa; }}
                  .severity-badge {{ display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }}
                  .severity-critical {{ background: #dc3545; color: white; }}
                  .severity-high {{ background: #fd7e14; color: white; }}
                  .severity-medium {{ background: #ffc107; color: #212529; }}
                  .severity-low {{ background: #28a745; color: white; }}
                  .vuln-id {{ font-family: 'Courier New', monospace; font-size: 13px; }}
                  .content {{ padding: 20px; }}
                  .no-vulns {{ text-align: center; padding: 40px; color: #28a745; font-size: 18px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>ğŸ” Trivy Security Scan Report</h1>
                      <div class="subtitle">{os.path.basename(json_file)}</div>
                  </header>
                  
                  <div class="summary">
                      <div class="stat-card">
                          <div class="stat-number">{total_vulns}</div>
                          <div class="stat-label">Total Vulnerabilities</div>
                      </div>
                      <div class="stat-card critical">
                          <div class="stat-number">{critical_count}</div>
                          <div class="stat-label">Critical</div>
                      </div>
                      <div class="stat-card high">
                          <div class="stat-number">{high_count}</div>
                          <div class="stat-label">High</div>
                      </div>
                      <div class="stat-card medium">
                          <div class="stat-number">{medium_count}</div>
                          <div class="stat-label">Medium</div>
                      </div>
                      <div class="stat-card low">
                          <div class="stat-number">{low_count}</div>
                          <div class="stat-label">Low</div>
                      </div>
                  </div>
                  
                  <div class="content">
          """
                  
                  if vulns_list:
                      # æŒ‰ä¸¥é‡æ€§æ’åº
                      severity_order = {'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3, 'UNKNOWN': 4}
                      vulns_list.sort(key=lambda x: (severity_order.get(x['severity'], 99), x['id']))
                      
                      html += """
                      <table class="vuln-table">
                          <thead>
                              <tr>
                                  <th>Vulnerability ID</th>
                                  <th>Severity</th>
                                  <th>Package</th>
                                  <th>Version</th>
                                  <th>Description</th>
                              </tr>
                          </thead>
                          <tbody>
                      """
                      
                      for vuln in vulns_list:
                          severity_class = f'severity-{vuln["severity"].lower()}'
                          html += f"""
                              <tr>
                                  <td class="vuln-id">{vuln['id']}</td>
                                  <td><span class="severity-badge {severity_class}">{vuln['severity']}</span></td>
                                  <td><strong>{vuln['package']}</strong></td>
                                  <td>{vuln['version']}</td>
                                  <td>{vuln['title']}</td>
                              </tr>
                          """
                      
                      html += """
                          </tbody>
                      </table>
                      """
                  else:
                      html += '<div class="no-vulns">âœ… No vulnerabilities found!</div>'
                  
                  html += """
                  </div>
              </div>
          </body>
          </html>
          """
                  
                  with open(html_file, 'w', encoding='utf-8') as f:
                      f.write(html)
                  print(f"âœ… Generated {html_file}")
              except Exception as e:
                  print(f"âš ï¸  Error processing {json_file}: {e}")
          PYTHON_SCRIPT

      - name: Checkov scan (Dockerfiles)
        continue-on-error: true
        run: |
          pip install checkov
          checkov -d . --framework dockerfile --output cli --output-file-path checkov-dockerfile.txt || true

      - name: Checkov scan (K8s manifests)
        continue-on-error: true
        run: |
          checkov -d k8s --framework kubernetes --output cli --output-file-path checkov-k8s.txt || true

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: container_iac_scan_results
          path: |
            trivy-*.json
            trivy-*.html
            checkov-*.txt
          if-no-files-found: ignore
          retention-days: 7

  # DASTï¼ˆPRï¼‰ï¼šå¯¹æœ¬åœ°é›†æˆç¯å¢ƒè¿›è¡ŒåŸºçº¿åŠ¨æ€æ‰«æ
  dast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [integration]
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure integration stack up
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: Wait for services to be ready
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          for i in {1..30}; do
            if curl -fsS http://localhost:8001/api/v1/health/ > /dev/null 2>&1; then
              echo "âœ… user-service å·²å°±ç»ª"
              break
            fi
            echo "ç­‰å¾…ä¸­... ($i/30)"
            sleep 2
          done
          
          # éªŒè¯æœåŠ¡æ˜¯å¦çœŸçš„å¯ç”¨
          curl -fsS http://localhost:8001/api/v1/health/ || (echo "âŒ user-service æœªå°±ç»ª" && exit 1)

      - name: Prepare ZAP working directory
        run: |
          # è®¾ç½®å·¥ä½œç›®å½•æƒé™ï¼Œç¡®ä¿ ZAP Docker å®¹å™¨ï¼ˆä»¥ root è¿è¡Œï¼‰å¯ä»¥å†™å…¥
          # ZAP action ä¼šå°†å½“å‰ç›®å½•æŒ‚è½½åˆ° Docker å®¹å™¨çš„ /zap/wrk
          # ç”±äºå®¹å™¨ä»¥ root è¿è¡Œï¼Œéœ€è¦ç¡®ä¿ç›®å½•å¯¹æ‰€æœ‰ç”¨æˆ·å¯å†™
          
          # åˆ›å»º .zap ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p .zap/work
          
          # è®¾ç½®å·¥ä½œç›®å½•æƒé™ï¼ˆé€’å½’è®¾ç½®æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ï¼‰
          # ä½¿ç”¨ sudo å¦‚æœå¯ç”¨ï¼Œå¦åˆ™ä½¿ç”¨æ™®é€š chmod
          if command -v sudo &> /dev/null; then
            sudo chmod -R 777 . || chmod -R 777 . || true
            sudo chown -R $USER:$USER . || true
          else
            chmod -R 777 . || true
          fi
          
          # ç¡®ä¿è§„åˆ™æ–‡ä»¶å¯è¯»
          chmod 644 .zap/rules.tsv || true
          
          # åˆ›å»º ZAP é…ç½®æ–‡ä»¶ç›®å½•å¹¶è®¾ç½®æƒé™
          mkdir -p .zap
          chmod -R 777 .zap || true
          
          # é¢„å…ˆåˆ›å»ºå¯èƒ½éœ€è¦çš„æ–‡ä»¶å¹¶è®¾ç½®æƒé™
          touch zap.yaml zap.yaml.bak 2>/dev/null || true
          chmod 666 zap.yaml zap.yaml.bak 2>/dev/null || true
          
          # éªŒè¯æƒé™è®¾ç½®
          echo "å½“å‰å·¥ä½œç›®å½•æƒé™:"
          ls -la . | head -10
          echo ""
          echo ".zap ç›®å½•æƒé™:"
          ls -la .zap/ 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"

      - name: OWASP ZAP baseline scan (user-service)
        continue-on-error: true
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8001'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -m 5'  # ç§»é™¤ -Iï¼Œä½¿ç”¨é»˜è®¤çš„ Automation Framework
          fail_action: false
          allow_issue_writing: false
          # æ³¨æ„ï¼šä¸è®¾ç½® artifact_nameï¼Œè®© action ä½¿ç”¨é»˜è®¤è¡Œä¸ºï¼ˆå¯èƒ½ä¼šå¤±è´¥ï¼Œä½†ä¸å½±å“åç»­æ­¥éª¤ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate ZAP JSON summary
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          
          if os.path.exists('report_json.json'):
              try:
                  with open('report_json.json', 'r', encoding='utf-8') as f:
                      data = json.load(f)
                  
                  # è§£æ ZAP JSON æŠ¥å‘Š
                  site = data.get('site', [])
                  total_alerts = 0
                  alerts_by_severity = {'High': 0, 'Medium': 0, 'Low': 0, 'Informational': 0}
                  alerts_list = []
                  
                  for site_item in site:
                      alerts = site_item.get('alerts', [])
                      total_alerts += len(alerts)
                      
                      for alert in alerts:
                          severity = alert.get('riskcode', 'Informational')
                          severity_map = {'3': 'High', '2': 'Medium', '1': 'Low', '0': 'Informational'}
                          severity_name = severity_map.get(str(severity), 'Informational')
                          alerts_by_severity[severity_name] = alerts_by_severity.get(severity_name, 0) + 1
                          
                          alerts_list.append({
                              'name': alert.get('name', 'N/A'),
                              'risk': severity_name,
                              'confidence': alert.get('confidence', 'N/A'),
                              'url': alert.get('url', 'N/A'),
                              'description': alert.get('desc', 'N/A')[:200]
                          })
                  
                  # ç”Ÿæˆæ±‡æ€» HTML
                  html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ZAP Security Scan Summary</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; }}
                  .container {{ max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #f8f9fa; }}
                  .stat-card {{ background: white; padding: 20px; border-radius: 6px; border-left: 4px solid #667eea; }}
                  .stat-card.high {{ border-left-color: #dc3545; }}
                  .stat-card.medium {{ border-left-color: #fd7e14; }}
                  .stat-card.low {{ border-left-color: #ffc107; }}
                  .stat-card.info {{ border-left-color: #6c757d; }}
                  .stat-number {{ font-size: 32px; font-weight: bold; margin-bottom: 5px; }}
                  .stat-label {{ color: #6c757d; font-size: 14px; }}
                  .alerts-table {{ width: 100%; border-collapse: collapse; }}
                  .alerts-table th {{ background: #495057; color: white; padding: 12px; text-align: left; font-weight: 600; }}
                  .alerts-table td {{ padding: 12px; border-bottom: 1px solid #e9ecef; }}
                  .alerts-table tr:hover {{ background: #f8f9fa; }}
                  .risk-badge {{ display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }}
                  .risk-high {{ background: #dc3545; color: white; }}
                  .risk-medium {{ background: #fd7e14; color: white; }}
                  .risk-low {{ background: #ffc107; color: #212529; }}
                  .risk-info {{ background: #6c757d; color: white; }}
                  .url {{ font-family: 'Courier New', monospace; font-size: 12px; color: #667eea; word-break: break-all; }}
                  .content {{ padding: 20px; }}
                  .no-alerts {{ text-align: center; padding: 40px; color: #28a745; font-size: 18px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>ğŸ”’ OWASP ZAP Security Scan Summary</h1>
                      <p>Total Alerts: {total_alerts}</p>
                  </header>
                  
                  <div class="summary">
                      <div class="stat-card">
                          <div class="stat-number">{total_alerts}</div>
                          <div class="stat-label">Total Alerts</div>
                      </div>
                      <div class="stat-card high">
                          <div class="stat-number">{alerts_by_severity.get('High', 0)}</div>
                          <div class="stat-label">High Risk</div>
                      </div>
                      <div class="stat-card medium">
                          <div class="stat-number">{alerts_by_severity.get('Medium', 0)}</div>
                          <div class="stat-label">Medium Risk</div>
                      </div>
                      <div class="stat-card low">
                          <div class="stat-number">{alerts_by_severity.get('Low', 0)}</div>
                          <div class="stat-label">Low Risk</div>
                      </div>
                      <div class="stat-card info">
                          <div class="stat-number">{alerts_by_severity.get('Informational', 0)}</div>
                          <div class="stat-label">Informational</div>
                      </div>
                  </div>
                  
                  <div class="content">
          """
                  
                  if alerts_list:
                      html += """
                      <table class="alerts-table">
                          <thead>
                              <tr>
                                  <th>Alert Name</th>
                                  <th>Risk Level</th>
                                  <th>Confidence</th>
                                  <th>URL</th>
                                  <th>Description</th>
                              </tr>
                          </thead>
                          <tbody>
                      """
                      
                      for alert in alerts_list:
                          risk_class = f'risk-{alert["risk"].lower()}'
                          html += f"""
                              <tr>
                                  <td><strong>{alert['name']}</strong></td>
                                  <td><span class="risk-badge {risk_class}">{alert['risk']}</span></td>
                                  <td>{alert['confidence']}</td>
                                  <td class="url">{alert['url'][:100]}{'...' if len(alert['url']) > 100 else ''}</td>
                                  <td>{alert['description']}</td>
                              </tr>
                          """
                      
                      html += """
                          </tbody>
                      </table>
                      """
                  else:
                      html += '<div class="no-alerts">âœ… No security alerts found!</div>'
                  
                  html += """
                  </div>
              </div>
          </body>
          </html>
          """
                  
                  with open('zap-summary.html', 'w', encoding='utf-8') as f:
                      f.write(html)
                  print("âœ… Generated zap-summary.html")
              except Exception as e:
                  print(f"âš ï¸  Error processing ZAP JSON: {e}")
          PYTHON_SCRIPT

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md
            zap-summary.html
          if-no-files-found: ignore
          retention-days: 7

  # æ€§èƒ½æµ‹è¯•ï¼ˆPRï¼‰ï¼Œä½¿ç”¨æ¥è¿‘ç”Ÿäº§çš„è¿›ç¨‹æ¨¡å‹
  perf:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Launch perf env (gunicorn)
        run: docker compose -f docker-compose.perf.yml up -d --build

      - name: Wait for services to be ready
        run: |
          echo "ç­‰å¾…æ€§èƒ½æµ‹è¯•ç¯å¢ƒæœåŠ¡å¯åŠ¨..."
          for i in {1..90}; do
            if curl -fsS http://localhost:8001/api/v1/health/ > /dev/null 2>&1 && \
               curl -fsS http://localhost:8002/api/v1/health/ > /dev/null 2>&1 && \
               curl -fsS http://localhost:8003/api/v1/health/ > /dev/null 2>&1; then
              echo "âœ… æ‰€æœ‰æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
              # é¢å¤–ç­‰å¾…å‡ ç§’ç¡®ä¿æœåŠ¡å®Œå…¨å°±ç»ª
              sleep 5
              echo "âœ… æ‰€æœ‰æœåŠ¡å·²å°±ç»ª"
              break
            fi
            echo "ç­‰å¾…ä¸­... ($i/90)"
            sleep 2
          done
          
          # éªŒè¯æœåŠ¡æ˜¯å¦çœŸçš„å¯ç”¨ï¼ˆå¤šæ¬¡å°è¯•ï¼‰
          echo "éªŒè¯æœåŠ¡å¯ç”¨æ€§..."
          for i in {1..5}; do
            if curl -fsS http://localhost:8001/api/v1/health/ && \
               curl -fsS http://localhost:8002/api/v1/health/ && \
               curl -fsS http://localhost:8003/api/v1/health/; then
              echo "âœ… æ‰€æœ‰æœåŠ¡éªŒè¯é€šè¿‡"
              exit 0
            fi
            echo "éªŒè¯å¤±è´¥ï¼Œé‡è¯•... ($i/5)"
            sleep 2
          done
          
          echo "âŒ æœåŠ¡éªŒè¯å¤±è´¥"
          curl -fsS http://localhost:8001/api/v1/health/ || echo "âŒ user-service æœªå°±ç»ª"
          curl -fsS http://localhost:8002/api/v1/health/ || echo "âŒ activity-service æœªå°±ç»ª"
          curl -fsS http://localhost:8003/api/v1/health/ || echo "âŒ notification-service æœªå°±ç»ª"
          exit 1

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Verify target endpoint before k6 test
        continue-on-error: true
        run: |
          echo "éªŒè¯ k6 æµ‹è¯•ç›®æ ‡ç«¯ç‚¹..."
          # éªŒè¯ activity-service ç«¯ç‚¹ï¼ˆk6 æµ‹è¯•çš„ç›®æ ‡ï¼‰
          for i in {1..10}; do
            if curl -fsS http://localhost:8002/api/v1/activities/ > /dev/null 2>&1; then
              echo "âœ… activity-service ç«¯ç‚¹éªŒè¯æˆåŠŸ"
              # é¢å¤–æµ‹è¯•ä¸€æ¬¡ç¡®ä¿ç¨³å®š
              sleep 2
              curl -fsS http://localhost:8002/api/v1/activities/ > /dev/null 2>&1 && echo "âœ… ç«¯ç‚¹ç¨³å®šï¼Œå¯ä»¥å¼€å§‹ k6 æµ‹è¯•" && exit 0
            fi
            echo "ç«¯ç‚¹éªŒè¯å¤±è´¥ï¼Œé‡è¯•... ($i/10)"
            sleep 2
          done
          echo "âš ï¸  ç«¯ç‚¹éªŒè¯å¤±è´¥ï¼Œä½†ç»§ç»­è¿è¡Œ k6 æµ‹è¯•"

      - name: k6 load test
        continue-on-error: true
        run: |
          echo "å¼€å§‹ k6 è´Ÿè½½æµ‹è¯•..."
          # æ·»åŠ é‡è¯•æœºåˆ¶ï¼Œå¦‚æœç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
          # ä½¿ç”¨ summary è¾“å‡ºæ ¼å¼ï¼Œå®ƒä¼šåœ¨æµ‹è¯•ç»“æŸæ—¶è¾“å‡ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æŒ‡æ ‡çš„ JSON å¯¹è±¡
          k6 run --out json=k6-results.json --summary-export=k6-summary.json tests/perf/k6-load.js || {
            echo "âš ï¸  k6 æµ‹è¯•å¤±è´¥ï¼Œç­‰å¾… 10 ç§’åé‡è¯•..."
            sleep 10
            k6 run --out json=k6-results.json --summary-export=k6-summary.json tests/perf/k6-load.js || echo "âš ï¸  k6 æµ‹è¯•é‡è¯•åä»ç„¶å¤±è´¥"
          }
          # éªŒè¯è¾“å‡ºæ–‡ä»¶
          if [ -f k6-summary.json ]; then
            echo "âœ… k6 summary æ–‡ä»¶å·²ç”Ÿæˆ"
          fi
          if [ -f k6-results.json ]; then
            echo "âœ… k6 results æ–‡ä»¶å·²ç”Ÿæˆ"
            # æ˜¾ç¤ºæ–‡ä»¶å¤§å°å’Œå‰å‡ è¡Œï¼Œç”¨äºè°ƒè¯•
            echo "æ–‡ä»¶å¤§å°: $(wc -c < k6-results.json) bytes"
            echo "å‰ 3 è¡Œ:"
            head -n 3 k6-results.json || echo "æ— æ³•è¯»å–æ–‡ä»¶"
          fi

      - name: Generate k6 summary
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          
          k6_files = ['k6-summary.json', 'k6-results.json']  # ä¼˜å…ˆä½¿ç”¨ summaryï¼Œå› ä¸ºå®ƒæ›´å¯é 
          k6_data = None
          used_file = None
          
          for k6_file in k6_files:
              if os.path.exists(k6_file):
                  file_size = os.path.getsize(k6_file)
                  print(f"ğŸ“„ æ£€æŸ¥æ–‡ä»¶: {k6_file} (å¤§å°: {file_size} bytes)")
                  
                  try:
                      with open(k6_file, 'r', encoding='utf-8') as f:
                          content = f.read().strip()
                      
                      if not content:
                          print(f"âš ï¸  {k6_file} æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡")
                          continue
                      
                      # k6 çš„ JSON è¾“å‡ºå¯èƒ½æ˜¯ JSONL æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼‰
                      # å°è¯•è§£æä¸ºå•ä¸ª JSON å¯¹è±¡
                      try:
                          k6_data = json.loads(content)
                          if 'metrics' in k6_data:
                              used_file = k6_file
                              print(f"âœ… æˆåŠŸè§£æ {k6_file} (å•ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å« metrics)")
                              break
                          else:
                              print(f"âš ï¸  {k6_file} æ˜¯æœ‰æ•ˆçš„ JSONï¼Œä½†ä¸åŒ…å« metrics å­—æ®µ")
                              k6_data = None
                      except json.JSONDecodeError as e:
                          print(f"âš ï¸  {k6_file} ä¸æ˜¯å•ä¸ª JSON å¯¹è±¡ï¼Œå°è¯•ä½œä¸º JSONL è§£æ...")
                          # å¦‚æœæ˜¯ JSONL æ ¼å¼ï¼Œè¯»å–æ‰€æœ‰è¡Œ
                          lines = [line.strip() for line in content.split('\n') if line.strip()]
                          print(f"   å‘ç° {len(lines)} è¡Œæ•°æ®")
                          
                          if lines:
                              # ä»åå¾€å‰æŸ¥æ‰¾åŒ…å« metrics çš„è¡Œ
                              found = False
                              for i, line in enumerate(reversed(lines)):
                                  try:
                                      data = json.loads(line)
                                      if 'metrics' in data:
                                          k6_data = data
                                          used_file = k6_file
                                          print(f"âœ… æˆåŠŸè§£æ {k6_file} (JSONL æ ¼å¼ï¼Œç¬¬ {len(lines)-i} è¡ŒåŒ…å« metrics)")
                                          found = True
                                          break
                                  except json.JSONDecodeError:
                                      continue
                              
                              if not found and lines:
                                  # å¦‚æœæ²¡æ‰¾åˆ°åŒ…å« metrics çš„è¡Œï¼Œå°è¯•è§£ææœ€åä¸€è¡Œ
                                  try:
                                      k6_data = json.loads(lines[-1])
                                      used_file = k6_file
                                      print(f"âœ… æˆåŠŸè§£æ {k6_file} (JSONL æ ¼å¼ï¼Œä½¿ç”¨æœ€åä¸€è¡Œ)")
                                  except json.JSONDecodeError as e2:
                                      print(f"âš ï¸  æ— æ³•è§£ææœ€åä¸€è¡Œ: {e2}")
                      
                      if k6_data and 'metrics' in k6_data:
                          break
                      
                  except Exception as e:
                      print(f"âš ï¸  è¯»å– {k6_file} æ—¶å‡ºé”™: {e}")
                      import traceback
                      traceback.print_exc()
          
          if k6_data and 'metrics' in k6_data:
              try:
                  # è§£æ k6 JSON ç»“æœ
                  metrics = k6_data.get('metrics', {})
                  
                  # è°ƒè¯•ï¼šæ‰“å°å®Œæ•´çš„æ•°æ®ç»“æ„ï¼ˆå‰1000ä¸ªå­—ç¬¦ï¼‰
                  import json
                  debug_str = json.dumps(k6_data, indent=2)[:2000]  # åªæ‰“å°å‰2000ä¸ªå­—ç¬¦
                  print(f"ğŸ“Š k6_data ç»“æ„ï¼ˆå‰2000å­—ç¬¦ï¼‰:\n{debug_str}")
                  print(f"ğŸ“Š Metrics é”®: {list(metrics.keys())[:20]}")  # æ˜¾ç¤ºå‰20ä¸ªé”®
                  
                  # æå–å…³é”®æŒ‡æ ‡
                  http_reqs = metrics.get('http_reqs', {})
                  http_req_duration = metrics.get('http_req_duration', {})
                  http_req_failed = metrics.get('http_req_failed', {})
                  
                  # è°ƒè¯•ï¼šæ‰“å°æŒ‡æ ‡ç»“æ„ï¼ˆå®Œæ•´ï¼‰
                  print(f"ğŸ“Š http_reqs ç±»å‹: {type(http_reqs)}")
                  if http_reqs:
                      print(f"ğŸ“Š http_reqs é”®: {list(http_reqs.keys())}")
                      print(f"ğŸ“Š http_reqs å†…å®¹: {json.dumps(http_reqs, indent=2)[:500]}")
                      if 'values' in http_reqs and isinstance(http_reqs['values'], dict):
                          print(f"ğŸ“Š http_reqs.values é”®: {list(http_reqs['values'].keys())}")
                      if 'count' in http_reqs:
                          print(f"ğŸ“Š http_reqs.count = {http_reqs['count']}")
                  
                  print(f"ğŸ“Š http_req_duration ç±»å‹: {type(http_req_duration)}")
                  if http_req_duration:
                      print(f"ğŸ“Š http_req_duration é”®: {list(http_req_duration.keys())}")
                      if 'avg' in http_req_duration:
                          print(f"ğŸ“Š http_req_duration.avg = {http_req_duration['avg']}")
                  
                  # k6 summary-export æ ¼å¼ï¼šmetrics.http_reqs.values.count æˆ– metrics.http_reqs.count
                  # k6 JSON output æ ¼å¼ï¼šmetrics.http_reqs.values.count
                  # éœ€è¦æ£€æŸ¥å®é™…çš„æ•°æ®ç»“æ„
                  total_requests = 0
                  if http_reqs:
                      # å°è¯•å¤šç§å¯èƒ½çš„è·¯å¾„
                      if isinstance(http_reqs, dict):
                          # æ–¹å¼1: ç›´æ¥ count (summary-export å¯èƒ½æ ¼å¼)
                          if 'count' in http_reqs:
                              total_requests = http_reqs['count']
                              print(f"ğŸ“Š æ–¹å¼1: http_reqs.count = {total_requests}")
                          # æ–¹å¼2: values.count (JSON output å’Œ summary-export å¸¸ç”¨æ ¼å¼)
                          elif 'values' in http_reqs:
                              if isinstance(http_reqs['values'], dict):
                                  total_requests = http_reqs['values'].get('count', 0)
                                  print(f"ğŸ“Š æ–¹å¼2: http_reqs.values.count = {total_requests}")
                              elif isinstance(http_reqs['values'], list) and len(http_reqs['values']) > 0:
                                  # å¦‚æœ values æ˜¯åˆ—è¡¨ï¼Œå¯èƒ½æ˜¯æ—¶é—´åºåˆ—æ•°æ®
                                  total_requests = len(http_reqs['values'])
                                  print(f"ğŸ“Š æ–¹å¼3: http_reqs.values (åˆ—è¡¨é•¿åº¦) = {total_requests}")
                          # æ–¹å¼3: ä» rate è®¡ç®—ï¼ˆå¦‚æœ rate å’Œæ—¶é—´çª—å£å­˜åœ¨ï¼‰
                          elif 'rate' in http_reqs:
                              # å°è¯•ä» rate ä¼°ç®—ï¼Œä½†è¿™ä¸æ˜¯å‡†ç¡®çš„æ–¹æ³•
                              print(f"âš ï¸  åªæœ‰ rate å­—æ®µï¼Œæ— æ³•å‡†ç¡®è®¡ç®— count")
                              total_requests = 0
                          else:
                              # æ‰“å°å®Œæ•´ç»“æ„ä»¥ä¾¿è°ƒè¯•
                              print(f"âš ï¸  æ— æ³•ä» http_reqs æå– countï¼Œå®Œæ•´ç»“æ„: {json.dumps(http_reqs, indent=2)[:500]}")
                      else:
                          print(f"âš ï¸  http_reqs ä¸æ˜¯å­—å…¸ç±»å‹: {type(http_reqs)}")
                  else:
                      print("âš ï¸  http_reqs ä¸å­˜åœ¨æˆ–ä¸ºç©º")
                  
                  print(f"ğŸ“Š æœ€ç»ˆ total_requests = {total_requests}")
                  
                  # æå–å“åº”æ—¶é—´æŒ‡æ ‡
                  # k6 çš„æ—¶é—´å•ä½ï¼šsummary-export é€šå¸¸æ˜¯æ¯«ç§’ï¼ŒJSON output æ˜¯å¾®ç§’
                  def convert_to_ms(value):
                      """å°†æ—¶é—´å€¼è½¬æ¢ä¸ºæ¯«ç§’"""
                      if value == 0:
                          return 0
                      # å¦‚æœå€¼å¾ˆå¤§ï¼ˆ> 10000ï¼‰ï¼Œå¯èƒ½æ˜¯å¾®ç§’ï¼Œè½¬æ¢ä¸ºæ¯«ç§’
                      if value > 10000:
                          return value / 1000
                      # å¦‚æœå€¼éå¸¸å¤§ï¼ˆ> 1000000ï¼‰ï¼Œå¯èƒ½æ˜¯çº³ç§’ï¼Œè½¬æ¢ä¸ºæ¯«ç§’
                      elif value > 1000000:
                          return value / 1000000
                      # å¦åˆ™å‡è®¾å·²ç»æ˜¯æ¯«ç§’
                      return value
                  
                  # æå–å“åº”æ—¶é—´æŒ‡æ ‡
                  avg_duration = min_duration = max_duration = p95_duration = p99_duration = 0
                  if http_req_duration and isinstance(http_req_duration, dict):
                      # å°è¯•å¤šç§å¯èƒ½çš„è·¯å¾„
                      if 'values' in http_req_duration and isinstance(http_req_duration['values'], dict):
                          # æœ€å¸¸è§æ ¼å¼ï¼švalues å­—å…¸
                          values = http_req_duration['values']
                          avg_duration = convert_to_ms(values.get('avg', 0))
                          min_duration = convert_to_ms(values.get('min', 0))
                          max_duration = convert_to_ms(values.get('max', 0))
                          p95_duration = convert_to_ms(values.get('p(95)', values.get('p95', 0)))
                          p99_duration = convert_to_ms(values.get('p(99)', values.get('p99', 0)))
                          print(f"ğŸ“Š ä½¿ç”¨ values æ ¼å¼æå–å“åº”æ—¶é—´: avg={avg_duration:.2f}ms")
                      elif 'avg' in http_req_duration:
                          # ç›´æ¥å­—æ®µæ ¼å¼
                          avg_duration = convert_to_ms(http_req_duration.get('avg', 0))
                          min_duration = convert_to_ms(http_req_duration.get('min', 0))
                          max_duration = convert_to_ms(http_req_duration.get('max', 0))
                          p95_duration = convert_to_ms(http_req_duration.get('p(95)', http_req_duration.get('p95', 0)))
                          p99_duration = convert_to_ms(http_req_duration.get('p(99)', http_req_duration.get('p99', 0)))
                          print(f"ğŸ“Š ä½¿ç”¨ç›´æ¥å­—æ®µæ ¼å¼æå–å“åº”æ—¶é—´: avg={avg_duration:.2f}ms")
                      else:
                          print(f"âš ï¸  æ— æ³•ä» http_req_duration æå–æ•°æ®ï¼Œç»“æ„: {list(http_req_duration.keys())}")
                          print(f"ğŸ“Š http_req_duration å†…å®¹: {json.dumps(http_req_duration, indent=2)[:500]}")
                  else:
                      print(f"âš ï¸  http_req_duration ä¸å­˜åœ¨æˆ–ç±»å‹é”™è¯¯: {type(http_req_duration)}")
                  
                  # æå–å¤±è´¥ç‡
                  failed_rate = 0
                  if http_req_failed and isinstance(http_req_failed, dict):
                      # å°è¯•å¤šç§å¯èƒ½çš„è·¯å¾„
                      if 'values' in http_req_failed and isinstance(http_req_failed['values'], dict):
                          # values æ ¼å¼
                          failed_rate = http_req_failed['values'].get('rate', 0) * 100
                          print(f"ğŸ“Š ä½¿ç”¨ values æ ¼å¼æå–å¤±è´¥ç‡: {failed_rate:.2f}%")
                      elif 'rate' in http_req_failed:
                          # ç›´æ¥å­—æ®µæ ¼å¼
                          failed_rate = http_req_failed['rate'] * 100
                          print(f"ğŸ“Š ä½¿ç”¨ç›´æ¥å­—æ®µæ ¼å¼æå–å¤±è´¥ç‡: {failed_rate:.2f}%")
                      else:
                          print(f"âš ï¸  æ— æ³•ä» http_req_failed æå– rateï¼Œç»“æ„: {list(http_req_failed.keys())}")
                          print(f"ğŸ“Š http_req_failed å†…å®¹: {json.dumps(http_req_failed, indent=2)[:500]}")
                  else:
                      print(f"âš ï¸  http_req_failed ä¸å­˜åœ¨æˆ–ç±»å‹é”™è¯¯: {type(http_req_failed)}")
                  
                  # è°ƒè¯•è¾“å‡º
                  print(f"ğŸ“Š è§£æç»“æœ:")
                  print(f"   Total Requests: {total_requests}")
                  print(f"   Avg Duration: {avg_duration:.2f}ms")
                  print(f"   Failed Rate: {failed_rate:.2f}%")
                  
                  # ç”Ÿæˆ HTML æ±‡æ€»
                  html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>k6 Performance Test Summary</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; }}
                  .container {{ max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #f8f9fa; }}
                  .stat-card {{ background: white; padding: 20px; border-radius: 6px; border-left: 4px solid #667eea; }}
                  .stat-number {{ font-size: 32px; font-weight: bold; margin-bottom: 5px; }}
                  .stat-label {{ color: #6c757d; font-size: 14px; }}
                  .content {{ padding: 20px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>âš¡ k6 Performance Test Summary</h1>
                      <p>Total Requests: {total_requests:,}</p>
                  </header>
                  
                  <div class="summary">
                      <div class="stat-card">
                          <div class="stat-number">{total_requests:,}</div>
                          <div class="stat-label">Total Requests</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{avg_duration:.0f}ms</div>
                          <div class="stat-label">Avg Duration</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{min_duration:.0f}ms</div>
                          <div class="stat-label">Min Duration</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{max_duration:.0f}ms</div>
                          <div class="stat-label">Max Duration</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{p95_duration:.0f}ms</div>
                          <div class="stat-label">P95 Duration</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{p99_duration:.0f}ms</div>
                          <div class="stat-label">P99 Duration</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{failed_rate:.2f}%</div>
                          <div class="stat-label">Failure Rate</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{(100 - failed_rate):.2f}%</div>
                          <div class="stat-label">Success Rate</div>
                      </div>
                  </div>
              </div>
          </body>
          </html>
          """
                  
                  with open('k6-summary.html', 'w', encoding='utf-8') as f:
                      f.write(html)
                  print("âœ… Generated k6-summary.html")
              except Exception as e:
                  print(f"âš ï¸  Error processing k6 results: {e}")
          else:
              print("âš ï¸  k6 results file not found, skipping summary generation")
          PYTHON_SCRIPT

      - name: Install JMeter
        run: |
          # å¸è½½æ—§ç‰ˆæœ¬çš„ JMeterï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          sudo apt-get remove -y jmeter 2>/dev/null || true
          
          # å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ JMeter
          echo "å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ JMeter..."
          JMETER_VERSION="5.6.2"
          cd /tmp
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
          tar xzf apache-jmeter-${JMETER_VERSION}.tgz
          sudo mv apache-jmeter-${JMETER_VERSION} /opt/jmeter
          sudo ln -sf /opt/jmeter/bin/jmeter /usr/local/bin/jmeter
          sudo ln -sf /opt/jmeter/bin/jmeter.sh /usr/local/bin/jmeter.sh
          echo "âœ… JMeter ${JMETER_VERSION} å®‰è£…å®Œæˆ"
          
          # éªŒè¯å®‰è£…
          /opt/jmeter/bin/jmeter --version || /usr/local/bin/jmeter --version

      - name: Configure JMeter security settings
        run: |
          # åˆ›å»º JMeter é…ç½®æ–‡ä»¶ç›®å½•
          mkdir -p ~/.jmeter
          mkdir -p /tmp/jmeter-config
          
          # åˆ›å»ºç”¨æˆ·é…ç½®æ–‡ä»¶
          cat > ~/.jmeter/jmeter.properties << 'EOF'
          # å…è®¸ååºåˆ—åŒ– ScriptWrapper ç­‰ç±»ï¼ˆç”¨äºæ—  GUI æ¨¡å¼ï¼‰
          xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapper
          xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean
          xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean2
          xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean3
          EOF
          echo "âœ… JMeter ç”¨æˆ·å®‰å…¨é…ç½®å·²åˆ›å»º"
          
          # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
          cat > /tmp/jmeter-config/jmeter.properties << 'EOF'
          xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapper
          xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean
          xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean2
          xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean3
          EOF
          echo "âœ… JMeter ä¸´æ—¶é…ç½®æ–‡ä»¶å·²åˆ›å»º"
          
          # å¦‚æœä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„ JMeterï¼Œä¹Ÿæ›´æ–°ç³»ç»Ÿé…ç½®
          if [ -f /opt/jmeter/bin/jmeter.properties ]; then
            echo "xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapper" | sudo tee -a /opt/jmeter/bin/jmeter.properties
            echo "xstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean" | sudo tee -a /opt/jmeter/bin/jmeter.properties
            echo "âœ… å·²æ›´æ–° JMeter ç³»ç»Ÿé…ç½®æ–‡ä»¶"
          fi

      - name: Run JMeter plan
        continue-on-error: true
        run: |
          # è¿è¡Œ JMeter æµ‹è¯•å¹¶ç”Ÿæˆ JTL æ–‡ä»¶
          echo "å¼€å§‹è¿è¡Œ JMeter æµ‹è¯•..."
          echo "JMeter è·¯å¾„: $(which jmeter || echo '/opt/jmeter/bin/jmeter')"
          
          # ç¡®å®š JMeter å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
          JMETER_BIN="/opt/jmeter/bin/jmeter"
          if [ ! -f "$JMETER_BIN" ]; then
            JMETER_BIN="jmeter"
          fi
          
          # éªŒè¯ JMeter ç‰ˆæœ¬
          $JMETER_BIN --version || echo "âš ï¸  æ— æ³•è·å– JMeter ç‰ˆæœ¬"
          
          # ä½¿ç”¨ç³»ç»Ÿå±æ€§é…ç½®å®‰å…¨è®¾ç½®ï¼ˆæœ€å¯é çš„æ–¹æ³•ï¼‰
          echo "ä½¿ç”¨ç³»ç»Ÿå±æ€§é…ç½®å®‰å…¨è®¾ç½®..."
          # æ³¨æ„ï¼š--suppressJMeterWarnings åœ¨æŸäº›ç‰ˆæœ¬ä¸­ä¸å¯ç”¨ï¼Œç§»é™¤å®ƒ
          $JMETER_BIN -n -t tests/perf/jmeter_test.jmx -l jmeter.jtl \
            -Jxstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapper \
            -Jxstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean \
            -Jxstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean2 \
            -Jxstream.security.allowXStreamType=org.apache.jmeter.save.ScriptWrapperBean3 \
            2>&1 | grep -v "WARN StatusConsoleListener" || true
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆ JTL æ–‡ä»¶
          if [ ! -f jmeter.jtl ] || [ ! -s jmeter.jtl ]; then
            echo "âš ï¸  ç¬¬ä¸€æ¬¡å°è¯•å¤±è´¥ï¼Œä½¿ç”¨æ›´å®½æ¾çš„å®‰å…¨è®¾ç½®..."
            # å›é€€æ–¹æ¡ˆï¼šå…è®¸æ‰€æœ‰ç±»å‹ï¼ˆä¸æ¨èï¼Œä½†ä½œä¸ºæœ€åæ‰‹æ®µï¼‰
            $JMETER_BIN -n -t tests/perf/jmeter_test.jmx -l jmeter.jtl \
              -Jxstream.security.allowXStreamType=* \
              2>&1 | grep -v "WARN StatusConsoleListener" || true
            
            # å†æ¬¡æ£€æŸ¥
            if [ ! -f jmeter.jtl ] || [ ! -s jmeter.jtl ]; then
              echo "âš ï¸  JMeter æµ‹è¯•å®Œå…¨å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼š"
              $JMETER_BIN -n -t tests/perf/jmeter_test.jmx -l jmeter.jtl 2>&1 | grep -v "WARN StatusConsoleListener" || true
            fi
          fi
          
          # å¦‚æœ JTL æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼Œç”Ÿæˆ HTML æŠ¥å‘Š
          if [ -f jmeter.jtl ] && [ -s jmeter.jtl ]; then
            echo "âœ… jmeter.jtl æ–‡ä»¶å·²ç”Ÿæˆï¼Œç”Ÿæˆ HTML æŠ¥å‘Š..."
            jmeter -g jmeter.jtl -o jmeter-report || echo "âš ï¸  HTML æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          else
            echo "âš ï¸  jmeter.jtl æ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©ºï¼Œè·³è¿‡ HTML æŠ¥å‘Šç”Ÿæˆ"
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä½†ä¸ºç©º
            if [ -f jmeter.jtl ] && [ ! -s jmeter.jtl ]; then
              echo "âš ï¸  jmeter.jtl æ–‡ä»¶å­˜åœ¨ä½†ä¸ºç©º"
            fi
          fi

      - name: Generate JMeter JTL summary
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import csv
          import os
          import statistics
          
          if os.path.exists('jmeter.jtl'):
              try:
                  # è§£æ JMeter JTL (CSV æ ¼å¼)
                  results = []
                  with open('jmeter.jtl', 'r', encoding='utf-8') as f:
                      reader = csv.DictReader(f)
                      for row in reader:
                          if 'timeStamp' in row and 'elapsed' in row:
                              try:
                                  elapsed = int(row.get('elapsed', 0))
                                  success = row.get('success', 'true').lower() == 'true'
                                  label = row.get('label', 'N/A')
                                  results.append({
                                      'label': label,
                                      'elapsed': elapsed,
                                      'success': success
                                  })
                              except ValueError:
                                  continue
                  
                  if results:
                      total_requests = len(results)
                      success_count = sum(1 for r in results if r['success'])
                      failure_count = total_requests - success_count
                      response_times = [r['elapsed'] for r in results]
                      avg_response = statistics.mean(response_times) if response_times else 0
                      min_response = min(response_times) if response_times else 0
                      max_response = max(response_times) if response_times else 0
                      median_response = statistics.median(response_times) if response_times else 0
                      
                      # æŒ‰æ ‡ç­¾åˆ†ç»„ç»Ÿè®¡
                      label_stats = {}
                      for r in results:
                          label = r['label']
                          if label not in label_stats:
                              label_stats[label] = {'total': 0, 'success': 0, 'times': []}
                          label_stats[label]['total'] += 1
                          if r['success']:
                              label_stats[label]['success'] += 1
                          label_stats[label]['times'].append(r['elapsed'])
                      
                      # ç”Ÿæˆ HTML æ±‡æ€»
                      html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>JMeter Performance Test Summary</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; padding: 20px; }}
                  .container {{ max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }}
                  header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }}
                  h1 {{ font-size: 28px; margin-bottom: 10px; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #f8f9fa; }}
                  .stat-card {{ background: white; padding: 20px; border-radius: 6px; border-left: 4px solid #667eea; }}
                  .stat-card.success {{ border-left-color: #28a745; }}
                  .stat-card.failure {{ border-left-color: #dc3545; }}
                  .stat-number {{ font-size: 32px; font-weight: bold; margin-bottom: 5px; }}
                  .stat-label {{ color: #6c757d; font-size: 14px; }}
                  .stats-table {{ width: 100%; border-collapse: collapse; margin-top: 20px; }}
                  .stats-table th {{ background: #495057; color: white; padding: 12px; text-align: left; font-weight: 600; }}
                  .stats-table td {{ padding: 12px; border-bottom: 1px solid #e9ecef; }}
                  .stats-table tr:hover {{ background: #f8f9fa; }}
                  .content {{ padding: 20px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>âš¡ JMeter Performance Test Summary</h1>
                      <p>Total Requests: {total_requests}</p>
                  </header>
                  
                  <div class="summary">
                      <div class="stat-card">
                          <div class="stat-number">{total_requests:,}</div>
                          <div class="stat-label">Total Requests</div>
                      </div>
                      <div class="stat-card success">
                          <div class="stat-number">{success_count:,}</div>
                          <div class="stat-label">Successful</div>
                      </div>
                      <div class="stat-card failure">
                          <div class="stat-number">{failure_count:,}</div>
                          <div class="stat-label">Failed</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{avg_response:.0f}ms</div>
                          <div class="stat-label">Avg Response Time</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{median_response:.0f}ms</div>
                          <div class="stat-label">Median Response Time</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{min_response}ms</div>
                          <div class="stat-label">Min Response Time</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{max_response}ms</div>
                          <div class="stat-label">Max Response Time</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">{(success_count/total_requests*100) if total_requests > 0 else 0:.1f}%</div>
                          <div class="stat-label">Success Rate</div>
                      </div>
                  </div>
                  
                  <div class="content">
                      <h2>Performance by Endpoint</h2>
                      <table class="stats-table">
                          <thead>
                              <tr>
                                  <th>Endpoint</th>
                                  <th>Total Requests</th>
                                  <th>Successful</th>
                                  <th>Failed</th>
                                  <th>Avg Response (ms)</th>
                                  <th>Min (ms)</th>
                                  <th>Max (ms)</th>
                                  <th>Success Rate</th>
                              </tr>
                          </thead>
                          <tbody>
          """
                      
                      for label, stats in sorted(label_stats.items()):
                          avg = statistics.mean(stats['times']) if stats['times'] else 0
                          min_time = min(stats['times']) if stats['times'] else 0
                          max_time = max(stats['times']) if stats['times'] else 0
                          success_rate = (stats['success'] / stats['total'] * 100) if stats['total'] > 0 else 0
                          
                          html += f"""
                              <tr>
                                  <td><strong>{label}</strong></td>
                                  <td>{stats['total']:,}</td>
                                  <td>{stats['success']:,}</td>
                                  <td>{stats['total'] - stats['success']:,}</td>
                                  <td>{avg:.0f}</td>
                                  <td>{min_time}</td>
                                  <td>{max_time}</td>
                                  <td>{success_rate:.1f}%</td>
                              </tr>
                          """
                      
                      html += """
                          </tbody>
                      </table>
                      <p style="margin-top: 20px; color: #6c757d;">
                          <strong>Note:</strong> For detailed analysis, see the full JMeter HTML report in <code>jmeter-report/</code>
                      </p>
                  </div>
              </div>
          </body>
          </html>
          """
                      
                      with open('jmeter-summary.html', 'w', encoding='utf-8') as f:
                          f.write(html)
                      print("âœ… Generated jmeter-summary.html")
              except Exception as e:
                  print(f"âš ï¸  Error processing JMeter JTL: {e}")
          else:
              print("âš ï¸  jmeter.jtl file not found, skipping summary generation")
          PYTHON_SCRIPT

      - name: List generated files
        if: always()
        run: |
          echo "=== Checking for performance test artifacts ==="
          echo "Current directory: $(pwd)"
          echo ""
          echo "k6 files:"
          ls -la k6*.json k6*.html 2>/dev/null || echo "No k6 files found"
          find . -name "k6*.json" -o -name "k6*.html" 2>/dev/null || echo "No k6 files found in any directory"
          echo ""
          echo "JMeter files:"
          ls -la jmeter.jtl jmeter-summary.html 2>/dev/null || echo "No JMeter files found"
          find . -name "jmeter.jtl" -o -name "jmeter-summary.html" 2>/dev/null || echo "No JMeter files found in any directory"
          echo ""
          echo "JMeter report directory:"
          if [ -d jmeter-report ]; then
            ls -la jmeter-report/ | head -20
          else
            echo "No jmeter-report directory found"
          fi

      - name: Upload k6 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf_results_k6
          path: |
            k6-results.json
            k6-summary.json
            k6-summary.html
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload JMeter artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf_results_jmeter
          path: |
            jmeter.jtl
            jmeter-summary.html
            jmeter-report/**
          if-no-files-found: ignore
          retention-days: 7

  # éƒ¨ç½²é˜¶æ®µ - æ¨é€åˆ°mainåˆ†æ”¯æ—¶è¿è¡Œ
  # 1. å‡†å¤‡å’Œæ„å»ºé•œåƒ
  prepare_and_build:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Prepare and build images
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² Volunteer Platform..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /home/Volunteer-website
            
            # æ›´æ–°ä»£ç 
            echo "ğŸ“¥ æ›´æ–°ä»£ç ..."
            git pull
            
            # æ„å»ºé•œåƒ
            echo "ğŸ”¨ æ„å»ºé•œåƒ..."
            docker compose build
            
            # æ£€æŸ¥ç°æœ‰é•œåƒ
            echo "ğŸ“‹ æ£€æŸ¥ç°æœ‰é•œåƒ..."
            docker images | grep jsrgzyc || echo "âš ï¸  æœªæ‰¾åˆ°é•œåƒ"
            
            echo "âœ… é•œåƒæ„å»ºå®Œæˆ"

  # 2. å¯¼å…¥é•œåƒåˆ° containerd
  import_images:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    needs: [prepare_and_build]
    steps:
      - name: Import images to containerd
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            echo "ğŸ“¦ å¯¼å…¥é•œåƒåˆ°containerd..."
            
            required_images=(
              "jsrgzyc/user-service:latest"
              "jsrgzyc/activity-service:latest"
              "jsrgzyc/notification-service:latest"
              "jsrgzyc/frontend:latest"
            )
            
            for image in "${required_images[@]}"; do
              image_name=$(echo $image | cut -d'/' -f2 | cut -d':' -f1)
              echo "å¯¼å…¥ $image_name..."
              if docker images | grep -q "$image"; then
                docker save $image | ctr -n k8s.io images import -
                echo "âœ… $image_name å¯¼å…¥æˆåŠŸ"
              else
                echo "âŒ $image é•œåƒä¸å­˜åœ¨"
                exit 1
              fi
            done
            
            # éªŒè¯é•œåƒå¯¼å…¥å®Œæˆ
            echo "ğŸ” éªŒè¯é•œåƒå¯¼å…¥çŠ¶æ€..."
            max_attempts=10
            attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "æ£€æŸ¥é•œåƒå¯¼å…¥çŠ¶æ€ (å°è¯• $attempt/$max_attempts)..."
              all_imported=true
              
              for image in "${required_images[@]}"; do
                if ctr -n k8s.io images list | grep -q "$image"; then
                  echo "âœ… $image å·²å¯¼å…¥"
                else
                  echo "â³ $image å°šæœªå¯¼å…¥ï¼Œç­‰å¾…ä¸­..."
                  all_imported=false
                fi
              done
              
              if [ "$all_imported" = true ]; then
                echo "âœ… æ‰€æœ‰é•œåƒå¯¼å…¥å®Œæˆï¼"
                break
              fi
              
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ é•œåƒå¯¼å…¥è¶…æ—¶ï¼Œä»¥ä¸‹é•œåƒæœªèƒ½æˆåŠŸå¯¼å…¥ï¼š"
                for image in "${required_images[@]}"; do
                  if ! ctr -n k8s.io images list | grep -q "$image"; then
                    echo "  - $image"
                  fi
                done
                exit 1
              fi
              
              echo "ç­‰å¾…2ç§’åé‡è¯•..."
              sleep 2
              attempt=$((attempt + 1))
            done

  # 3. éƒ¨ç½²åŸºç¡€è®¾æ–½ï¼ˆå‘½åç©ºé—´ã€é…ç½®ã€æ•°æ®åº“ï¼‰
  deploy_infrastructure:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    needs: [import_images]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy infrastructure
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            # æ£€æŸ¥ kubectl æ˜¯å¦å¯ç”¨
            echo "ğŸ” æ£€æŸ¥ kubectl æ˜¯å¦å¯ç”¨..."
            if ! command -v kubectl &> /dev/null; then
              echo "âŒ kubectl æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­"
              exit 1
            else
              echo "âœ… kubectl å¯ç”¨"
            fi
            
            # æ£€æŸ¥é›†ç¾¤è¿æ¥
            echo "ğŸ”— æ£€æŸ¥ Kubernetes é›†ç¾¤è¿æ¥..."
            if kubectl cluster-info >/dev/null 2>&1; then
              echo "âœ… Kubernetes é›†ç¾¤è¿æ¥æ­£å¸¸"
            else
              echo "âŒ æ— æ³•è¿æ¥åˆ° Kubernetes é›†ç¾¤ï¼Œè¯·æ£€æŸ¥ kubeconfigã€ç½‘ç»œä¸é›†ç¾¤çŠ¶æ€"
              exit 1
            fi
            
            # åˆ›å»ºå‘½åç©ºé—´
            echo "ğŸ“¦ åˆ›å»ºå‘½åç©ºé—´..."
            kubectl apply -f k8s/namespace.yaml
            
            # åˆ›å»ºé…ç½®
            echo "âš™ï¸ åˆ›å»ºé…ç½®..."
            kubectl apply -f k8s/configmap.yaml
            
            # éƒ¨ç½²æ•°æ®åº“æœåŠ¡
            echo "ğŸ—„ï¸ éƒ¨ç½²æ•°æ®åº“æœåŠ¡..."
            kubectl apply -f k8s/postgres-deployment.yaml
            
            # ç­‰å¾…æ•°æ®åº“å°±ç»ª
            echo "â³ ç­‰å¾…æ•°æ®åº“æœåŠ¡å°±ç»ª..."
            kubectl wait --for=condition=available --timeout=300s deployment/postgres -n mywork || true
            
            echo "âœ… åŸºç¡€è®¾æ–½éƒ¨ç½²å®Œæˆ"

  # 4. éƒ¨ç½²åº”ç”¨æœåŠ¡ï¼ˆå¾®æœåŠ¡å’Œå‰ç«¯ï¼‰
  deploy_services:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    needs: [deploy_infrastructure]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy microservices and frontend
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            # éƒ¨ç½²å¾®æœåŠ¡
            echo "ğŸ”§ éƒ¨ç½²å¾®æœåŠ¡..."
            kubectl apply -f k8s/microservices-deployments.yaml
            kubectl apply -f k8s/microservices-services.yaml
            
            # éƒ¨ç½²å‰ç«¯
            echo "ğŸ”§ éƒ¨ç½²å‰ç«¯..."
            kubectl apply -f k8s/frontend-deployment.yaml
            
            # ç­‰å¾…åŸºç¡€æœåŠ¡éƒ¨ç½²å®Œæˆ
            echo "â³ ç­‰å¾…åŸºç¡€æœåŠ¡éƒ¨ç½²å®Œæˆ..."
            base_deployments=(
              "user-service"
              "activity-service"
              "notification-service"
              "frontend-service"
            )
            
            for deployment in "${base_deployments[@]}"; do
              echo "ç­‰å¾… $deployment å°±ç»ª..."
              kubectl wait --for=condition=available --timeout=300s deployment/$deployment -n mywork || true
            done
            
            echo "âœ… åº”ç”¨æœåŠ¡éƒ¨ç½²å®Œæˆ"

  # 5. éƒ¨ç½²ç½‘å…³å’Œ Ingress
  deploy_gateway:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    needs: [deploy_services]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy gateway and ingress
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            # éƒ¨ç½² nginx ç½‘å…³
            echo "ğŸŒ éƒ¨ç½² nginx ç½‘å…³..."
            kubectl apply -f k8s/nginx-deployment.yaml
            
            # ç­‰å¾…nginxç½‘å…³éƒ¨ç½²å®Œæˆ
            echo "â³ ç­‰å¾… nginx ç½‘å…³éƒ¨ç½²å®Œæˆ..."
            kubectl wait --for=condition=available --timeout=300s deployment/nginx-gateway -n mywork || true
            
            # éƒ¨ç½² Ingress
            echo "ğŸšª éƒ¨ç½² Ingress..."
            kubectl apply -f k8s/ingress-nginx-controller.yaml
            kubectl apply -f k8s/ingress.yaml
            
            echo "âœ… ç½‘å…³å’Œ Ingress éƒ¨ç½²å®Œæˆ"

  # 6. éªŒè¯éƒ¨ç½²çŠ¶æ€
  verify_deployment:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    needs: [deploy_gateway]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify deployment status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            
            echo "=== Pods ==="
            kubectl get pods -n mywork
            
            echo "=== Services ==="
            kubectl get services -n mywork
            
            echo "=== Ingress ==="
            kubectl get ingress -n mywork
            
            echo "=== ConfigMaps ==="
            kubectl get configmaps -n mywork
            
            echo "=== Deployments ==="
            kubectl get deployments -n mywork
            
            # è·å–è®¿é—®ä¿¡æ¯
            echo "ğŸ”— è·å–è®¿é—®ä¿¡æ¯..."
            
            # è·å– Ingress ä¿¡æ¯
            echo "=== Ingress è®¿é—®åœ°å€ ==="
            kubectl get ingress -n mywork -o wide
            
            # è·å– NodePort ä¿¡æ¯
            echo "=== NodePort è®¿é—®åœ°å€ ==="
            kubectl get service nginx-gateway-nodeport -n mywork -o wide || echo "NodePort æœåŠ¡ä¸å­˜åœ¨"
            
            # è·å–é›†ç¾¤ IP
            CLUSTER_IP=$(kubectl get service nginx-gateway-service -n mywork -o jsonpath='{.spec.clusterIP}' 2>/dev/null || echo "N/A")
            echo "=== é›†ç¾¤å†…è®¿é—®åœ°å€ ==="
            echo "http://$CLUSTER_IP"
            
            echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆï¼"
      
      - name: Deployment Summary
        run: |
          echo "## ğŸ‰ éƒ¨ç½²å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### éƒ¨ç½²é˜¶æ®µ" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| å‡†å¤‡å’Œæ„å»ºé•œåƒ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯¼å…¥é•œåƒåˆ° containerd | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²åŸºç¡€è®¾æ–½ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²åº”ç”¨æœåŠ¡ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²ç½‘å…³å’Œ Ingress | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| éªŒè¯éƒ¨ç½²çŠ¶æ€ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å·²éƒ¨ç½²æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç”¨æˆ·æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| æ´»åŠ¨æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| é€šçŸ¥æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| å‰ç«¯æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| Nginxç½‘å…³ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| Ingress | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY