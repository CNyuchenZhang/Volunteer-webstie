name: ðŸš€ Volunteer Platform CI/CD

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main" ]

jobs:
  # ä»£ç ä¸Žä¾èµ–å®‰å…¨æ‰«æï¼ˆPRï¼‰
  sast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Gitleaks (secrets)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --no-git -v --report-format sarif --report-path gitleaks.sarif

      - name: Install SAST tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit semgrep pip-audit

      - name: Bandit (Python SAST)
        run: bandit -r services -f sarif -o bandit.sarif || true

      - name: Semgrep (generic SAST)
        run: semgrep ci --sarif --output semgrep.sarif || true

      - name: Dependency scan (pip-audit)
        run: |
          pip-audit -r services/user/requirements.txt -f sarif -o pip-audit-user.sarif || true
          pip-audit -r services/activity/requirements.txt -f sarif -o pip-audit-activity.sarif || true
          pip-audit -r services/notification/requirements.txt -f sarif -o pip-audit-notification.sarif || true

      - name: Upload SAST artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast_reports
          path: |
            *.sarif

  # å•å…ƒæµ‹è¯•ä¸Žè¦†ç›–çŽ‡ï¼ˆPRï¼‰
  unit:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [sast]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage
          pip install -r services/user/requirements.txt
          pip install -r services/activity/requirements.txt
          pip install -r services/notification/requirements.txt

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run user service tests (with coverage)
        run: |
          cd services/user
          python manage.py migrate --settings=user_service.settings.base
          coverage run --source=. manage.py test users.tests --noinput --settings=user_service.settings.base
          coverage xml -o ../../coverage-user.xml
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Run activity service tests (with coverage)
        run: |
          cd services/activity
          python manage.py migrate --settings=activity_service.settings.base
          coverage run --source=. manage.py test activities.tests --noinput --settings=activity_service.settings.base
          coverage xml -o ../../coverage-activity.xml
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Run notification service tests (with coverage)
        run: |
          cd services/notification
          python manage.py migrate --settings=notification_service.settings
          coverage run --source=. manage.py test notification_service.tests --noinput --settings=notification_service.settings
          coverage xml -o ../../coverage-notification.xml
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Enforce coverage threshold (aggregate â‰¥85%)
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET
          import sys
          files = [
            'coverage-user.xml',
            'coverage-activity.xml',
            'coverage-notification.xml'
          ]
          total_covered = 0
          total_lines = 0
          for f in files:
              tree = ET.parse(f)
              cov = tree.getroot().attrib
              total_covered += int(cov.get('lines-covered', 0))
              total_lines += int(cov.get('lines-valid', 0))
          pct = (total_covered / total_lines * 100) if total_lines else 0
          print(f"Aggregate coverage: {pct:.2f}%")
          sys.exit(0 if pct >= 85 else 1)
          PY

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage_xml
          path: |
            coverage-*.xml

      - name: Run frontend build test
        run: |
          cd frontend
          npm run build
          echo "âœ… Frontend build successful"

  # é›†æˆä¸Žç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆPRï¼‰
  integration:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [unit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start stack for integration tests
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: Wait for services health
        run: |
          for i in {1..60}; do
            curl -fsS http://localhost:8001/api/v1/health/ && \
            curl -fsS http://localhost:8002/api/v1/health/ && \
            curl -fsS http://localhost:8003/api/v1/health/ && exit 0 || sleep 2
          done
          exit 1

      - name: Install Newman and Playwright
        run: |
          sudo npm -g i newman
          npm ci --prefix frontend
          npx playwright install --with-deps

      - name: Run Postman collection (API integration)
        run: |
          newman run tests/postman_collection.json \
            --environment tests/postman_env.json \
            --reporters cli,html \
            --reporter-html-export newman-report.html

      - name: Run Playwright E2E
        run: npm test --prefix frontend -- --reporter=html --output=playwright-report || true

      - name: Upload integration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: integration_artifacts
          path: |
            newman-report.html
            frontend/playwright-report

  # å®¹å™¨é•œåƒä¸ŽK8sæ¸…å•æ‰«æï¼ˆPRï¼‰
  container_iac_scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [unit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build images
        run: |
          docker build -t user-service:ci ./services/user || true
          docker build -t activity-service:ci ./services/activity || true
          docker build -t notification-service:ci ./services/notification || true

      - name: Trivy image scan (user)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: user-service:ci
          format: 'table'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Trivy image scan (activity)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: activity-service:ci
          format: 'table'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Trivy image scan (notification)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: notification-service:ci
          format: 'table'
          exit-code: '0'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Checkov scan (K8s manifests)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: k8s
          framework: kubernetes
          soft_fail: true

  # DASTï¼ˆPRï¼‰ï¼šå¯¹æœ¬åœ°é›†æˆçŽ¯å¢ƒè¿›è¡ŒåŸºçº¿åŠ¨æ€æ‰«æ
  dast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: [integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure integration stack up
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: OWASP ZAP baseline scan (user-service)
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8001'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -m 5'

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap_report
          path: report_html.html

  # æ€§èƒ½æµ‹è¯•ï¼ˆpush æˆ–æ‰‹åŠ¨ï¼‰ï¼Œä½¿ç”¨æŽ¥è¿‘ç”Ÿäº§çš„è¿›ç¨‹æ¨¡åž‹
  perf:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    needs: [integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Launch perf env (gunicorn)
        run: docker compose -f docker-compose.perf.yml up -d --build

      - name: k6 load test
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/perf/k6-load.js

      - name: Install JMeter
        run: sudo apt-get update && sudo apt-get install -y jmeter

      - name: Run JMeter plan
        run: |
          jmeter -n -t tests/perf/jmeter_test.jmx -l jmeter.jtl -e -o jmeter-report

      - name: Upload perf artifacts
        uses: actions/upload-artifact@v4
        with:
          name: perf_results
          path: |
            jmeter.jtl
            jmeter-report

  # éƒ¨ç½²é˜¶æ®µ - æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è¿è¡Œ
  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Production
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            echo "ðŸš€ å¼€å§‹éƒ¨ç½² Volunteer Platform..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /home/project/Volunteer-platform
            
            # æ›´æ–°ä»£ç 
            echo "ðŸ“¥ æ›´æ–°ä»£ç ..."
            git pull
          
            # æž„å»ºé•œåƒ
            echo "ðŸ”¨ æž„å»ºé•œåƒ..."
            docker compose build
            
            # æ£€æŸ¥çŽ°æœ‰é•œåƒ
            echo "1. æ£€æŸ¥çŽ°æœ‰é•œåƒ..."
            docker images | grep jsrgzyc
            
            # å¯¼å…¥é•œåƒåˆ°containerd
            echo "2. å¯¼å…¥é•œåƒåˆ°containerd..."
          
            echo "å¯¼å…¥user-service..."
            if docker images | grep -q "jsrgzyc/user-service"; then
                docker save jsrgzyc/user-service:latest | ctr -n k8s.io images import -
                echo "âœ… user-serviceå¯¼å…¥æˆåŠŸ"
            else
                echo "âŒ user-serviceé•œåƒä¸å­˜åœ¨"
            fi
          
            echo "å¯¼å…¥activity-service..."
            if docker images | grep -q "jsrgzyc/activity-service"; then
                docker save jsrgzyc/activity-service:latest | ctr -n k8s.io images import -
                echo "âœ… activity-serviceå¯¼å…¥æˆåŠŸ"
            else
                echo "âŒ activity-serviceé•œåƒä¸å­˜åœ¨"
            fi
          
            echo "å¯¼å…¥notification-service..."
            if docker images | grep -q "jsrgzyc/notification-service"; then
                docker save jsrgzyc/notification-service:latest | ctr -n k8s.io images import -
                echo "âœ… notification-serviceå¯¼å…¥æˆåŠŸ"
            else
                echo "âŒ notification-serviceé•œåƒä¸å­˜åœ¨"
            fi
          
            echo "å¯¼å…¥frontend..."
            if docker images | grep -q "jsrgzyc/frontend"; then
                docker save jsrgzyc/frontend:latest | ctr -n k8s.io images import -
                echo "âœ… frontendå¯¼å…¥æˆåŠŸ"
            else
                echo "âŒ frontendé•œåƒä¸å­˜åœ¨"
            fi
          
            # éªŒè¯é•œåƒå¯¼å…¥å®Œæˆ
            echo "ðŸ” éªŒè¯é•œåƒå¯¼å…¥çŠ¶æ€..."
            required_images=(
                "jsrgzyc/user-service:latest"
                "jsrgzyc/activity-service:latest"
                "jsrgzyc/notification-service:latest"
                "jsrgzyc/frontend:latest"
            )
            
            # ç­‰å¾…å¹¶éªŒè¯é•œåƒå¯¼å…¥å®Œæˆ
            max_attempts=10
            attempt=1
            
            while [ $attempt -le $max_attempts ]; do
                echo "æ£€æŸ¥é•œåƒå¯¼å…¥çŠ¶æ€ (å°è¯• $attempt/$max_attempts)..."
                all_imported=true
                
                for image in "${required_images[@]}"; do
                    if ctr -n k8s.io images list | grep -q "$image"; then
                        echo "âœ… $image å·²å¯¼å…¥"
                    else
                        echo "â³ $image å°šæœªå¯¼å…¥ï¼Œç­‰å¾…ä¸­..."
                        all_imported=false
                    fi
                done
                
                if [ "$all_imported" = true ]; then
                    echo "âœ… æ‰€æœ‰é•œåƒå¯¼å…¥å®Œæˆï¼"
                    break
                fi
                
                if [ $attempt -eq $max_attempts ]; then
                    echo "âŒ é•œåƒå¯¼å…¥è¶…æ—¶ï¼Œä»¥ä¸‹é•œåƒæœªèƒ½æˆåŠŸå¯¼å…¥ï¼š"
                    for image in "${required_images[@]}"; do
                        if ! ctr -n k8s.io images list | grep -q "$image"; then
                            echo "  - $image"
                        fi
                    done
                    exit 1
                fi
                
                echo "ç­‰å¾…2ç§’åŽé‡è¯•..."
                sleep 2
                attempt=$((attempt + 1))
            done
            
            echo "âœ… æ‰€æœ‰é•œåƒå¯¼å…¥å®Œæˆï¼Œå¼€å§‹Kuberneteséƒ¨ç½²..."
            
            # æ£€æŸ¥ kubectl æ˜¯å¦å¯ç”¨
            echo "ðŸ” æ£€æŸ¥ kubectl æ˜¯å¦å¯ç”¨..."
            if ! command -v kubectl &> /dev/null; then
                echo "âŒ kubectl æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­"
                exit 1
            else
                echo "âœ… kubectl å¯ç”¨"
            fi
            
            # æ£€æŸ¥é›†ç¾¤è¿žæŽ¥
            echo "ðŸ”— æ£€æŸ¥ Kubernetes é›†ç¾¤è¿žæŽ¥..."
            if kubectl cluster-info >/dev/null 2>&1; then
                echo "âœ… Kubernetes é›†ç¾¤è¿žæŽ¥æ­£å¸¸"
            else
                echo "âŒ æ— æ³•è¿žæŽ¥åˆ° Kubernetes é›†ç¾¤ï¼Œè¯·æ£€æŸ¥ kubeconfigã€ç½‘ç»œä¸Žé›†ç¾¤çŠ¶æ€"
                exit 1
            fi
          
            # åˆ›å»ºå‘½åç©ºé—´
            echo "ðŸ“¦ åˆ›å»ºå‘½åç©ºé—´..."
            kubectl apply -f k8s/namespace.yaml
            
            # åˆ›å»ºé…ç½®
            echo "âš™ï¸ åˆ›å»ºé…ç½®..."
            kubectl apply -f k8s/configmap.yaml
            
            # éƒ¨ç½²æ•°æ®åº“æœåŠ¡
            echo "ðŸ—„ï¸ éƒ¨ç½²æ•°æ®åº“æœåŠ¡..."
            kubectl apply -f k8s/postgres-deployment.yaml
            
            # éƒ¨ç½²å¾®æœåŠ¡
            echo "ðŸ”§ éƒ¨ç½²å¾®æœåŠ¡..."
            kubectl apply -f k8s/microservices-deployments.yaml
            kubectl apply -f k8s/microservices-services.yaml
            
            # éƒ¨ç½²å‰ç«¯
            echo "ðŸ”§ éƒ¨ç½²å‰ç«¯..."
            kubectl apply -f k8s/frontend-deployment.yaml
            
            # ç­‰å¾…åŸºç¡€æœåŠ¡éƒ¨ç½²å®Œæˆ
            echo "â³ ç­‰å¾…åŸºç¡€æœåŠ¡éƒ¨ç½²å®Œæˆ..."
            base_deployments=(
                "postgres"
                "user-service"
                "activity-service"
                "notification-service"
                "frontend-service"
            )
            
            for deployment in "${base_deployments[@]}"; do
                echo "ç­‰å¾… $deployment å°±ç»ª..."
                kubectl wait --for=condition=available --timeout=300s deployment/$deployment -n mywork
            done
            
            # éƒ¨ç½² nginx ç½‘å…³
            echo "ðŸŒ éƒ¨ç½² nginx ç½‘å…³..."
            kubectl apply -f k8s/nginx-deployment.yaml
            
            # ç­‰å¾…nginxç½‘å…³éƒ¨ç½²å®Œæˆ
            echo "â³ ç­‰å¾… nginx ç½‘å…³éƒ¨ç½²å®Œæˆ..."
            kubectl wait --for=condition=available --timeout=300s deployment/nginx-gateway -n mywork
            
            # éƒ¨ç½² Ingress
            echo "ðŸšª éƒ¨ç½² Ingress..."
            kubectl apply -f k8s/ingress-nginx-controller.yaml
            kubectl apply -f k8s/ingress.yaml
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ðŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            
            echo "=== Pods ==="
            kubectl get pods -n mywork
            
            echo "=== Services ==="
            kubectl get services -n mywork
            
            echo "=== Ingress ==="
            kubectl get ingress -n mywork
            
            echo "=== ConfigMaps ==="
            kubectl get configmaps -n mywork
            
            echo "=== Deployments ==="
            kubectl get deployments -n mywork
            
            # èŽ·å–è®¿é—®ä¿¡æ¯
            echo "ðŸ”— èŽ·å–è®¿é—®ä¿¡æ¯..."
            
            # èŽ·å– Ingress ä¿¡æ¯
            echo "=== Ingress è®¿é—®åœ°å€ ==="
            kubectl get ingress -n mywork -o wide
            
            # èŽ·å– NodePort ä¿¡æ¯
            echo "=== NodePort è®¿é—®åœ°å€ ==="
            kubectl get service nginx-gateway-nodeport -n mywork -o wide
            
            # èŽ·å–é›†ç¾¤ IP
            CLUSTER_IP=$(kubectl get service nginx-gateway-service -n mywork -o jsonpath='{.spec.clusterIP}')
            echo "=== é›†ç¾¤å†…è®¿é—®åœ°å€ ==="
            echo "http://$CLUSTER_IP"
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          
      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç”¨æˆ·æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| æ´»åŠ¨æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| é€šçŸ¥æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| å‰ç«¯æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| Nginxç½‘å…³ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
          echo "| Ingress | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY