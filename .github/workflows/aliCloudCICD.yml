name: ðŸš€ Volunteer Platform CI/CD

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main" ]

jobs:
  # æµ‹è¯•é˜¶æ®µ - PRæ—¶è¿è¡Œ
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Python dependencies
      run: |
        pip install -r services/user/requirements.txt
        pip install -r services/activity/requirements.txt
        pip install -r services/notification/requirements.txt
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run user service tests
      run: |
        cd services/user
        python manage.py migrate --settings=user_service.settings.base
        python manage.py test users.tests --verbosity=2 --settings=user_service.settings.base
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        
    - name: Run activity service tests
      run: |
        cd services/activity
        python manage.py migrate --settings=activity_service.settings.base
        python manage.py test activities.tests -v 2 --settings=activity_service.settings.base
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        
    - name: Run notification service tests
      run: |
        cd services/notification
        python manage.py migrate --settings=notification_service.settings
        python manage.py test notification_service.tests -v 2 --settings=notification_service.settings
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        
    - name: Run frontend build test
      run: |
        cd frontend
        npm run build
        echo "âœ… Frontend build successful"

  # éƒ¨ç½²é˜¶æ®µ - æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è¿è¡Œ
  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
      - name: Deploy to Production
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½² Volunteer Platform..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /home/project/Volunteer-platform
          
          # æ›´æ–°ä»£ç 
          echo "ðŸ“¥ æ›´æ–°ä»£ç ..."
          git pull
          
          # æž„å»ºé•œåƒ
          echo "ðŸ”¨ æž„å»ºé•œåƒ..."
          docker compose build
          
          # æ£€æŸ¥çŽ°æœ‰é•œåƒ
          echo "1. æ£€æŸ¥çŽ°æœ‰é•œåƒ..."
          docker images | grep jsrgzyc
          
          # å¯¼å…¥é•œåƒåˆ°containerd
          echo "2. å¯¼å…¥é•œåƒåˆ°containerd..."
          
          echo "å¯¼å…¥user-service..."
          if docker images | grep -q "jsrgzyc/user-service"; then
              docker save jsrgzyc/user-service:latest | ctr -n k8s.io images import -
              echo "âœ… user-serviceå¯¼å…¥æˆåŠŸ"
          else
              echo "âŒ user-serviceé•œåƒä¸å­˜åœ¨"
          fi
          
          echo "å¯¼å…¥activity-service..."
          if docker images | grep -q "jsrgzyc/activity-service"; then
              docker save jsrgzyc/activity-service:latest | ctr -n k8s.io images import -
              echo "âœ… activity-serviceå¯¼å…¥æˆåŠŸ"
          else
              echo "âŒ activity-serviceé•œåƒä¸å­˜åœ¨"
          fi
          
          echo "å¯¼å…¥notification-service..."
          if docker images | grep -q "jsrgzyc/notification-service"; then
              docker save jsrgzyc/notification-service:latest | ctr -n k8s.io images import -
              echo "âœ… notification-serviceå¯¼å…¥æˆåŠŸ"
          else
              echo "âŒ notification-serviceé•œåƒä¸å­˜åœ¨"
          fi
          
          echo "å¯¼å…¥frontend..."
          if docker images | grep -q "jsrgzyc/frontend"; then
              docker save jsrgzyc/frontend:latest | ctr -n k8s.io images import -
              echo "âœ… frontendå¯¼å…¥æˆåŠŸ"
          else
              echo "âŒ frontendé•œåƒä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥å¯¼å…¥ç»“æžœ
          echo "3. æ£€æŸ¥å¯¼å…¥ç»“æžœ..."
          ctr -n k8s.io images list | grep jsrgzyc
          
          # éªŒè¯æ‰€æœ‰é•œåƒéƒ½å·²å¯¼å…¥
          echo "ðŸ” éªŒè¯é•œåƒå¯¼å…¥çŠ¶æ€..."
          required_images=(
              "jsrgzyc/user-service:latest"
              "jsrgzyc/activity-service:latest"
              "jsrgzyc/notification-service:latest"
              "jsrgzyc/frontend:latest"
          )
          
          # ç­‰å¾…å¹¶éªŒè¯é•œåƒå¯¼å…¥å®Œæˆ
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
              echo "æ£€æŸ¥é•œåƒå¯¼å…¥çŠ¶æ€ (å°è¯• $attempt/$max_attempts)..."
              all_imported=true
              
              for image in "${required_images[@]}"; do
                  if ctr -n k8s.io images list | grep -q "$image"; then
                      echo "âœ… $image å·²å¯¼å…¥"
                  else
                      echo "â³ $image å°šæœªå¯¼å…¥ï¼Œç­‰å¾…ä¸­..."
                      all_imported=false
                  fi
              done
              
              if [ "$all_imported" = true ]; then
                  echo "âœ… æ‰€æœ‰é•œåƒå¯¼å…¥å®Œæˆï¼"
                  break
              fi
              
              if [ $attempt -eq $max_attempts ]; then
                  echo "âŒ é•œåƒå¯¼å…¥è¶…æ—¶ï¼Œä»¥ä¸‹é•œåƒæœªèƒ½æˆåŠŸå¯¼å…¥ï¼š"
                  for image in "${required_images[@]}"; do
                      if ! ctr -n k8s.io images list | grep -q "$image"; then
                          echo "  - $image"
                      fi
                  done
                  exit 1
              fi
              
              echo "ç­‰å¾…2ç§’åŽé‡è¯•..."
              sleep 2
              attempt=$((attempt + 1))
          done
          
          echo "âœ… æ‰€æœ‰é•œåƒå¯¼å…¥å®Œæˆï¼Œå¼€å§‹Kuberneteséƒ¨ç½²..."
          
          # æ£€æŸ¥ kubectl æ˜¯å¦å¯ç”¨
          echo "ðŸ” æ£€æŸ¥ kubectl æ˜¯å¦å¯ç”¨..."
          if ! command -v kubectl &> /dev/null; then
              echo "âŒ kubectl æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­"
              exit 1
          else
              echo "âœ… kubectl å¯ç”¨"
          fi
          
          # æ£€æŸ¥é›†ç¾¤è¿žæŽ¥
          echo "ðŸ”— æ£€æŸ¥ Kubernetes é›†ç¾¤è¿žæŽ¥..."
          if kubectl cluster-info >/dev/null 2>&1; then
              echo "âœ… Kubernetes é›†ç¾¤è¿žæŽ¥æ­£å¸¸"
          else
              echo "âŒ æ— æ³•è¿žæŽ¥åˆ° Kubernetes é›†ç¾¤ï¼Œè¯·æ£€æŸ¥ kubeconfigã€ç½‘ç»œä¸Žé›†ç¾¤çŠ¶æ€"
              exit 1
          fi
          
          # åˆ›å»ºå‘½åç©ºé—´
          echo "ðŸ“¦ åˆ›å»ºå‘½åç©ºé—´..."
          kubectl apply -f k8s/namespace.yaml
          
          # åˆ›å»ºé…ç½®
          echo "âš™ï¸ åˆ›å»ºé…ç½®..."
          kubectl apply -f k8s/configmap.yaml
          
          # éƒ¨ç½²æ•°æ®åº“æœåŠ¡
          echo "ðŸ—„ï¸ éƒ¨ç½²æ•°æ®åº“æœåŠ¡..."
          kubectl apply -f k8s/postgres-deployment.yaml
          
          # éƒ¨ç½²å¾®æœåŠ¡
          echo "ðŸ”§ éƒ¨ç½²å¾®æœåŠ¡..."
          kubectl apply -f k8s/microservices-deployments.yaml
          kubectl apply -f k8s/microservices-services.yaml
          
          # éƒ¨ç½²å‰ç«¯
          echo "ðŸ”§ éƒ¨ç½²å‰ç«¯..."
          kubectl apply -f k8s/frontend-deployment.yaml
          
          # ç­‰å¾…åŸºç¡€æœåŠ¡éƒ¨ç½²å®Œæˆ
          echo "â³ ç­‰å¾…åŸºç¡€æœåŠ¡éƒ¨ç½²å®Œæˆ..."
          base_deployments=(
              "postgres"
              "user-service"
              "activity-service"
              "notification-service"
              "frontend-service"
          )
          
          for deployment in "${base_deployments[@]}"; do
              echo "ç­‰å¾… $deployment å°±ç»ª..."
              kubectl wait --for=condition=available --timeout=300s deployment/$deployment -n mywork
          done
          
          # éƒ¨ç½² nginx ç½‘å…³
          echo "ðŸŒ éƒ¨ç½² nginx ç½‘å…³..."
          kubectl apply -f k8s/nginx-deployment.yaml
          
          # ç­‰å¾…nginxç½‘å…³éƒ¨ç½²å®Œæˆ
          echo "â³ ç­‰å¾… nginx ç½‘å…³éƒ¨ç½²å®Œæˆ..."
          kubectl wait --for=condition=available --timeout=300s deployment/nginx-gateway -n mywork
          
          # éƒ¨ç½² Ingress
          echo "ðŸšª éƒ¨ç½² Ingress..."
          kubectl apply -f k8s/ingress-nginx-controller.yaml
          kubectl apply -f k8s/ingress.yaml
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "ðŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          
          echo "=== Pods ==="
          kubectl get pods -n mywork
          
          echo "=== Services ==="
          kubectl get services -n mywork
          
          echo "=== Ingress ==="
          kubectl get ingress -n mywork
          
          echo "=== ConfigMaps ==="
          kubectl get configmaps -n mywork
          
          echo "=== Deployments ==="
          kubectl get deployments -n mywork
          
          # èŽ·å–è®¿é—®ä¿¡æ¯
          echo "ðŸ”— èŽ·å–è®¿é—®ä¿¡æ¯..."
          
          # èŽ·å– Ingress ä¿¡æ¯
          echo "=== Ingress è®¿é—®åœ°å€ ==="
          kubectl get ingress -n mywork -o wide
          
          # èŽ·å– NodePort ä¿¡æ¯
          echo "=== NodePort è®¿é—®åœ°å€ ==="
          kubectl get service nginx-gateway-nodeport -n mywork -o wide
          
          # èŽ·å–é›†ç¾¤ IP
          CLUSTER_IP=$(kubectl get service nginx-gateway-service -n mywork -o jsonpath='{.spec.clusterIP}')
          echo "=== é›†ç¾¤å†…è®¿é—®åœ°å€ ==="
          echo "http://$CLUSTER_IP"
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          
    - name: Deployment Summary
      run: |
        echo "## ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
        echo "| æœåŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ç”¨æˆ·æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
        echo "| æ´»åŠ¨æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
        echo "| é€šçŸ¥æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
        echo "| å‰ç«¯æœåŠ¡ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
        echo "| Nginxç½‘å…³ | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
        echo "| Ingress | âœ… å·²éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY