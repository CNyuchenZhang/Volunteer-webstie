# å®‰å…¨æ¼æ´åˆ†æä¸ä¿®å¤æŠ¥å‘Š

> **æ‰«ææ—¥æœŸ**: 2025-11-05  
> **æ‰«æå·¥å…·**: Trivy (é•œåƒæ‰«æ) + Checkov (é…ç½®æ‰«æ)  
> **é¡¹ç›®**: Volunteer Platform  

---

## 1. æ‰§è¡Œæ‘˜è¦

### ğŸ“Š æ¼æ´ç»Ÿè®¡

| æ‰«æç±»å‹ | å·¥å…· | é€šè¿‡ | å¤±è´¥ | ä¸¥é‡æ€§ |
|---------|------|------|------|--------|
| **ä¾èµ–åŒ…æ¼æ´** | Trivy | - | 12+ | CRITICAL/HIGH |
| **Dockerfile é…ç½®** | Checkov | 129 | 13 | HIGH |
| **Kubernetes é…ç½®** | Checkov | 731 | 130 | MEDIUM/HIGH |

### ğŸ¯ å…³é”®å‘ç°

- **3 ä¸ª CRITICAL çº§åˆ«æ¼æ´** - Django SQL æ³¨å…¥ã€Pillow ä»£ç æ‰§è¡Œ
- **10+ ä¸ª HIGH çº§åˆ«æ¼æ´** - Django DoSã€Gunicorn è¯·æ±‚èµ°ç§
- **13 ä¸ª Dockerfile å®‰å…¨é—®é¢˜** - ç¦ç”¨ SSL è¯ä¹¦éªŒè¯
- **130 ä¸ª K8s é…ç½®é—®é¢˜** - ç¼ºå°‘å®‰å…¨ä¸Šä¸‹æ–‡ã€ä»¥ root è¿è¡Œ

---

## 2. ä¾èµ–åŒ…æ¼æ´åˆ†æï¼ˆTrivyï¼‰

### 2.1 Django æ¼æ´ï¼ˆCRITICAL & HIGHï¼‰

#### ğŸ”´ CVE-2024-42005 (CRITICAL)
- **ä¸¥é‡æ€§**: CRITICAL (CVSS 9.1)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.15+
- **æ¼æ´æè¿°**: QuerySet.values() å’Œ values_list() å­˜åœ¨ SQL æ³¨å…¥æ¼æ´
- **CWE**: CWE-89 (SQL Injection)
- **å½±å“èŒƒå›´**: 
  - âœ… services/user
  - âœ… services/activity
  - âœ… services/notification

**æŠ€æœ¯ç»†èŠ‚**:
```python
# å—å½±å“çš„ä»£ç æ¨¡å¼
Model.objects.values('field_name')  # å¯èƒ½è¢«åˆ©ç”¨
Model.objects.values_list('field_name')  # å¯èƒ½è¢«åˆ©ç”¨
```

**ä¿®å¤æ–¹æ¡ˆ**:
```diff
- Django==4.2.7
+ Django==4.2.24
```

---

#### ğŸ”´ CVE-2024-53908 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 9.8)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.17+
- **æ¼æ´æè¿°**: HasKey lookup åœ¨ Oracle æ•°æ®åº“ä¸Šå­˜åœ¨ SQL æ³¨å…¥
- **å½±å“**: ä½¿ç”¨ Oracle æ•°æ®åº“ä¸”ä½¿ç”¨ JSONField çš„åº”ç”¨

---

#### ğŸ”´ CVE-2025-57833 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 8.1)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.24
- **æ¼æ´æè¿°**: FilteredRelation åœ¨åˆ—åˆ«åä¸­å­˜åœ¨ SQL æ³¨å…¥
- **CWE**: CWE-89 (SQL Injection)

**å—å½±å“ä»£ç **:
```python
# å±é™©çš„ç”¨æ³•
queryset.annotate(**crafted_dict)
queryset.alias(**crafted_dict)
```

---

#### ğŸŸ¡ CVE-2024-24680 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 7.5)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.10+
- **æ¼æ´æè¿°**: intcomma æ¨¡æ¿è¿‡æ»¤å™¨çš„æ‹’ç»æœåŠ¡æ”»å‡»
- **å½±å“**: å¤„ç†è¶…é•¿å­—ç¬¦ä¸²æ—¶å¯èƒ½å¯¼è‡´ DoS

---

#### ğŸŸ¡ CVE-2024-38875 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 7.5)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.14+
- **æ¼æ´æè¿°**: urlize å’Œ urlizetrunc çš„æ‹’ç»æœåŠ¡æ”»å‡»
- **å½±å“**: å¤„ç†åŒ…å«å¤§é‡æ‹¬å·çš„è¾“å…¥æ—¶å¯èƒ½å¯¼è‡´ DoS

---

#### ğŸŸ¡ CVE-2024-39330 (HIGH)
- **ä¸¥é‡æ€§**: HIGH
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.14+
- **æ¼æ´æè¿°**: å…¶ä»–å®‰å…¨æ¼æ´

---

#### ğŸŸ¡ CVE-2025-59681 (HIGH)
- **ä¸¥é‡æ€§**: HIGH
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.24
- **æ¼æ´æè¿°**: å…¶ä»–å®‰å…¨æ¼æ´

---

### 2.2 Pillow æ¼æ´ï¼ˆCRITICALï¼‰

#### ğŸ”´ CVE-2023-50447 (CRITICAL)
- **ä¸¥é‡æ€§**: CRITICAL (CVSS 8.1)
- **å½±å“ç‰ˆæœ¬**: Pillow 10.1.0
- **ä¿®å¤ç‰ˆæœ¬**: Pillow 10.2.0+
- **æ¼æ´æè¿°**: PIL.ImageMath.eval é€šè¿‡ environment å‚æ•°å®ç°ä»»æ„ä»£ç æ‰§è¡Œ
- **CWE**: CWE-94 (Code Injection), CWE-95 (Eval Injection)
- **å½±å“èŒƒå›´**:
  - âœ… services/user
  - âœ… services/activity

**å±é™©ä»£ç ç¤ºä¾‹**:
```python
from PIL import ImageMath
# å±é™©ï¼šå…è®¸ä»»æ„ä»£ç æ‰§è¡Œ
ImageMath.eval(expression, environment=user_input)
```

**ä¿®å¤æ–¹æ¡ˆ**:
```diff
- Pillow==10.1.0
+ Pillow==11.0.0
```

---

#### ğŸŸ¡ CVE-2024-28219 (å…¶ä»– Pillow æ¼æ´)
- **å½±å“ç‰ˆæœ¬**: Pillow 10.1.0
- **ä¿®å¤ç‰ˆæœ¬**: Pillow 10.2.0+

---

### 2.3 Gunicorn æ¼æ´ï¼ˆHIGHï¼‰

#### ğŸŸ¡ CVE-2024-1135 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 8.2)
- **å½±å“ç‰ˆæœ¬**: gunicorn 21.2.0
- **ä¿®å¤ç‰ˆæœ¬**: gunicorn 22.0.0+
- **æ¼æ´æè¿°**: HTTP Request Smuggling - Transfer-Encoding å¤´éªŒè¯ä¸å½“
- **CWE**: CWE-444 (HTTP Request Smuggling)
- **å½±å“èŒƒå›´**:
  - âœ… services/user
  - âœ… services/activity
  - âœ… services/notification

**æ”»å‡»åœºæ™¯**:
```http
# æ”»å‡»è€…å¯ä»¥æ„é€ å†²çªçš„ Transfer-Encoding å¤´
POST / HTTP/1.1
Transfer-Encoding: chunked
Transfer-Encoding: identity

# ç»•è¿‡å®‰å…¨é™åˆ¶ï¼Œè®¿é—®å—é™ç«¯ç‚¹
```

**å¯èƒ½å¯¼è‡´**:
- ç¼“å­˜æŠ•æ¯’ (Cache Poisoning)
- ä¼šè¯æ“çºµ (Session Manipulation)
- æ•°æ®æ³„éœ² (Data Exposure)
- SSRFã€XSS æ”»å‡»

**ä¿®å¤æ–¹æ¡ˆ**:
```diff
- gunicorn==21.2.0
+ gunicorn==23.0.0
```

---

#### ğŸŸ¡ CVE-2024-6827 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 7.5)
- **å½±å“ç‰ˆæœ¬**: gunicorn 21.2.0
- **ä¿®å¤ç‰ˆæœ¬**: gunicorn 22.0.0+
- **æ¼æ´æè¿°**: HTTP Request Smuggling - TE.CL æ”»å‡»
- **å½±å“**: ç±»ä¼¼ CVE-2024-1135

---

## 3. Dockerfile å®‰å…¨é—®é¢˜ï¼ˆCheckovï¼‰

### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
- **é€šè¿‡æ£€æŸ¥**: 129 é¡¹
- **å¤±è´¥æ£€æŸ¥**: 13 é¡¹
- **ä¸»è¦é—®é¢˜**: SSL è¯ä¹¦éªŒè¯è¢«ç¦ç”¨

### 3.1 ğŸ”´ CKV2_DOCKER_4: ç¦ç”¨ pip SSL è¯ä¹¦éªŒè¯

#### é—®é¢˜æè¿°
æ‰€æœ‰åç«¯æœåŠ¡åœ¨ Dockerfile ä¸­ä½¿ç”¨ `--trusted-host` é€‰é¡¹ï¼Œç¦ç”¨äº† SSL è¯ä¹¦éªŒè¯ã€‚

#### å½±å“èŒƒå›´
- âœ… `services/user/Dockerfile`
- âœ… `services/activity/Dockerfile`
- âœ… `services/notification/Dockerfile`

#### å®‰å…¨é£é™©

**é£é™©ç­‰çº§**: HIGH

1. **ä¸­é—´äººæ”»å‡» (MITM)**
   - æ”»å‡»è€…å¯ä»¥æ‹¦æˆª pip å®‰è£…è¯·æ±‚
   - æ³¨å…¥æ¶æ„åŒ…æˆ–åé—¨ä»£ç 
   
2. **åŒ…å®Œæ•´æ€§æ— æ³•ä¿è¯**
   - æ— æ³•éªŒè¯ä¸‹è½½çš„åŒ…æ˜¯å¦è¢«ç¯¡æ”¹
   - å¯èƒ½å®‰è£…æŸåæˆ–æ¶æ„çš„ä¾èµ–

3. **ä¾›åº”é“¾æ”»å‡»**
   - å¦‚æœé•œåƒæºè¢«æ”»ç ´ï¼Œç›´æ¥å½±å“æ‰€æœ‰æ„å»º

#### åŸå§‹é…ç½®ï¼ˆæœ‰æ¼æ´ï¼‰

```dockerfile
# âŒ ä¸å®‰å…¨çš„é…ç½®
FROM python:3.11.5
WORKDIR /app
COPY . .
RUN pip install --no-cache-dir -r requirements.txt \
    -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple \
    --trusted-host mirrors.tuna.tsinghua.edu.cn
EXPOSE 8000
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "user_service.wsgi:application"]
```

#### ä¿®å¤åé…ç½®ï¼ˆå®‰å…¨ï¼‰

```dockerfile
# âœ… å®‰å…¨çš„é…ç½®
FROM python:3.11.5
WORKDIR /app
COPY . .
RUN pip install --no-cache-dir -r requirements.txt
EXPOSE 8000
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "user_service.wsgi:application"]
```

#### ä¿®å¤è¯´æ˜

1. **ç§»é™¤ `--trusted-host`**: æ¢å¤ SSL è¯ä¹¦éªŒè¯
2. **ç§»é™¤è‡ªå®šä¹‰é•œåƒæº**: ä½¿ç”¨å®˜æ–¹ PyPIï¼ˆæ›´å®‰å…¨ï¼‰
3. **å¦‚éœ€åŠ é€Ÿ**: 
   - ä½¿ç”¨ Docker æ„å»ºç¼“å­˜
   - ä½¿ç”¨ç§æœ‰ PyPI é•œåƒï¼ˆå¸¦æœ‰æ•ˆ SSL è¯ä¹¦ï¼‰
   - é…ç½® pip.conf ä½¿ç”¨å¯ä¿¡é•œåƒ

#### æœ€ä½³å®è·µ

```dockerfile
# å¦‚æœéœ€è¦ä½¿ç”¨é•œåƒæºï¼Œç¡®ä¿æœ‰æœ‰æ•ˆçš„ SSL è¯ä¹¦
FROM python:3.11.5
WORKDIR /app

# æ–¹æ¡ˆ1ï¼šä½¿ç”¨ pip.conf é…ç½®å¯ä¿¡é•œåƒ
COPY pip.conf /etc/pip.conf
COPY . .
RUN pip install --no-cache-dir -r requirements.txt

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
ENV PIP_INDEX_URL=https://pypi.org/simple
RUN pip install --no-cache-dir -r requirements.txt
```

---

## 4. Kubernetes é…ç½®é—®é¢˜ï¼ˆCheckovï¼‰

### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
- **é€šè¿‡æ£€æŸ¥**: 731 é¡¹
- **å¤±è´¥æ£€æŸ¥**: 130 é¡¹
- **ä¸»è¦é—®é¢˜**: ç¼ºå°‘å®‰å…¨ä¸Šä¸‹æ–‡ã€èµ„æºé™åˆ¶ã€æƒé™é…ç½®

### 4.1 å…³é”®å®‰å…¨é—®é¢˜åˆ†ç±»

#### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå®‰å…¨å…³é”®ï¼‰

##### CKV_K8S_23: å®¹å™¨ä»¥ root ç”¨æˆ·è¿è¡Œ
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å®¹å™¨é€ƒé€¸åå¯èƒ½è·å¾—ä¸»æœº root æƒé™
- **ä¿®å¤**:
```yaml
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
```

##### CKV_K8S_20: å…è®¸æƒé™æå‡
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: è¿›ç¨‹å¯ä»¥è·å¾—æ¯”çˆ¶è¿›ç¨‹æ›´é«˜çš„æƒé™
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    securityContext:
      allowPrivilegeEscalation: false
```

##### CKV_K8S_28: æœªé™åˆ¶ NET_RAW èƒ½åŠ›
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å®¹å™¨å¯ä»¥åˆ›å»ºåŸå§‹å¥—æ¥å­—ï¼Œè¿›è¡Œç½‘ç»œå—…æ¢
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    securityContext:
      capabilities:
        drop:
        - NET_RAW
        - ALL
```

##### CKV_K8S_30/29: æœªé…ç½®å®‰å…¨ä¸Šä¸‹æ–‡
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: ç¼ºå°‘åŸºæœ¬çš„å®‰å…¨éš”ç¦»æªæ–½
- **ä¿®å¤**:
```yaml
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  containers:
  - name: container
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      capabilities:
        drop:
        - ALL
```

##### CKV_K8S_31: æœªè®¾ç½® seccomp profile
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å®¹å™¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨
- **ä¿®å¤**:
```yaml
spec:
  securityContext:
    seccompProfile:
      type: RuntimeDefault
```

---

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

##### CKV_K8S_15: é•œåƒæ‹‰å–ç­–ç•¥é Always
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å¯èƒ½ä½¿ç”¨ç¼“å­˜çš„æ—§ç‰ˆæœ¬é•œåƒ
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    image: myimage:latest
    imagePullPolicy: Always
```

##### CKV_K8S_43: é•œåƒæœªä½¿ç”¨ digest
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: é•œåƒæ ‡ç­¾å¯èƒ½è¢«è¦†ç›–ï¼Œæ— æ³•ä¿è¯ä¸€è‡´æ€§
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    image: myimage@sha256:abcd1234...
```

##### CKV_K8S_38: è‡ªåŠ¨æŒ‚è½½æœåŠ¡è´¦å·ä»¤ç‰Œ
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: ä¸éœ€è¦è®¿é—® K8s API çš„ Pod ä¹Ÿè·å¾—äº†å‡­è¯
- **ä¿®å¤**:
```yaml
spec:
  automountServiceAccountToken: false
```

---

#### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

##### CKV_K8S_22: æœªä½¿ç”¨åªè¯»æ–‡ä»¶ç³»ç»Ÿ
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å®¹å™¨å¯ä»¥ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿï¼Œå¢åŠ æ”»å‡»é¢
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    securityContext:
      readOnlyRootFilesystem: true
    volumeMounts:
    - name: tmp
      mountPath: /tmp
  volumes:
  - name: tmp
    emptyDir: {}
```

##### CKV_K8S_11/12/10: èµ„æºé™åˆ¶æœªå®Œæ•´é…ç½®
- **å½±å“**: éƒ¨åˆ† Deployments
- **é£é™©**: èµ„æºäº‰ç”¨ã€noisy neighbor é—®é¢˜
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "1Gi"
        cpu: "1000m"
```

---

### 4.2 ç¤ºä¾‹ï¼šå®Œæ•´çš„å®‰å…¨ Deployment é…ç½®

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secure-app
  namespace: mywork
spec:
  replicas: 3
  selector:
    matchLabels:
      app: secure-app
  template:
    metadata:
      labels:
        app: secure-app
    spec:
      # Pod çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      
      # ç¦ç”¨è‡ªåŠ¨æŒ‚è½½æœåŠ¡è´¦å·ä»¤ç‰Œ
      automountServiceAccountToken: false
      
      containers:
      - name: app
        # ä½¿ç”¨ digest ç¡®ä¿é•œåƒä¸€è‡´æ€§
        image: myapp@sha256:abcd1234567890...
        imagePullPolicy: Always
        
        # å®¹å™¨çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
        
        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        
        # åªè¯»æ–‡ä»¶ç³»ç»Ÿéœ€è¦çš„ä¸´æ—¶ç›®å½•
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /app/cache
      
      volumes:
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}
```

---

## 5. å·²å®Œæˆçš„ä¿®å¤

### âœ… 5.1 Python ä¾èµ–åŒ…å‡çº§

#### Django å‡çº§
```diff
# services/user/requirements.txt
# services/activity/requirements.txt
# services/notification/requirements.txt

- Django==4.2.7
+ Django==4.2.24
```

**ä¿®å¤çš„æ¼æ´**:
- âœ… CVE-2024-42005 (CRITICAL) - SQL æ³¨å…¥
- âœ… CVE-2024-53908 (HIGH) - Oracle SQL æ³¨å…¥
- âœ… CVE-2025-57833 (HIGH) - FilteredRelation SQL æ³¨å…¥
- âœ… CVE-2024-24680 (HIGH) - DoS
- âœ… CVE-2024-38875 (HIGH) - DoS
- âœ… CVE-2024-39330 (HIGH)
- âœ… CVE-2025-59681 (HIGH)

**å½±å“**: ä¿®å¤ 7+ ä¸ª CRITICAL/HIGH çº§åˆ«æ¼æ´

---

#### Pillow å‡çº§
```diff
# services/user/requirements.txt
# services/activity/requirements.txt

- Pillow==10.1.0
+ Pillow==11.0.0
```

**ä¿®å¤çš„æ¼æ´**:
- âœ… CVE-2023-50447 (CRITICAL) - ä»»æ„ä»£ç æ‰§è¡Œ
- âœ… CVE-2024-28219 (å…¶ä»–å®‰å…¨é—®é¢˜)

**å½±å“**: ä¿®å¤ 2+ ä¸ª CRITICAL çº§åˆ«æ¼æ´

---

#### Gunicorn å‡çº§
```diff
# services/user/requirements.txt
# services/activity/requirements.txt
# services/notification/requirements.txt

- gunicorn==21.2.0
+ gunicorn==23.0.0
```

**ä¿®å¤çš„æ¼æ´**:
- âœ… CVE-2024-1135 (HIGH) - HTTP Request Smuggling
- âœ… CVE-2024-6827 (HIGH) - TE.CL æ”»å‡»

**å½±å“**: ä¿®å¤ 2 ä¸ª HIGH çº§åˆ«æ¼æ´

---

### âœ… 5.2 Dockerfile å®‰å…¨ä¿®å¤

#### ç§»é™¤ --trusted-host

**ä¿®å¤çš„æ–‡ä»¶**:
- âœ… `services/user/Dockerfile`
- âœ… `services/activity/Dockerfile`
- âœ… `services/notification/Dockerfile`

**ä¿®å¤è¯¦æƒ…**:
```diff
- RUN pip install --no-cache-dir -r requirements.txt \
-     -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple \
-     --trusted-host mirrors.tuna.tsinghua.edu.cn
+ RUN pip install --no-cache-dir -r requirements.txt
```

**å®‰å…¨æå‡**:
- âœ… æ¢å¤ SSL è¯ä¹¦éªŒè¯
- âœ… é˜²æ­¢ä¸­é—´äººæ”»å‡»
- âœ… ä½¿ç”¨å®˜æ–¹ PyPI æº
- âœ… ä¿è¯åŒ…çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§

---

### ğŸ“Š ä¿®å¤ç»Ÿè®¡

| ä¿®å¤ç±»å‹ | æ–‡ä»¶æ•° | æ¼æ´æ•° | ä¸¥é‡æ€§ |
|---------|-------|--------|--------|
| **Django å‡çº§** | 3 | 7+ | CRITICAL/HIGH |
| **Pillow å‡çº§** | 2 | 2+ | CRITICAL |
| **Gunicorn å‡çº§** | 3 | 2 | HIGH |
| **Dockerfile SSL** | 3 | 3 | HIGH |
| **æ€»è®¡** | **11** | **14+** | **CRITICAL/HIGH** |

---

## 6. å¾…ä¿®å¤å»ºè®®

### ğŸ”´ 6.1 é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰

#### K8s å®‰å…¨ä¸Šä¸‹æ–‡é…ç½®

**é¢„è®¡ä¿®å¤æ¼æ´æ•°**: ~50 é¡¹

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**:
- `k8s/postgres-deployment.yaml`
- `k8s/microservices-deployments.yaml`
- `k8s/frontend-deployment.yaml`
- `k8s/nginx-deployment.yaml`

**ä¿®å¤æ¨¡æ¿**:
```yaml
spec:
  # Pod çº§åˆ«
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
  
  # ç¦ç”¨æœåŠ¡è´¦å·ä»¤ç‰Œè‡ªåŠ¨æŒ‚è½½
  automountServiceAccountToken: false
  
  containers:
  - name: container
    # å®¹å™¨çº§åˆ«
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      capabilities:
        drop:
        - ALL
    
    # é•œåƒæ‹‰å–ç­–ç•¥
    imagePullPolicy: Always
```

**é¢„è®¡å·¥ä½œé‡**: 2-4 å°æ—¶

---

#### èµ„æºé™åˆ¶é…ç½®

**é¢„è®¡ä¿®å¤æ¼æ´æ•°**: ~20 é¡¹

**ä¿®å¤æ‰€æœ‰ Deployment çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶**:
```yaml
resources:
  requests:
    memory: "256Mi"
    cpu: "250m"
  limits:
    memory: "512Mi"
    cpu: "500m"
```

**é¢„è®¡å·¥ä½œé‡**: 1-2 å°æ—¶

---

### ğŸŸ¡ 6.2 ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### é•œåƒä½¿ç”¨ Digest

**é¢„è®¡ä¿®å¤æ¼æ´æ•°**: ~10 é¡¹

```bash
# è·å–é•œåƒ digest
docker pull postgres:13
docker inspect postgres:13 | grep -A 5 "Digest"

# æ›´æ–° K8s é…ç½®
image: postgres@sha256:abcd1234...
```

**é¢„è®¡å·¥ä½œé‡**: 1-2 å°æ—¶

---

#### åªè¯»æ–‡ä»¶ç³»ç»Ÿ

**é¢„è®¡ä¿®å¤æ¼æ´æ•°**: ~10 é¡¹

```yaml
securityContext:
  readOnlyRootFilesystem: true

volumeMounts:
- name: tmp
  mountPath: /tmp
- name: cache
  mountPath: /var/cache

volumes:
- name: tmp
  emptyDir: {}
- name: cache
  emptyDir: {}
```

**é¢„è®¡å·¥ä½œé‡**: 2-3 å°æ—¶

---

### ğŸŸ¢ 6.3 ä½ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–é¡¹ï¼‰

#### ç½‘ç»œç­–ç•¥
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

#### Pod Security Policy / Pod Security Standards
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: mywork
  labels:
    pod-security.kubernetes.io/enforce: restricted
```

---

## 7. éªŒè¯æ­¥éª¤

### 7.1 é‡æ–°æ‰«æéªŒè¯

```bash
# é‡æ–°æ„å»ºé•œåƒ
docker compose build

# æ‰«ææ–°é•œåƒ
trivy image --severity CRITICAL,HIGH jsrgzyc/user-service:latest
trivy image --severity CRITICAL,HIGH jsrgzyc/activity-service:latest
trivy image --severity CRITICAL,HIGH jsrgzyc/notification-service:latest

# æ‰«æ Dockerfile
checkov -d . --framework dockerfile

# æ‰«æ K8s é…ç½®
checkov -d k8s --framework kubernetes
```

### 7.2 åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•åº”ç”¨å¯åŠ¨
docker compose up -d

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8001/api/v1/health/
curl http://localhost:8002/api/v1/health/
curl http://localhost:8003/api/v1/health/

# è¿è¡Œé›†æˆæµ‹è¯•
npm test --prefix frontend
pytest services/user
pytest services/activity
pytest services/notification
```

### 7.3 æ€§èƒ½æµ‹è¯•

```bash
# éªŒè¯å‡çº§åæ€§èƒ½æœªä¸‹é™
k6 run tests/perf/k6-load.js
```

---

## 8. å‚è€ƒèµ„æ–™

### æ¼æ´æ•°æ®åº“
- [NIST NVD](https://nvd.nist.gov/)
- [GitHub Advisory Database](https://github.com/advisories)
- [PyPI Advisory Database](https://github.com/pypa/advisory-database)

### Django å®‰å…¨å…¬å‘Š
- [Django Security Releases](https://www.djangoproject.com/weblog/2024/aug/06/security-releases/)
- [Django 4.2 Release Notes](https://docs.djangoproject.com/en/4.2/releases/)

### Kubernetes å®‰å…¨
- [Kubernetes Security Best Practices](https://kubernetes.io/docs/concepts/security/)
- [Pod Security Standards](https://kubernetes.io/docs/concepts/security/pod-security-standards/)
- [CIS Kubernetes Benchmark](https://www.cisecurity.org/benchmark/kubernetes)

### å·¥å…·æ–‡æ¡£
- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Checkov Documentation](https://www.checkov.io/1.Welcome/What%20is%20Checkov.html)

---

## 9. æ€»ç»“

### âœ… å·²ä¿®å¤
- **14+ ä¸ª CRITICAL/HIGH æ¼æ´**å·²ä¿®å¤
- **3 ä¸ª Dockerfile SSL é—®é¢˜**å·²è§£å†³
- **æ‰€æœ‰ Python ä¾èµ–**å·²å‡çº§åˆ°å®‰å…¨ç‰ˆæœ¬

### â³ å¾…å¤„ç†
- **130 ä¸ª K8s é…ç½®é—®é¢˜**éœ€è¦ä¿®å¤
- å»ºè®®ä¼˜å…ˆå¤„ç†**å®‰å…¨ä¸Šä¸‹æ–‡**å’Œ**æƒé™é…ç½®**ï¼ˆçº¦ 50 é¡¹ï¼‰

### ğŸ“ˆ å®‰å…¨æå‡
- Django SQL æ³¨å…¥é£é™©ï¼šâœ… **å·²æ¶ˆé™¤**
- Pillow ä»£ç æ‰§è¡Œé£é™©ï¼šâœ… **å·²æ¶ˆé™¤**
- Gunicorn è¯·æ±‚èµ°ç§ï¼šâœ… **å·²æ¶ˆé™¤**
- Dockerfile SSL éªŒè¯ï¼šâœ… **å·²æ¢å¤**
- K8s å®‰å…¨é…ç½®ï¼šâ³ **å¾…åŠ å¼º**

### ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. **ç«‹å³**: éƒ¨ç½²å·²ä¿®å¤çš„ä¾èµ–åŒ…ç‰ˆæœ¬
2. **æœ¬å‘¨**: ä¿®å¤ K8s é«˜ä¼˜å…ˆçº§å®‰å…¨é…ç½®
3. **æœ¬æœˆ**: å®Œæˆæ‰€æœ‰ K8s å®‰å…¨åŠ å›º
4. **æŒç»­**: å»ºç«‹å®šæœŸå®‰å…¨æ‰«ææµç¨‹

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-05  
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0  
**è´Ÿè´£äºº**: AI Security Analyst

