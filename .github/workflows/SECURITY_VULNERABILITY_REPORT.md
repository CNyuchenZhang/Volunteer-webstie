# å®‰å…¨æ¼æ´åˆ†æä¸ä¿®å¤æŠ¥å‘Š

> **æ‰«ææ—¥æœŸ**: 2025-11-05  
> **æ‰«æå·¥å…·**: Trivy (é•œåƒæ‰«æ) + Checkov (é…ç½®æ‰«æ)  
> **é¡¹ç›®**: Volunteer Platform  

---

## 1. æ‰§è¡Œæ‘˜è¦

### ğŸ“Š æ¼æ´ç»Ÿè®¡

| æ‰«æç±»å‹ | å·¥å…· | é€šè¿‡ | å¤±è´¥ | ä¸¥é‡æ€§ |
|---------|------|------|------|--------|
| **ä¾èµ–åŒ…æ¼æ´** | Trivy | - | 12+ | CRITICAL/HIGH |
| **Dockerfile é…ç½®** | Checkov | 129 | 13 | HIGH |
| **Kubernetes é…ç½®** | Checkov | 731 | 130 | MEDIUM/HIGH |

### ğŸ¯ å…³é”®å‘ç°

- **3 ä¸ª CRITICAL çº§åˆ«æ¼æ´** - Django SQL æ³¨å…¥ã€Pillow ä»£ç æ‰§è¡Œ
- **10+ ä¸ª HIGH çº§åˆ«æ¼æ´** - Django DoSã€Gunicorn è¯·æ±‚èµ°ç§
- **13 ä¸ª Dockerfile å®‰å…¨é—®é¢˜** - ç¦ç”¨ SSL è¯ä¹¦éªŒè¯
- **130 ä¸ª K8s é…ç½®é—®é¢˜** - ç¼ºå°‘å®‰å…¨ä¸Šä¸‹æ–‡ã€ä»¥ root è¿è¡Œ

---

## 2. ä¾èµ–åŒ…æ¼æ´åˆ†æï¼ˆTrivyï¼‰

### 2.1 Django æ¼æ´ï¼ˆCRITICAL & HIGHï¼‰

#### ğŸ”´ CVE-2024-42005 (CRITICAL)
- **ä¸¥é‡æ€§**: CRITICAL (CVSS 9.1)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.15+
- **æ¼æ´æè¿°**: QuerySet.values() å’Œ values_list() å­˜åœ¨ SQL æ³¨å…¥æ¼æ´
- **CWE**: CWE-89 (SQL Injection)
- **å½±å“èŒƒå›´**: 
  - âœ… services/user
  - âœ… services/activity
  - âœ… services/notification

**æŠ€æœ¯ç»†èŠ‚**:
```python
# å—å½±å“çš„ä»£ç æ¨¡å¼
Model.objects.values('field_name')  # å¯èƒ½è¢«åˆ©ç”¨
Model.objects.values_list('field_name')  # å¯èƒ½è¢«åˆ©ç”¨
```

**ä¿®å¤æ–¹æ¡ˆ**:
```diff
- Django==4.2.7
+ Django==4.2.24
```

---

#### ğŸ”´ CVE-2024-53908 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 9.8)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.17+
- **æ¼æ´æè¿°**: HasKey lookup åœ¨ Oracle æ•°æ®åº“ä¸Šå­˜åœ¨ SQL æ³¨å…¥
- **å½±å“**: ä½¿ç”¨ Oracle æ•°æ®åº“ä¸”ä½¿ç”¨ JSONField çš„åº”ç”¨

---

#### ğŸ”´ CVE-2025-57833 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 8.1)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.24
- **æ¼æ´æè¿°**: FilteredRelation åœ¨åˆ—åˆ«åä¸­å­˜åœ¨ SQL æ³¨å…¥
- **CWE**: CWE-89 (SQL Injection)

**å—å½±å“ä»£ç **:
```python
# å±é™©çš„ç”¨æ³•
queryset.annotate(**crafted_dict)
queryset.alias(**crafted_dict)
```

---

#### ğŸŸ¡ CVE-2024-24680 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 7.5)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.10+
- **æ¼æ´æè¿°**: intcomma æ¨¡æ¿è¿‡æ»¤å™¨çš„æ‹’ç»æœåŠ¡æ”»å‡»
- **å½±å“**: å¤„ç†è¶…é•¿å­—ç¬¦ä¸²æ—¶å¯èƒ½å¯¼è‡´ DoS

---

#### ğŸŸ¡ CVE-2024-38875 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 7.5)
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.14+
- **æ¼æ´æè¿°**: urlize å’Œ urlizetrunc çš„æ‹’ç»æœåŠ¡æ”»å‡»
- **å½±å“**: å¤„ç†åŒ…å«å¤§é‡æ‹¬å·çš„è¾“å…¥æ—¶å¯èƒ½å¯¼è‡´ DoS

---

#### ğŸŸ¡ CVE-2024-39330 (HIGH)
- **ä¸¥é‡æ€§**: HIGH
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.14+
- **æ¼æ´æè¿°**: å…¶ä»–å®‰å…¨æ¼æ´

---

#### ğŸŸ¡ CVE-2025-59681 (HIGH)
- **ä¸¥é‡æ€§**: HIGH
- **å½±å“ç‰ˆæœ¬**: Django 4.2.7
- **ä¿®å¤ç‰ˆæœ¬**: Django 4.2.24
- **æ¼æ´æè¿°**: å…¶ä»–å®‰å…¨æ¼æ´

---

### 2.2 Pillow æ¼æ´ï¼ˆCRITICALï¼‰

#### ğŸ”´ CVE-2023-50447 (CRITICAL)
- **ä¸¥é‡æ€§**: CRITICAL (CVSS 8.1)
- **å½±å“ç‰ˆæœ¬**: Pillow 10.1.0
- **ä¿®å¤ç‰ˆæœ¬**: Pillow 10.2.0+
- **æ¼æ´æè¿°**: PIL.ImageMath.eval é€šè¿‡ environment å‚æ•°å®ç°ä»»æ„ä»£ç æ‰§è¡Œ
- **CWE**: CWE-94 (Code Injection), CWE-95 (Eval Injection)
- **å½±å“èŒƒå›´**:
  - âœ… services/user
  - âœ… services/activity

**å±é™©ä»£ç ç¤ºä¾‹**:
```python
from PIL import ImageMath
# å±é™©ï¼šå…è®¸ä»»æ„ä»£ç æ‰§è¡Œ
ImageMath.eval(expression, environment=user_input)
```

**ä¿®å¤æ–¹æ¡ˆ**:
```diff
- Pillow==10.1.0
+ Pillow==11.0.0
```

---

#### ğŸŸ¡ CVE-2024-28219 (å…¶ä»– Pillow æ¼æ´)
- **å½±å“ç‰ˆæœ¬**: Pillow 10.1.0
- **ä¿®å¤ç‰ˆæœ¬**: Pillow 10.2.0+

---

### 2.3 Gunicorn æ¼æ´ï¼ˆHIGHï¼‰

#### ğŸŸ¡ CVE-2024-1135 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 8.2)
- **å½±å“ç‰ˆæœ¬**: gunicorn 21.2.0
- **ä¿®å¤ç‰ˆæœ¬**: gunicorn 22.0.0+
- **æ¼æ´æè¿°**: HTTP Request Smuggling - Transfer-Encoding å¤´éªŒè¯ä¸å½“
- **CWE**: CWE-444 (HTTP Request Smuggling)
- **å½±å“èŒƒå›´**:
  - âœ… services/user
  - âœ… services/activity
  - âœ… services/notification

**æ”»å‡»åœºæ™¯**:
```http
# æ”»å‡»è€…å¯ä»¥æ„é€ å†²çªçš„ Transfer-Encoding å¤´
POST / HTTP/1.1
Transfer-Encoding: chunked
Transfer-Encoding: identity

# ç»•è¿‡å®‰å…¨é™åˆ¶ï¼Œè®¿é—®å—é™ç«¯ç‚¹
```

**å¯èƒ½å¯¼è‡´**:
- ç¼“å­˜æŠ•æ¯’ (Cache Poisoning)
- ä¼šè¯æ“çºµ (Session Manipulation)
- æ•°æ®æ³„éœ² (Data Exposure)
- SSRFã€XSS æ”»å‡»

**ä¿®å¤æ–¹æ¡ˆ**:
```diff
- gunicorn==21.2.0
+ gunicorn==23.0.0
```

---

#### ğŸŸ¡ CVE-2024-6827 (HIGH)
- **ä¸¥é‡æ€§**: HIGH (CVSS 7.5)
- **å½±å“ç‰ˆæœ¬**: gunicorn 21.2.0
- **ä¿®å¤ç‰ˆæœ¬**: gunicorn 22.0.0+
- **æ¼æ´æè¿°**: HTTP Request Smuggling - TE.CL æ”»å‡»
- **å½±å“**: ç±»ä¼¼ CVE-2024-1135

---

## 3. Dockerfile å®‰å…¨é—®é¢˜ï¼ˆCheckovï¼‰

### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
- **é€šè¿‡æ£€æŸ¥**: 129 é¡¹
- **å¤±è´¥æ£€æŸ¥**: 13 é¡¹
- **ä¸»è¦é—®é¢˜**: SSL è¯ä¹¦éªŒè¯è¢«ç¦ç”¨

### 3.1 ğŸ”´ CKV2_DOCKER_4: ç¦ç”¨ pip SSL è¯ä¹¦éªŒè¯

#### é—®é¢˜æè¿°
æ‰€æœ‰åç«¯æœåŠ¡åœ¨ Dockerfile ä¸­ä½¿ç”¨ `--trusted-host` é€‰é¡¹ï¼Œç¦ç”¨äº† SSL è¯ä¹¦éªŒè¯ã€‚

#### å½±å“èŒƒå›´
- âœ… `services/user/Dockerfile`
- âœ… `services/activity/Dockerfile`
- âœ… `services/notification/Dockerfile`

#### å®‰å…¨é£é™©

**é£é™©ç­‰çº§**: HIGH

1. **ä¸­é—´äººæ”»å‡» (MITM)**
   - æ”»å‡»è€…å¯ä»¥æ‹¦æˆª pip å®‰è£…è¯·æ±‚
   - æ³¨å…¥æ¶æ„åŒ…æˆ–åé—¨ä»£ç 
   
2. **åŒ…å®Œæ•´æ€§æ— æ³•ä¿è¯**
   - æ— æ³•éªŒè¯ä¸‹è½½çš„åŒ…æ˜¯å¦è¢«ç¯¡æ”¹
   - å¯èƒ½å®‰è£…æŸåæˆ–æ¶æ„çš„ä¾èµ–

3. **ä¾›åº”é“¾æ”»å‡»**
   - å¦‚æœé•œåƒæºè¢«æ”»ç ´ï¼Œç›´æ¥å½±å“æ‰€æœ‰æ„å»º

#### åŸå§‹é…ç½®ï¼ˆæœ‰æ¼æ´ï¼‰

```dockerfile
# âŒ ä¸å®‰å…¨çš„é…ç½®
FROM python:3.11.5
WORKDIR /app
COPY . .
RUN pip install --no-cache-dir -r requirements.txt \
    -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple \
    --trusted-host mirrors.tuna.tsinghua.edu.cn
EXPOSE 8000
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "user_service.wsgi:application"]
```

#### ä¿®å¤åé…ç½®ï¼ˆå®‰å…¨ï¼‰

```dockerfile
# âœ… å®‰å…¨çš„é…ç½®
FROM python:3.11.5
WORKDIR /app
COPY . .
RUN pip install --no-cache-dir -r requirements.txt
EXPOSE 8000
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "user_service.wsgi:application"]
```

#### ä¿®å¤è¯´æ˜

1. **ç§»é™¤ `--trusted-host`**: æ¢å¤ SSL è¯ä¹¦éªŒè¯
2. **ç§»é™¤è‡ªå®šä¹‰é•œåƒæº**: ä½¿ç”¨å®˜æ–¹ PyPIï¼ˆæ›´å®‰å…¨ï¼‰
3. **å¦‚éœ€åŠ é€Ÿ**: 
   - ä½¿ç”¨ Docker æ„å»ºç¼“å­˜
   - ä½¿ç”¨ç§æœ‰ PyPI é•œåƒï¼ˆå¸¦æœ‰æ•ˆ SSL è¯ä¹¦ï¼‰
   - é…ç½® pip.conf ä½¿ç”¨å¯ä¿¡é•œåƒ

#### æœ€ä½³å®è·µ

```dockerfile
# å¦‚æœéœ€è¦ä½¿ç”¨é•œåƒæºï¼Œç¡®ä¿æœ‰æœ‰æ•ˆçš„ SSL è¯ä¹¦
FROM python:3.11.5
WORKDIR /app

# æ–¹æ¡ˆ1ï¼šä½¿ç”¨ pip.conf é…ç½®å¯ä¿¡é•œåƒ
COPY pip.conf /etc/pip.conf
COPY . .
RUN pip install --no-cache-dir -r requirements.txt

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
ENV PIP_INDEX_URL=https://pypi.org/simple
RUN pip install --no-cache-dir -r requirements.txt
```

---

## 4. Kubernetes é…ç½®é—®é¢˜ï¼ˆCheckovï¼‰

### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
- **é€šè¿‡æ£€æŸ¥**: 731 é¡¹
- **å¤±è´¥æ£€æŸ¥**: 130 é¡¹
- **ä¸»è¦é—®é¢˜**: ç¼ºå°‘å®‰å…¨ä¸Šä¸‹æ–‡ã€èµ„æºé™åˆ¶ã€æƒé™é…ç½®

### 4.1 å…³é”®å®‰å…¨é—®é¢˜åˆ†ç±»

#### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå®‰å…¨å…³é”®ï¼‰

##### CKV_K8S_23: å®¹å™¨ä»¥ root ç”¨æˆ·è¿è¡Œ
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å®¹å™¨é€ƒé€¸åå¯èƒ½è·å¾—ä¸»æœº root æƒé™
- **ä¿®å¤**:
```yaml
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
```

##### CKV_K8S_20: å…è®¸æƒé™æå‡
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: è¿›ç¨‹å¯ä»¥è·å¾—æ¯”çˆ¶è¿›ç¨‹æ›´é«˜çš„æƒé™
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    securityContext:
      allowPrivilegeEscalation: false
```

##### CKV_K8S_28: æœªé™åˆ¶ NET_RAW èƒ½åŠ›
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å®¹å™¨å¯ä»¥åˆ›å»ºåŸå§‹å¥—æ¥å­—ï¼Œè¿›è¡Œç½‘ç»œå—…æ¢
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    securityContext:
      capabilities:
        drop:
        - NET_RAW
        - ALL
```

##### CKV_K8S_30/29: æœªé…ç½®å®‰å…¨ä¸Šä¸‹æ–‡
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: ç¼ºå°‘åŸºæœ¬çš„å®‰å…¨éš”ç¦»æªæ–½
- **ä¿®å¤**:
```yaml
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  containers:
  - name: container
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      capabilities:
        drop:
        - ALL
```

##### CKV_K8S_31: æœªè®¾ç½® seccomp profile
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å®¹å™¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨
- **ä¿®å¤**:
```yaml
spec:
  securityContext:
    seccompProfile:
      type: RuntimeDefault
```

---

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

##### CKV_K8S_15: é•œåƒæ‹‰å–ç­–ç•¥é Always
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å¯èƒ½ä½¿ç”¨ç¼“å­˜çš„æ—§ç‰ˆæœ¬é•œåƒ
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    image: myimage:latest
    imagePullPolicy: Always
```

##### CKV_K8S_43: é•œåƒæœªä½¿ç”¨ digest
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: é•œåƒæ ‡ç­¾å¯èƒ½è¢«è¦†ç›–ï¼Œæ— æ³•ä¿è¯ä¸€è‡´æ€§
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    image: myimage@sha256:abcd1234...
```

##### CKV_K8S_38: è‡ªåŠ¨æŒ‚è½½æœåŠ¡è´¦å·ä»¤ç‰Œ
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: ä¸éœ€è¦è®¿é—® K8s API çš„ Pod ä¹Ÿè·å¾—äº†å‡­è¯
- **ä¿®å¤**:
```yaml
spec:
  automountServiceAccountToken: false
```

---

#### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

##### CKV_K8S_22: æœªä½¿ç”¨åªè¯»æ–‡ä»¶ç³»ç»Ÿ
- **å½±å“**: æ‰€æœ‰ Deployments
- **é£é™©**: å®¹å™¨å¯ä»¥ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿï¼Œå¢åŠ æ”»å‡»é¢
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    securityContext:
      readOnlyRootFilesystem: true
    volumeMounts:
    - name: tmp
      mountPath: /tmp
  volumes:
  - name: tmp
    emptyDir: {}
```

##### CKV_K8S_11/12/10: èµ„æºé™åˆ¶æœªå®Œæ•´é…ç½®
- **å½±å“**: éƒ¨åˆ† Deployments
- **é£é™©**: èµ„æºäº‰ç”¨ã€noisy neighbor é—®é¢˜
- **ä¿®å¤**:
```yaml
spec:
  containers:
  - name: container
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "1Gi"
        cpu: "1000m"
```

---

### 4.2 ç¤ºä¾‹ï¼šå®Œæ•´çš„å®‰å…¨ Deployment é…ç½®

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secure-app
  namespace: mywork
spec:
  replicas: 3
  selector:
    matchLabels:
      app: secure-app
  template:
    metadata:
      labels:
        app: secure-app
    spec:
      # Pod çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      
      # ç¦ç”¨è‡ªåŠ¨æŒ‚è½½æœåŠ¡è´¦å·ä»¤ç‰Œ
      automountServiceAccountToken: false
      
      containers:
      - name: app
        # ä½¿ç”¨ digest ç¡®ä¿é•œåƒä¸€è‡´æ€§
        image: myapp@sha256:abcd1234567890...
        imagePullPolicy: Always
        
        # å®¹å™¨çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
        
        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        
        # åªè¯»æ–‡ä»¶ç³»ç»Ÿéœ€è¦çš„ä¸´æ—¶ç›®å½•
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /app/cache
      
      volumes:
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}
```

---

## 5. å·²å®Œæˆçš„ä¿®å¤

### âœ… 5.1 Python ä¾èµ–åŒ…å‡çº§

#### Django å‡çº§
```diff
# services/user/requirements.txt
# services/activity/requirements.txt
# services/notification/requirements.txt

- Django==4.2.7
+ Django==4.2.24
```

**ä¿®å¤çš„æ¼æ´**:
- âœ… CVE-2024-42005 (CRITICAL) - SQL æ³¨å…¥
- âœ… CVE-2024-53908 (HIGH) - Oracle SQL æ³¨å…¥
- âœ… CVE-2025-57833 (HIGH) - FilteredRelation SQL æ³¨å…¥
- âœ… CVE-2024-24680 (HIGH) - DoS
- âœ… CVE-2024-38875 (HIGH) - DoS
- âœ… CVE-2024-39330 (HIGH)
- âœ… CVE-2025-59681 (HIGH)

**å½±å“**: ä¿®å¤ 7+ ä¸ª CRITICAL/HIGH çº§åˆ«æ¼æ´

---

#### Pillow å‡çº§
```diff
# services/user/requirements.txt
# services/activity/requirements.txt

- Pillow==10.1.0
+ Pillow==11.0.0
```

**ä¿®å¤çš„æ¼æ´**:
- âœ… CVE-2023-50447 (CRITICAL) - ä»»æ„ä»£ç æ‰§è¡Œ
- âœ… CVE-2024-28219 (å…¶ä»–å®‰å…¨é—®é¢˜)

**å½±å“**: ä¿®å¤ 2+ ä¸ª CRITICAL çº§åˆ«æ¼æ´

---

#### Gunicorn å‡çº§
```diff
# services/user/requirements.txt
# services/activity/requirements.txt
# services/notification/requirements.txt

- gunicorn==21.2.0
+ gunicorn==23.0.0
```

**ä¿®å¤çš„æ¼æ´**:
- âœ… CVE-2024-1135 (HIGH) - HTTP Request Smuggling
- âœ… CVE-2024-6827 (HIGH) - TE.CL æ”»å‡»

**å½±å“**: ä¿®å¤ 2 ä¸ª HIGH çº§åˆ«æ¼æ´

---

### âœ… 5.2 Dockerfile å®‰å…¨ä¿®å¤

#### ç§»é™¤ --trusted-host

**ä¿®å¤çš„æ–‡ä»¶**:
- âœ… `services/user/Dockerfile`
- âœ… `services/activity/Dockerfile`
- âœ… `services/notification/Dockerfile`

**ä¿®å¤è¯¦æƒ…**:
```diff
- RUN pip install --no-cache-dir -r requirements.txt \
-     -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple \
-     --trusted-host mirrors.tuna.tsinghua.edu.cn
+ RUN pip install --no-cache-dir -r requirements.txt
```

**å®‰å…¨æå‡**:
- âœ… æ¢å¤ SSL è¯ä¹¦éªŒè¯
- âœ… é˜²æ­¢ä¸­é—´äººæ”»å‡»
- âœ… ä½¿ç”¨å®˜æ–¹ PyPI æº
- âœ… ä¿è¯åŒ…çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§

---

#### æ·»åŠ é root ç”¨æˆ·å’Œå¥åº·æ£€æŸ¥

**ä¿®å¤çš„æ–‡ä»¶**:
- âœ… `services/user/Dockerfile`
- âœ… `services/activity/Dockerfile`
- âœ… `services/notification/Dockerfile`
- âœ… `frontend/Dockerfile`
- âœ… `frontend/Dockerfile.dev`

**ä¿®å¤è¯¦æƒ…**:

**åç«¯æœåŠ¡ Dockerfile**:
```dockerfile
# åˆ›å»ºé root ç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# æ›´æ”¹æ–‡ä»¶æ‰€æœ‰è€…
RUN chown -R appuser:appuser /app

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

# æ·»åŠ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health/')" || exit 1
```

**å‰ç«¯ Dockerfile**:
```dockerfile
# åˆ›å»ºé root ç”¨æˆ·ï¼ˆnode:18-alpineï¼‰
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# æ›´æ”¹æ–‡ä»¶æ‰€æœ‰è€…
RUN chown -R nodejs:nodejs /app

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nodejs

# æ·»åŠ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1
```

**ä¿®å¤çš„é—®é¢˜**:
- âœ… CKV_DOCKER_3: å®¹å™¨ä»¥é root ç”¨æˆ·è¿è¡Œ
- âœ… CKV_DOCKER_2: æ·»åŠ äº† HEALTHCHECK æŒ‡ä»¤

**å®‰å…¨æå‡**:
- âœ… é™ä½å®¹å™¨é€ƒé€¸é£é™©
- âœ… å³ä½¿å®¹å™¨è¢«æ”»ç ´ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•è·å¾— root æƒé™
- âœ… æä¾›å®¹å™¨å¥åº·çŠ¶æ€ç›‘æ§
- âœ… ç¬¦åˆ Docker å®‰å…¨æœ€ä½³å®è·µ

---

### âœ… 5.3 Kubernetes é…ç½®å®‰å…¨ä¿®å¤

#### æ·»åŠ å®‰å…¨ä¸Šä¸‹æ–‡å’Œèµ„æºé™åˆ¶

**ä¿®å¤çš„æ–‡ä»¶**:
- âœ… `k8s/microservices-deployments.yaml` (user-service, activity-service, notification-service)
- âœ… `k8s/frontend-deployment.yaml`
- âœ… `k8s/nginx-deployment.yaml`
- âœ… `k8s/postgres-deployment.yaml`

**ä¿®å¤è¯¦æƒ…**:

**Pod çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡**:
```yaml
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000  # æˆ– 999 (postgres), 101 (nginx)
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
  automountServiceAccountToken: false
```

**å®¹å™¨çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡**:
```yaml
containers:
- name: service
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false  # æ ¹æ®æœåŠ¡éœ€è¦è°ƒæ•´
    runAsNonRoot: true
    runAsUser: 1000
    capabilities:
      drop:
      - ALL
      add:  # ä»… PostgreSQL éœ€è¦é¢å¤–èƒ½åŠ›
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
```

**èµ„æºé™åˆ¶**:
```yaml
resources:
  requests:
    memory: "256Mi"
    cpu: "250m"
  limits:
    memory: "512Mi"
    cpu: "500m"
```

**é•œåƒæ‹‰å–ç­–ç•¥**:
```yaml
imagePullPolicy: Always  # ä» Never æ”¹ä¸º Always
```

**ä¿®å¤çš„é—®é¢˜**:
- âœ… CKV_K8S_23: å®¹å™¨ä¸å†ä»¥ root ç”¨æˆ·è¿è¡Œ
- âœ… CKV_K8S_20: ç¦æ­¢æƒé™æå‡
- âœ… CKV_K8S_30: åº”ç”¨å®‰å…¨ä¸Šä¸‹æ–‡
- âœ… CKV_K8S_31: é…ç½® seccomp profile
- âœ… CKV_K8S_29: Pod å’Œå®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡
- âœ… CKV_K8S_28: é™åˆ¶ NET_RAW èƒ½åŠ›
- âœ… CKV_K8S_38: ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡è´¦å·ä»¤ç‰ŒæŒ‚è½½
- âœ… CKV_K8S_15: é•œåƒæ‹‰å–ç­–ç•¥æ”¹ä¸º Always
- âœ… CKV_K8S_11/12/10/13: æ·»åŠ å®Œæ•´çš„èµ„æºé™åˆ¶
- âœ… CKV_K8S_22: ä¸ºå‰ç«¯æœåŠ¡é…ç½®åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆnginxï¼‰

**å®‰å…¨æå‡**:
- âœ… é™ä½å®¹å™¨é€ƒé€¸é£é™©
- âœ… é˜²æ­¢æƒé™æå‡æ”»å‡»
- âœ… é™åˆ¶å®¹å™¨èµ„æºä½¿ç”¨
- âœ… ç¡®ä¿ä½¿ç”¨æœ€æ–°é•œåƒ
- âœ… ç¬¦åˆ Kubernetes å®‰å…¨æœ€ä½³å®è·µ

---

### ğŸ“Š ä¿®å¤ç»Ÿè®¡

| ä¿®å¤ç±»å‹ | æ–‡ä»¶æ•° | æ¼æ´æ•° | ä¸¥é‡æ€§ |
|---------|-------|--------|--------|
| **Django å‡çº§** | 3 | 7+ | CRITICAL/HIGH |
| **Pillow å‡çº§** | 2 | 2+ | CRITICAL |
| **Gunicorn å‡çº§** | 3 | 2 | HIGH |
| **Dockerfile SSL** | 3 | 3 | HIGH |
| **Dockerfile é root ç”¨æˆ·** | 5 | 5 | HIGH |
| **Dockerfile HEALTHCHECK** | 5 | 5 | MEDIUM |
| **K8s å®‰å…¨ä¸Šä¸‹æ–‡** | 5 | ~50 | HIGH/MEDIUM |
| **K8s èµ„æºé™åˆ¶** | 5 | ~20 | MEDIUM |
| **æ€»è®¡** | **31** | **94+** | **CRITICAL/HIGH/MEDIUM** |

---

## 6. å¾…ä¿®å¤å»ºè®®

### ğŸ”´ 6.1 é«˜ä¼˜å…ˆçº§ï¼ˆåŸºç¡€é•œåƒæ¼æ´ï¼‰

#### æ›´æ–°åŸºç¡€é•œåƒä»¥ä¿®å¤ OS å±‚æ¼æ´

**é—®é¢˜æè¿°**:
Trivy æ‰«æå‘ç°å¤§é‡ CRITICAL/HIGH çº§åˆ«çš„ OS å±‚æ¼æ´ï¼Œä¸»è¦æ¥è‡ªåŸºç¡€é•œåƒï¼š
- `python:3.11.5` (Debian 12.1) - curl, glibc, openssl ç­‰æ¼æ´
- `nginx:alpine` - å„ç§ç³»ç»Ÿåº“æ¼æ´
- `node:18-alpine` - ç³»ç»Ÿåº“æ¼æ´

**å…³é”®æ¼æ´ç¤ºä¾‹**:
- CVE-2023-38545 (CRITICAL) - curl å †ç¼“å†²åŒºæº¢å‡º
- CVE-2023-38039 (HIGH) - curl æ¼æ´
- CVE-2024-2398 (HIGH) - å…¶ä»–ç³»ç»Ÿåº“æ¼æ´

**ä¿®å¤æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ1: å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ**
```dockerfile
# ä½¿ç”¨æ›´æ–°çš„åŸºç¡€é•œåƒ
FROM python:3.11.9  # æ›´æ–°åˆ°æœ€æ–° patch ç‰ˆæœ¬
# æˆ–
FROM python:3.12  # å‡çº§åˆ°æ–°ä¸»ç‰ˆæœ¬
```

**æ–¹æ¡ˆ2: ä½¿ç”¨ distroless é•œåƒ**ï¼ˆæ¨èï¼‰
```dockerfile
# ä½¿ç”¨ Google distroless é•œåƒï¼Œæœ€å°åŒ–æ”»å‡»é¢
FROM gcr.io/distroless/python3-debian12
```

**æ–¹æ¡ˆ3: åœ¨ Dockerfile ä¸­æ›´æ–°ç³»ç»ŸåŒ…**
```dockerfile
FROM python:3.11.5
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --only-upgrade curl openssl libssl3 && \
    rm -rf /var/lib/apt/lists/*
```

**é¢„è®¡ä¿®å¤æ¼æ´æ•°**: 100+ é¡¹
**é¢„è®¡å·¥ä½œé‡**: 2-3 å°æ—¶
**ä¼˜å…ˆçº§**: é«˜ï¼ˆä½†éœ€è¦æµ‹è¯•å…¼å®¹æ€§ï¼‰

---

### ğŸŸ¡ 6.2 ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### é•œåƒä½¿ç”¨ Digest

**é¢„è®¡ä¿®å¤æ¼æ´æ•°**: ~10 é¡¹

**çŠ¶æ€**: â³ å¾…ä¿®å¤

**ä¿®å¤æ–¹æ³•**:
```bash
# è·å–é•œåƒ digest
docker pull postgres:13
docker inspect postgres:13 | grep -A 5 "Digest"

# æ›´æ–° K8s é…ç½®
image: postgres@sha256:abcd1234...
```

**é¢„è®¡å·¥ä½œé‡**: 1-2 å°æ—¶

---

#### åªè¯»æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–

**é¢„è®¡ä¿®å¤æ¼æ´æ•°**: ~10 é¡¹

**çŠ¶æ€**: âš ï¸ éƒ¨åˆ†ä¿®å¤ï¼ˆå‰ç«¯å·²é…ç½®ï¼‰

**è¯´æ˜**:
- âœ… å‰ç«¯æœåŠ¡å·²é…ç½® `readOnlyRootFilesystem: true`
- â³ åç«¯æœåŠ¡ï¼ˆDjangoï¼‰éœ€è¦å†™å…¥æ—¥å¿—ï¼Œæš‚æ—¶ä¿æŒ `false`
- ğŸ’¡ å»ºè®®ï¼šå°†æ—¥å¿—è¾“å‡ºåˆ°æŒ‚è½½å·ï¼Œè€Œä¸æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿ

**ä¿®å¤æ–¹æ¡ˆ**:
```yaml
securityContext:
  readOnlyRootFilesystem: true

volumeMounts:
- name: logs
  mountPath: /app/logs
- name: tmp
  mountPath: /tmp

volumes:
- name: logs
  emptyDir: {}
- name: tmp
  emptyDir: {}
```

**é¢„è®¡å·¥ä½œé‡**: 2-3 å°æ—¶

---

### ğŸŸ¢ 6.3 ä½ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–é¡¹ï¼‰

#### ç½‘ç»œç­–ç•¥
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

#### Pod Security Policy / Pod Security Standards
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: mywork
  labels:
    pod-security.kubernetes.io/enforce: restricted
```

---

## 7. éªŒè¯æ­¥éª¤

### 7.1 é‡æ–°æ‰«æéªŒè¯

```bash
# é‡æ–°æ„å»ºé•œåƒ
docker compose build

# æ‰«ææ–°é•œåƒ
trivy image --severity CRITICAL,HIGH jsrgzyc/user-service:latest
trivy image --severity CRITICAL,HIGH jsrgzyc/activity-service:latest
trivy image --severity CRITICAL,HIGH jsrgzyc/notification-service:latest

# æ‰«æ Dockerfile
checkov -d . --framework dockerfile

# æ‰«æ K8s é…ç½®
checkov -d k8s --framework kubernetes
```

### 7.2 åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•åº”ç”¨å¯åŠ¨
docker compose up -d

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8001/api/v1/health/
curl http://localhost:8002/api/v1/health/
curl http://localhost:8003/api/v1/health/

# è¿è¡Œé›†æˆæµ‹è¯•
npm test --prefix frontend
pytest services/user
pytest services/activity
pytest services/notification
```

### 7.3 æ€§èƒ½æµ‹è¯•

```bash
# éªŒè¯å‡çº§åæ€§èƒ½æœªä¸‹é™
k6 run tests/perf/k6-load.js
```

---

## 8. å‚è€ƒèµ„æ–™

### æ¼æ´æ•°æ®åº“
- [NIST NVD](https://nvd.nist.gov/)
- [GitHub Advisory Database](https://github.com/advisories)
- [PyPI Advisory Database](https://github.com/pypa/advisory-database)

### Django å®‰å…¨å…¬å‘Š
- [Django Security Releases](https://www.djangoproject.com/weblog/2024/aug/06/security-releases/)
- [Django 4.2 Release Notes](https://docs.djangoproject.com/en/4.2/releases/)

### Kubernetes å®‰å…¨
- [Kubernetes Security Best Practices](https://kubernetes.io/docs/concepts/security/)
- [Pod Security Standards](https://kubernetes.io/docs/concepts/security/pod-security-standards/)
- [CIS Kubernetes Benchmark](https://www.cisecurity.org/benchmark/kubernetes)

### å·¥å…·æ–‡æ¡£
- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Checkov Documentation](https://www.checkov.io/1.Welcome/What%20is%20Checkov.html)

---

## 9. æ€»ç»“

### âœ… å·²ä¿®å¤
- **14+ ä¸ª CRITICAL/HIGH åº”ç”¨å±‚æ¼æ´**å·²ä¿®å¤
- **3 ä¸ª Dockerfile SSL é—®é¢˜**å·²è§£å†³
- **æ‰€æœ‰ Python ä¾èµ–**å·²å‡çº§åˆ°å®‰å…¨ç‰ˆæœ¬
- **5 ä¸ª Dockerfile é root ç”¨æˆ·é—®é¢˜**å·²ä¿®å¤
- **5 ä¸ª Dockerfile HEALTHCHECK é—®é¢˜**å·²ä¿®å¤
- **~50 ä¸ª K8s å®‰å…¨ä¸Šä¸‹æ–‡é—®é¢˜**å·²ä¿®å¤
- **~20 ä¸ª K8s èµ„æºé™åˆ¶é—®é¢˜**å·²ä¿®å¤

### â³ å¾…å¤„ç†
- **100+ ä¸ªåŸºç¡€é•œåƒ OS å±‚æ¼æ´**éœ€è¦æ›´æ–°åŸºç¡€é•œåƒ
- **~10 ä¸ªé•œåƒ digest é—®é¢˜**å»ºè®®ä¿®å¤
- **~10 ä¸ªåªè¯»æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–**ï¼ˆåç«¯æœåŠ¡éœ€è¦è°ƒæ•´æ¶æ„ï¼‰

### ğŸ“ˆ å®‰å…¨æå‡
- Django SQL æ³¨å…¥é£é™©ï¼šâœ… **å·²æ¶ˆé™¤**
- Pillow ä»£ç æ‰§è¡Œé£é™©ï¼šâœ… **å·²æ¶ˆé™¤**
- Gunicorn è¯·æ±‚èµ°ç§ï¼šâœ… **å·²æ¶ˆé™¤**
- Dockerfile SSL éªŒè¯ï¼šâœ… **å·²æ¢å¤**
- Dockerfile é root ç”¨æˆ·ï¼šâœ… **å·²é…ç½®**
- Dockerfile å¥åº·æ£€æŸ¥ï¼šâœ… **å·²æ·»åŠ **
- K8s å®‰å…¨ä¸Šä¸‹æ–‡ï¼šâœ… **å·²é…ç½®**
- K8s èµ„æºé™åˆ¶ï¼šâœ… **å·²é…ç½®**
- K8s æƒé™æå‡é˜²æŠ¤ï¼šâœ… **å·²é…ç½®**
- åŸºç¡€é•œåƒ OS æ¼æ´ï¼šâ³ **å¾…æ›´æ–°åŸºç¡€é•œåƒ**

### ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. **ç«‹å³**: éƒ¨ç½²å·²ä¿®å¤çš„ä¾èµ–åŒ…å’Œé…ç½®
2. **æœ¬å‘¨**: æ›´æ–°åŸºç¡€é•œåƒä»¥ä¿®å¤ OS å±‚æ¼æ´
3. **æœ¬æœˆ**: ä¼˜åŒ–åªè¯»æ–‡ä»¶ç³»ç»Ÿé…ç½®ï¼Œä½¿ç”¨é•œåƒ digest
4. **æŒç»­**: å»ºç«‹å®šæœŸå®‰å…¨æ‰«æå’ŒåŸºç¡€é•œåƒæ›´æ–°æµç¨‹

### ğŸ“ æœ€æ–°ä¿®å¤æ‘˜è¦ï¼ˆ2025-11-05 æ›´æ–°ï¼‰

**æœ¬æ¬¡ä¿®å¤å†…å®¹**:
1. âœ… **Dockerfile å®‰å…¨åŠ å›º**:
   - æ‰€æœ‰æœåŠ¡æ·»åŠ é root ç”¨æˆ·
   - æ‰€æœ‰æœåŠ¡æ·»åŠ  HEALTHCHECK
   - ä¿®å¤äº† 10 ä¸ª Checkov æ£€æŸ¥é¡¹

2. âœ… **Kubernetes é…ç½®å®‰å…¨åŠ å›º**:
   - æ‰€æœ‰ Deployment æ·»åŠ  Pod çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡
   - æ‰€æœ‰å®¹å™¨æ·»åŠ å®¹å™¨çº§åˆ«å®‰å…¨ä¸Šä¸‹æ–‡
   - æ‰€æœ‰æœåŠ¡é…ç½®èµ„æºé™åˆ¶
   - é•œåƒæ‹‰å–ç­–ç•¥æ”¹ä¸º Always
   - ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡è´¦å·ä»¤ç‰ŒæŒ‚è½½
   - ä¿®å¤äº†çº¦ 70 ä¸ª Checkov æ£€æŸ¥é¡¹

**å‰©ä½™å·¥ä½œ**:
- åŸºç¡€é•œåƒ OS å±‚æ¼æ´éœ€è¦æ›´æ–°åŸºç¡€é•œåƒç‰ˆæœ¬
- å»ºè®®ä½¿ç”¨é•œåƒ digest æ›¿ä»£æ ‡ç­¾
- åç«¯æœåŠ¡å¯ä¼˜åŒ–ä¸ºåªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆéœ€è¦æ—¥å¿—å·æŒ‚è½½ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-05  
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0  
**è´Ÿè´£äºº**: AI Security Analyst

