name: ðŸš€ Continuous Deployment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

jobs:
  # å‡†å¤‡å’Œæž„å»ºé•œåƒ
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build and prepare images
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            echo "ðŸš€ å¼€å§‹éƒ¨ç½² Volunteer Platform..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /home/Volunteer-website
            
            # æ›´æ–°ä»£ç 
            echo "ðŸ“¥ æ›´æ–°ä»£ç ..."
            git pull
            
            # æž„å»ºé•œåƒ
            echo "ðŸ”¨ æž„å»ºé•œåƒ..."
            docker compose build --no-cache
            
            # æ£€æŸ¥çŽ°æœ‰é•œåƒ
            echo "ðŸ“‹ æ£€æŸ¥çŽ°æœ‰é•œåƒ..."
            docker images | grep jsrgzyc || echo "âš ï¸  æœªæ‰¾åˆ°é•œåƒ"
            
            # éªŒè¯æ‰€æœ‰å¿…éœ€é•œåƒéƒ½å·²æž„å»º
            echo "ðŸ” éªŒè¯é•œåƒæž„å»ºçŠ¶æ€..."
            required_images=(
              "jsrgzyc/user-service:latest"
              "jsrgzyc/activity-service:latest"
              "jsrgzyc/notification-service:latest"
              "jsrgzyc/frontend:latest"
            )
            
            all_built=true
            for image in "${required_images[@]}"; do
              if docker image inspect "$image" >/dev/null 2>&1; then
                echo "âœ… $image å·²æž„å»º"
              else
                echo "âŒ $image æœªæž„å»º"
                all_built=false
              fi
            done
            
            if [ "$all_built" = false ]; then
              echo "âš ï¸  éƒ¨åˆ†é•œåƒæœªæž„å»ºï¼Œå°†åœ¨å¯¼å…¥é˜¶æ®µå°è¯•é‡æ–°æž„å»º"
            fi
            
            echo "âœ… é•œåƒæž„å»ºé˜¶æ®µå®Œæˆ"

  # å¯¼å…¥é•œåƒåˆ° containerd
  import:
    runs-on: ubuntu-22.04
    needs: [build]
    steps:
      - name: Import images to containerd
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            echo "ðŸ“¦ å¯¼å…¥é•œåƒåˆ° containerd..."
            
            required_images=(
              "jsrgzyc/user-service:latest"
              "jsrgzyc/activity-service:latest"
              "jsrgzyc/notification-service:latest"
              "jsrgzyc/frontend:latest"
            )
            
            # é•œåƒååˆ°æœåŠ¡åçš„æ˜ å°„
            declare -A image_to_service=(
              ["jsrgzyc/user-service:latest"]="user-service"
              ["jsrgzyc/activity-service:latest"]="activity-service"
              ["jsrgzyc/notification-service:latest"]="notification-service"
              ["jsrgzyc/frontend:latest"]="frontend-service"
            )
            
            # è®°å½•å¯¼å…¥æˆåŠŸçš„é•œåƒ
            imported_images=()
            
            for image in "${required_images[@]}"; do
              image_name=$(echo $image | cut -d'/' -f2 | cut -d':' -f1)
              service_name="${image_to_service[$image]}"
              echo "å¯¼å…¥ $image_name (æœåŠ¡: $service_name)..."
              
              # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨ï¼ˆä½¿ç”¨ docker image inspect æ›´å¯é ï¼‰
              if docker image inspect "$image" >/dev/null 2>&1; then
                echo "ðŸ“¦ æ‰¾åˆ°é•œåƒ $imageï¼Œå¼€å§‹å¯¼å…¥..."
                if docker save "$image" | ctr -n k8s.io images import - 2>&1; then
                  echo "âœ… $image_name å¯¼å…¥æˆåŠŸ"
                  imported_images+=("$image")
                else
                  echo "âš ï¸  $image_name å¯¼å…¥å¯èƒ½å¤±è´¥ï¼Œå°†åœ¨éªŒè¯é˜¶æ®µæ£€æŸ¥"
                fi
              else
                echo "âŒ $image é•œåƒä¸å­˜åœ¨"
                echo "ðŸ” æ£€æŸ¥ Docker é•œåƒåˆ—è¡¨..."
                docker images | grep jsrgzyc || echo "æœªæ‰¾åˆ°ä»»ä½• jsrgzyc é•œåƒ"
                echo "ðŸ” å°è¯•é‡æ–°æž„å»ºé•œåƒ (æœåŠ¡: $service_name)..."
                if [ -n "$service_name" ]; then
                  docker compose build "$service_name" || echo "æž„å»ºå¤±è´¥"
                else
                  echo "âš ï¸  æ— æ³•ç¡®å®šæœåŠ¡åï¼Œå°è¯•æž„å»ºæ‰€æœ‰é•œåƒ..."
                  docker compose build || echo "æž„å»ºå¤±è´¥"
                fi
                # å†æ¬¡æ£€æŸ¥
                if docker image inspect "$image" >/dev/null 2>&1; then
                  echo "âœ… é•œåƒæž„å»ºæˆåŠŸï¼Œå¼€å§‹å¯¼å…¥..."
                  if docker save "$image" | ctr -n k8s.io images import - 2>&1; then
                    echo "âœ… $image_name å¯¼å…¥æˆåŠŸ"
                    imported_images+=("$image")
                  else
                    echo "âš ï¸  $image_name å¯¼å…¥å¯èƒ½å¤±è´¥ï¼Œå°†åœ¨éªŒè¯é˜¶æ®µæ£€æŸ¥"
                  fi
                else
                  echo "âŒ é•œåƒ $image ä»ç„¶ä¸å­˜åœ¨ï¼Œéƒ¨ç½²å¤±è´¥"
                  exit 1
                fi
              fi
            done
            
            echo ""
            echo "ðŸ“Š å¯¼å…¥æ‘˜è¦ï¼š"
            echo "  å·²å¯¼å…¥ ${#imported_images[@]}/${#required_images[@]} ä¸ªé•œåƒ"
            
            # éªŒè¯é•œåƒå¯¼å…¥
            echo ""
            echo "ðŸ” éªŒè¯é•œåƒå¯¼å…¥çŠ¶æ€..."
            
            # å…ˆæ˜¾ç¤ºæ‰€æœ‰å·²å¯¼å…¥çš„é•œåƒï¼Œä¾¿äºŽè°ƒè¯•
            echo "ðŸ“‹ containerd ä¸­çš„å®Œæ•´é•œåƒåˆ—è¡¨ï¼š"
            ctr -n k8s.io images list 2>/dev/null || ctr -n k8s.io images ls 2>/dev/null || echo "æ— æ³•èŽ·å–é•œåƒåˆ—è¡¨"
            echo ""
            echo "ðŸ“‹ è¿‡æ»¤åŽçš„ jsrgzyc é•œåƒï¼š"
            ctr -n k8s.io images list 2>/dev/null | grep jsrgzyc || ctr -n k8s.io images ls 2>/dev/null | grep jsrgzyc || echo "æœªæ‰¾åˆ° jsrgzyc é•œåƒ"
            
            max_attempts=10
            attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo ""
              echo "æ£€æŸ¥é•œåƒå¯¼å…¥çŠ¶æ€ (å°è¯• $attempt/$max_attempts)..."
              all_imported=true
              missing_images=()
              
              # èŽ·å–é•œåƒåˆ—è¡¨ä¸€æ¬¡ï¼Œé¿å…é‡å¤è°ƒç”¨
              image_list_full=$(ctr -n k8s.io images list 2>/dev/null || ctr -n k8s.io images ls 2>/dev/null || echo "")
              
              for image in "${required_images[@]}"; do
                found=false
                image_repo=$(echo "$image" | cut -d':' -f1)
                image_name_only=$(echo "$image_repo" | cut -d'/' -f2)
                
                # è°ƒè¯•ï¼šæ˜¾ç¤ºæ£€æŸ¥çš„é•œåƒä¿¡æ¯
                echo "  æ£€æŸ¥é•œåƒ: $image (ä»“åº“: $image_repo, åç§°: $image_name_only)"
                
                # æ–¹æ³•1: ç²¾ç¡®åŒ¹é…å®Œæ•´é•œåƒå
                if echo "$image_list_full" | grep -qF "$image"; then
                  found=true
                  echo "    â†’ é€šè¿‡æ–¹æ³•1åŒ¹é…ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰"
                # æ–¹æ³•2: åŒ¹é…ä»“åº“åå’Œæ ‡ç­¾ï¼ˆå¯èƒ½æ ¼å¼ä¸åŒï¼Œåœ¨ä¸åŒè¡Œï¼‰
                elif echo "$image_list_full" | grep -q "$image_repo" && echo "$image_list_full" | grep -q "latest"; then
                  # è¿›ä¸€æ­¥éªŒè¯ï¼šç¡®ä¿ä»“åº“åå’Œlateståœ¨åŒä¸€è¡Œï¼ˆåŒä¸€ä¸ªé•œåƒï¼‰
                  if echo "$image_list_full" | grep "$image_repo" | grep -q "latest"; then
                    found=true
                    echo "    â†’ é€šè¿‡æ–¹æ³•2åŒ¹é…ï¼ˆä»“åº“+æ ‡ç­¾ï¼ŒåŒä¸€è¡Œï¼‰"
                  fi
                # æ–¹æ³•3: åŒ¹é…åŒ…å«ä»“åº“åçš„è¡Œï¼Œä¸”åŒ…å«latestæ ‡ç­¾
                elif echo "$image_list_full" | grep "$image_repo" | grep -q "latest"; then
                  found=true
                  echo "    â†’ é€šè¿‡æ–¹æ³•3åŒ¹é…ï¼ˆä»“åº“è¡ŒåŒ…å«latestï¼‰"
                # æ–¹æ³•4: ä½¿ç”¨æ¨¡å¼åŒ¹é…ï¼ˆä»“åº“å/åç§°:æ ‡ç­¾ï¼‰
                elif echo "$image_list_full" | grep -E "$image_repo.*latest|$image_repo.*:latest" | grep -q "$image_name_only"; then
                  found=true
                  echo "    â†’ é€šè¿‡æ–¹æ³•4åŒ¹é…ï¼ˆæ¨¡å¼åŒ¹é…ï¼‰"
                # æ–¹æ³•5: ä½¿ç”¨ ctr images check å‘½ä»¤ç›´æŽ¥æ£€æŸ¥
                elif ctr -n k8s.io images check "$image" >/dev/null 2>&1; then
                  found=true
                  echo "    â†’ é€šè¿‡æ–¹æ³•5åŒ¹é…ï¼ˆctr checkï¼‰"
                else
                  echo "    â†’ æ‰€æœ‰åŒ¹é…æ–¹æ³•éƒ½å¤±è´¥"
                  # æ˜¾ç¤ºå®žé™…çš„åŒ¹é…å°è¯•å’Œè°ƒè¯•ä¿¡æ¯
                  echo "    è°ƒè¯•ä¿¡æ¯ï¼š"
                  echo "      æŸ¥æ‰¾é•œåƒ: $image"
                  echo "      ä»“åº“å: $image_repo"
                  echo "      é•œåƒå: $image_name_only"
                  echo "    ç›¸å…³è¡Œï¼š"
                  echo "$image_list_full" | grep -i "$image_name_only" | head -5 || echo "      æœªæ‰¾åˆ°åŒ…å« '$image_name_only' çš„è¡Œ"
                  echo "    åŒ…å«ä»“åº“åçš„è¡Œï¼š"
                  echo "$image_list_full" | grep "$image_repo" | head -3 || echo "      æœªæ‰¾åˆ°åŒ…å« '$image_repo' çš„è¡Œ"
                fi
                
                if [ "$found" = true ]; then
                  echo "âœ… $image å·²å¯¼å…¥"
                else
                  echo "â³ $image å°šæœªå¯¼å…¥ï¼Œç­‰å¾…ä¸­..."
                  all_imported=false
                  missing_images+=("$image")
                fi
              done
              
              if [ "$all_imported" = true ]; then
                echo ""
                echo "âœ… æ‰€æœ‰é•œåƒå¯¼å…¥å®Œæˆï¼"
                # å†æ¬¡ç¡®è®¤æ˜¾ç¤ºæ‰€æœ‰é•œåƒ
                echo "ðŸ“‹ æœ€ç»ˆé•œåƒåˆ—è¡¨ï¼š"
                ctr -n k8s.io images list 2>/dev/null | grep jsrgzyc || ctr -n k8s.io images ls 2>/dev/null | grep jsrgzyc || echo "æœªæ‰¾åˆ° jsrgzyc é•œåƒ"
                exit 0
              fi
              
              if [ $attempt -eq $max_attempts ]; then
                echo ""
                echo "âš ï¸  é•œåƒéªŒè¯è¶…æ—¶"
                echo "ðŸ“‹ containerd ä¸­çš„å®žé™…é•œåƒåˆ—è¡¨ï¼š"
                ctr -n k8s.io images list 2>/dev/null | grep jsrgzyc || ctr -n k8s.io images ls 2>/dev/null | grep jsrgzyc || echo "æœªæ‰¾åˆ° jsrgzyc é•œåƒ"
                echo ""
                echo "â³ ä»¥ä¸‹é•œåƒåœ¨éªŒè¯æ—¶æœªæ‰¾åˆ°ï¼Œä½†å¯èƒ½å·²æˆåŠŸå¯¼å…¥ï¼ˆå¯¼å…¥å‘½ä»¤å·²æ˜¾ç¤ºæˆåŠŸï¼‰ï¼š"
                for image in "${missing_images[@]}"; do
                  echo "  - $image"
                done
                echo ""
                echo "ðŸ’¡ å¦‚æžœå¯¼å…¥å‘½ä»¤å·²æ˜¾ç¤ºæˆåŠŸï¼Œé•œåƒåº”è¯¥å·²å¯ç”¨ï¼Œç»§ç»­éƒ¨ç½²..."
                # ä¸é€€å‡ºï¼Œç»§ç»­éƒ¨ç½²æµç¨‹
                break
              fi
              
              echo "ç­‰å¾…3ç§’åŽé‡è¯•..."
              sleep 3
              attempt=$((attempt + 1))
            done

  # éƒ¨ç½²åŸºç¡€è®¾æ–½
  deploy-infrastructure:
    runs-on: ubuntu-22.04
    needs: [import]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy infrastructure
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            # æ£€æŸ¥ kubectl
            echo "ðŸ” æ£€æŸ¥ kubectl..."
            if ! command -v kubectl &> /dev/null; then
              echo "âŒ kubectl æœªå®‰è£…"
              exit 1
            fi
            
            # æ£€æŸ¥é›†ç¾¤è¿žæŽ¥
            echo "ðŸ”— æ£€æŸ¥ Kubernetes é›†ç¾¤è¿žæŽ¥..."
            if ! kubectl cluster-info >/dev/null 2>&1; then
              echo "âŒ æ— æ³•è¿žæŽ¥åˆ° Kubernetes é›†ç¾¤"
              exit 1
            fi
            
            # åˆ›å»ºå‘½åç©ºé—´
            echo "ðŸ“¦ åˆ›å»ºå‘½åç©ºé—´..."
            kubectl apply -f k8s/namespace.yaml
            
            # åˆ›å»ºé…ç½®
            echo "âš™ï¸  åˆ›å»ºé…ç½®..."
            kubectl apply -f k8s/configmap.yaml
            
            # éƒ¨ç½²æ•°æ®åº“
            echo "ðŸ—„ï¸  éƒ¨ç½²æ•°æ®åº“..."
            kubectl apply -f k8s/postgres-deployment.yaml
            
            # ç­‰å¾…æ•°æ®åº“å°±ç»ª
            echo "â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
            kubectl wait --for=condition=available --timeout=300s deployment/postgres -n mywork || true
            
            echo "âœ… åŸºç¡€è®¾æ–½éƒ¨ç½²å®Œæˆ"

  # éƒ¨ç½²åº”ç”¨æœåŠ¡
  deploy-services:
    runs-on: ubuntu-22.04
    needs: [deploy-infrastructure]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy microservices and frontend
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            # éƒ¨ç½²å¾®æœåŠ¡
            echo "ðŸ”§ éƒ¨ç½²å¾®æœåŠ¡..."
            kubectl apply -f k8s/microservices-deployments.yaml
            kubectl apply -f k8s/microservices-services.yaml
            
            # éƒ¨ç½²å‰ç«¯
            echo "ðŸ”§ éƒ¨ç½²å‰ç«¯..."
            kubectl apply -f k8s/frontend-deployment.yaml
            
            # ç­‰å¾…æœåŠ¡å°±ç»ª
            echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
            deployments=(
              "user-service"
              "activity-service"
              "notification-service"
              "frontend-service"
            )
            
            for deployment in "${deployments[@]}"; do
              echo "ç­‰å¾… $deployment..."
              kubectl wait --for=condition=available --timeout=300s deployment/$deployment -n mywork || true
            done
            
            echo "âœ… åº”ç”¨æœåŠ¡éƒ¨ç½²å®Œæˆ"

  # éƒ¨ç½²ç½‘å…³
  deploy-gateway:
    runs-on: ubuntu-22.04
    needs: [deploy-services]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy gateway and ingress
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            # éƒ¨ç½² nginx ç½‘å…³
            echo "ðŸŒ éƒ¨ç½² nginx ç½‘å…³..."
            kubectl apply -f k8s/nginx-deployment.yaml
            
            # ç­‰å¾…ç½‘å…³å°±ç»ª
            echo "â³ ç­‰å¾…ç½‘å…³å°±ç»ª..."
            kubectl wait --for=condition=available --timeout=300s deployment/nginx-gateway -n mywork || true
            
            # éƒ¨ç½² Ingress
            echo "ðŸšª éƒ¨ç½² Ingress..."
            kubectl apply -f k8s/ingress-nginx-controller.yaml
            kubectl apply -f k8s/ingress.yaml
            
            echo "âœ… ç½‘å…³éƒ¨ç½²å®Œæˆ"

  # éªŒè¯éƒ¨ç½²
  verify:
    runs-on: ubuntu-22.04
    needs: [deploy-gateway]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify deployment
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.aliCloud }}
          script: |
            cd /home/Volunteer-website
            
            echo "ðŸ“Š éªŒè¯éƒ¨ç½²çŠ¶æ€..."
            
            echo "=== Pods ==="
            kubectl get pods -n mywork
            
            echo "=== Services ==="
            kubectl get services -n mywork
            
            echo "=== Ingress ==="
            kubectl get ingress -n mywork
            
            echo "=== Deployments ==="
            kubectl get deployments -n mywork
            
            # èŽ·å–è®¿é—®ä¿¡æ¯
            echo "ðŸ”— èŽ·å–è®¿é—®ä¿¡æ¯..."
            kubectl get ingress -n mywork -o wide
            
            echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆï¼"
      
      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### éƒ¨ç½²é˜¶æ®µ" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºé•œåƒ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯¼å…¥é•œåƒ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²åŸºç¡€è®¾æ–½ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²åº”ç”¨æœåŠ¡ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²ç½‘å…³ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "| éªŒè¯éƒ¨ç½² | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å·²éƒ¨ç½²æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ç”¨æˆ·æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ´»åŠ¨æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é€šçŸ¥æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å‰ç«¯æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PostgreSQL æ•°æ®åº“" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Nginx ç½‘å…³" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ingress æŽ§åˆ¶å™¨" >> $GITHUB_STEP_SUMMARY

